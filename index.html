<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CJ Emporium - CRM Kanban</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0F0F0F;
            color: #F5F3EF;
            font-weight: 400;
            letter-spacing: -0.01em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: relative;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }
        
        html {
            overflow-x: hidden;
            width: 100%;
        }

        /* Tema Claro */
        body.theme-light {
            background: #F5F5F5;
            color: #1A1A1A;
        }

        body.theme-light .card {
            background: #FFFFFF;
            border-color: rgba(0, 0, 0, 0.1);
            color: #1A1A1A;
        }

        body.theme-light .sidebar {
            background: #FFFFFF;
            border-right-color: rgba(0, 0, 0, 0.1);
        }

        body.theme-light .sidebar-overlay {
            background: rgba(0, 0, 0, 0.5);
        }

        body.theme-light .mobile-menu-toggle {
            background: rgba(212, 175, 55, 0.1);
            border-color: rgba(212, 175, 55, 0.2);
        }

        body.theme-light .nav-item {
            color: #4A4A4A;
        }

        body.theme-light .nav-item:hover,
        body.theme-light .nav-item.active {
            background: rgba(212, 175, 55, 0.1);
            color: #D4AF37;
        }

        body.theme-light .btn-primary {
            background: #D4AF37;
            color: #1A1A1A;
        }

        body.theme-light .btn-secondary {
            background: #E5E5E5;
            color: #1A1A1A;
        }

        body.theme-light input,
        body.theme-light select,
        body.theme-light textarea {
            background: #F5F5F5;
            border-color: rgba(0, 0, 0, 0.2);
            color: #1A1A1A;
        }

        body.theme-light input::placeholder,
        body.theme-light textarea::placeholder {
            color: rgba(26, 26, 26, 0.5);
        }

        body.theme-light input:focus,
        body.theme-light select:focus,
        body.theme-light textarea:focus {
            background: #FFFFFF;
            border-color: #D4AF37;
            color: #1A1A1A;
        }

        /* Títulos no tema claro */
        body.theme-light h1,
        body.theme-light h2,
        body.theme-light h3,
        body.theme-light .page-header h1 {
            color: #1A1A1A;
        }

        body.theme-light .page-header {
            color: #1A1A1A;
        }

        /* Cards de estatísticas */
        body.theme-light .stat-card {
            background: #FFFFFF;
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.theme-light .stat-value {
            color: #1A1A1A;
        }

        body.theme-light .stat-label {
            color: rgba(26, 26, 26, 0.7);
        }

        /* Tabelas */
        body.theme-light .data-table {
            color: #1A1A1A;
        }

        body.theme-light .data-table thead {
            background: #F5F5F5;
        }

        body.theme-light .data-table th {
            color: #1A1A1A;
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }

        body.theme-light .data-table td {
            color: #1A1A1A;
            border-bottom-color: rgba(0, 0, 0, 0.05);
        }

        body.theme-light .data-table tbody tr:hover {
            background: rgba(212, 175, 55, 0.05);
        }

        /* Kanban */
        body.theme-light .kanban-column {
            background: #FFFFFF;
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.theme-light .kanban-card {
            background: #F5F5F5;
            border-color: rgba(0, 0, 0, 0.1);
            color: #1A1A1A;
        }

        body.theme-light .kanban-card h3 {
            color: #1A1A1A;
        }

        body.theme-light .kanban-card p {
            color: rgba(26, 26, 26, 0.7);
        }

        /* Status badges */
        body.theme-light .status-badge {
            color: #1A1A1A;
        }

        /* Product cards */
        body.theme-light .product-card {
            background: #FFFFFF;
            border-color: rgba(0, 0, 0, 0.1);
            color: #1A1A1A;
        }

        body.theme-light .product-card h3 {
            color: #1A1A1A;
        }

        body.theme-light .product-info {
            color: #1A1A1A;
        }

        /* Modal */
        body.theme-light .modal-content {
            background: #FFFFFF;
            color: #1A1A1A;
        }

        body.theme-light .modal-header h2 {
            color: #1A1A1A;
        }

        /* Settings */
        body.theme-light .settings-menu-item {
            color: rgba(26, 26, 26, 0.7);
        }

        body.theme-light .settings-menu-item:hover {
            background: rgba(212, 175, 55, 0.1);
            color: #D4AF37;
        }

        body.theme-light .settings-menu-item.active {
            background: rgba(212, 175, 55, 0.2);
            color: #D4AF37;
        }

        body.theme-light .settings-section .form-group label {
            color: #1A1A1A;
        }

        body.theme-light .settings-section .form-group small {
            color: rgba(26, 26, 26, 0.6);
        }

        /* Empty state */
        body.theme-light .empty-state {
            color: rgba(26, 26, 26, 0.5);
        }

        /* Links e textos secundários */
        body.theme-light p,
        body.theme-light span,
        body.theme-light div {
            color: inherit;
        }

        body.theme-light .user-name,
        body.theme-light .user-role {
            color: rgba(26, 26, 26, 0.7);
        }

        /* Densidade Compacta */
        body.density-compact .card {
            padding: 1rem;
        }

        body.density-compact .form-group {
            margin-bottom: 1rem;
        }

        body.density-compact .btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        body.density-compact .page-header {
            padding: 1rem 0;
        }

        /* Densidade Espaçosa */
        body.density-spacious .card {
            padding: 2.5rem;
        }

        body.density-spacious .form-group {
            margin-bottom: 2rem;
        }

        body.density-spacious .btn {
            padding: 1rem 2rem;
            font-size: 1rem;
        }

        body.density-spacious .page-header {
            padding: 2rem 0;
        }

        /* Animações */
        body.no-animations *,
        body.no-animations *::before,
        body.no-animations *::after {
            animation: none !important;
            transition: none !important;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://zpqtcrfygjtjtacufgbv.supabase.co/storage/v1/object/public/logos/Design%20sem%20nome%20(12).png');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: cover;
            opacity: 0.03;
            z-index: 0;
            pointer-events: none;
        }

        /* Imagem de fundo apenas no tema escuro */
        body.theme-light::before {
            display: none;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* Login */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0F0F0F 0%, #2B2B2B 100%);
        }

        .login-box {
            background: #2B2B2B;
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 0 1px rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.2);
            width: 100%;
            max-width: 440px;
            backdrop-filter: blur(10px);
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header img {
            max-width: 200px;
            height: auto;
            margin-bottom: 1.5rem;
            filter: drop-shadow(0 4px 20px rgba(212, 175, 55, 0.3));
        }

        .login-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.25rem;
            font-weight: 700;
            color: #D4AF37;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .form-group {
            margin-bottom: 1.75rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.625rem;
            font-weight: 500;
            font-size: 0.875rem;
            color: #B88A44;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid rgba(184, 138, 68, 0.3);
            border-radius: 8px;
            font-size: 0.9375rem;
            background: #0F0F0F;
            color: #F5F3EF;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        
        select.form-group {
            width: auto;
            display: inline-block;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #D4AF37;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.15), 0 4px 12px rgba(0,0,0,0.3);
            background: #1A1A1A;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(245, 243, 239, 0.4);
        }

        .btn {
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.625rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.01em;
            position: relative;
            overflow: hidden;
            z-index: 10;
            pointer-events: auto;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-primary {
            background: linear-gradient(135deg, #D4AF37 0%, #B88A44 100%);
            color: #0F0F0F;
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
            background: linear-gradient(135deg, #E5C04A 0%, #C99A55 100%);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: transparent;
            color: #F5F3EF;
            border: 1px solid rgba(184, 138, 68, 0.4);
        }

        .btn-secondary:hover {
            background: rgba(184, 138, 68, 0.1);
            border-color: #B88A44;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: none;
        }

        /* App */
        #app-screen {
            display: flex;
            min-height: 100vh;
            position: relative;
            width: 100%;
        }

        .sidebar {
            width: 280px;
            background: #1A1A1A;
            box-shadow: 4px 0 24px rgba(0,0,0,0.6);
            border-right: 1px solid rgba(212, 175, 55, 0.1);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
            pointer-events: auto;
        }

        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: rgba(212, 175, 55, 0.15);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: #D4AF37;
            width: 48px;
            height: 48px;
            border-radius: 8px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.3s ease;
        }

        .mobile-menu-toggle:hover {
            background: rgba(212, 175, 55, 0.25);
            transform: scale(1.05);
        }

        .mobile-menu-toggle.active {
            background: rgba(212, 175, 55, 0.3);
        }

        .sidebar-header {
            padding: 2rem 1.75rem;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
            display: none !important; /* Escondido no desktop - só aparece no mobile quando menu hambúrguer está aberto */
            align-items: center;
            justify-content: center;
            min-height: 100px;
        }
        
        /* Garantir que no desktop a logo nunca apareça */
        @media (min-width: 769px) {
            .sidebar-header {
                display: none !important;
            }
        }

        .sidebar-header img {
            max-width: 140px;
            width: 100%;
            height: auto;
            margin-bottom: 0;
            filter: drop-shadow(0 2px 10px rgba(212, 175, 55, 0.2));
            display: block;
            object-fit: contain;
        }

        .sidebar-header h2 {
            font-family: 'Playfair Display', serif;
            color: #D4AF37;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .sidebar-nav {
            flex: 1;
            padding: 1rem 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.875rem 1.75rem;
            color: rgba(245, 243, 239, 0.7);
            text-decoration: none;
            cursor: pointer;
            gap: 0.875rem;
            font-size: 0.9375rem;
            font-weight: 500;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 0.25rem 0.75rem;
            border-radius: 8px;
        }

        .nav-item:hover {
            background: rgba(212, 175, 55, 0.08);
            color: #D4AF37;
            transform: translateX(2px);
        }

        .nav-item.active {
            background: rgba(212, 175, 55, 0.12);
            color: #D4AF37;
            font-weight: 600;
            border-left: 3px solid #D4AF37;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 1.5rem;
            border-top: 1px solid #eee;
        }

        .user-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .user-role {
            font-size: 0.875rem;
            color: #B88A44;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            position: relative;
            z-index: 1;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-header {
            margin-bottom: 2.5rem;
        }

        .page-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: #D4AF37;
            letter-spacing: -0.03em;
            margin-bottom: 0.5rem;
        }

        .card {
            background: #1A1A1A;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            border: 1px solid rgba(184, 138, 68, 0.15);
            margin-bottom: 2rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            border-color: rgba(184, 138, 68, 0.3);
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        }

        .card h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #F5F3EF;
            margin-bottom: 1.5rem;
            letter-spacing: -0.01em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #1A1A1A 0%, #2B2B2B 100%);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            border: 1px solid rgba(184, 138, 68, 0.15);
            display: flex;
            align-items: center;
            gap: 1.25rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: rgba(212, 175, 55, 0.3);
            box-shadow: 0 8px 24px rgba(0,0,0,0.6);
        }

        .stat-icon {
            width: 64px;
            height: 64px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #0F0F0F;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .stat-icon-green { background: #D4AF37; }
        .stat-icon-blue { background: #B88A44; }
        .stat-icon-purple { background: #D4AF37; }
        .stat-icon-red { background: #B88A44; }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #F5F3EF;
            letter-spacing: -0.02em;
        }

        .stat-label {
            font-size: 0.8125rem;
            color: rgba(184, 138, 68, 0.8);
            margin-bottom: 0.375rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        /* Kanban */
        .kanban-board {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 1rem;
        }

        .kanban-column {
            min-width: 320px;
            background: #1A1A1A;
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid rgba(184, 138, 68, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .kanban-column:hover {
            border-color: rgba(184, 138, 68, 0.3);
        }

        .kanban-column-header {
            background: linear-gradient(135deg, #0F0F0F 0%, #1A1A1A 100%);
            padding: 1.125rem 1.25rem;
            border-radius: 10px;
            margin-bottom: 1.25rem;
            font-weight: 600;
            font-size: 0.9375rem;
            color: #D4AF37;
            text-align: center;
            border: 1px solid rgba(212, 175, 55, 0.2);
            letter-spacing: 0.02em;
            text-transform: uppercase;
        }

        .kanban-card {
            background: #2B2B2B;
            border-radius: 10px;
            padding: 1.25rem;
            margin-bottom: 0.875rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            border: 1px solid rgba(184, 138, 68, 0.2);
            cursor: move;
            color: #F5F3EF;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .kanban-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(212, 175, 55, 0.25);
            border-color: rgba(212, 175, 55, 0.4);
            background: #2F2F2F;
        }

        .kanban-card.dragging {
            opacity: 0.5;
        }

        .kanban-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .kanban-tag {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            color: white;
            font-weight: 500;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: #1A1A1A;
        }

        .data-table th {
            padding: 1.125rem 1.25rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.8125rem;
            border-bottom: 2px solid rgba(212, 175, 55, 0.3);
            color: #D4AF37;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .data-table td {
            padding: 1.125rem 1.25rem;
            border-bottom: 1px solid rgba(184, 138, 68, 0.1);
            color: rgba(245, 243, 239, 0.9);
            font-size: 0.9375rem;
        }

        .data-table tbody tr {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .data-table tbody tr:hover {
            background: rgba(212, 175, 55, 0.05);
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-badge.lead { background: rgba(212, 175, 55, 0.2); color: #D4AF37; border: 1px solid #D4AF37; }
        .status-badge.cliente { background: rgba(184, 138, 68, 0.2); color: #B88A44; border: 1px solid #B88A44; }
        .status-badge.recorrente { background: rgba(212, 175, 55, 0.3); color: #D4AF37; border: 1px solid #D4AF37; }

        /* Products Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .product-card {
            background: linear-gradient(135deg, #1A1A1A 0%, #2B2B2B 100%);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            border: 1px solid rgba(184, 138, 68, 0.15);
            color: #F5F3EF;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-4px);
            border-color: rgba(212, 175, 55, 0.3);
            box-shadow: 0 8px 24px rgba(0,0,0,0.6);
        }

        .product-card.low-stock {
            border-color: rgba(251, 191, 36, 0.4);
            background: linear-gradient(135deg, #1A1A1A 0%, #2B2B2B 100%);
        }

        .product-card.low-stock:hover {
            border-color: rgba(251, 191, 36, 0.6);
        }

        .product-card.out-of-stock {
            border-color: rgba(239, 68, 68, 0.4);
            background: linear-gradient(135deg, #1A1A1A 0%, #2B2B2B 100%);
            opacity: 0.85;
        }

        .product-card.out-of-stock:hover {
            border-color: rgba(239, 68, 68, 0.6);
        }

        .product-card h3 {
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }

        .product-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #F5F3EF;
        }

        /* Settings */
        .settings-menu-item {
            width: 100%;
            padding: 1rem;
            background: transparent;
            border: none;
            color: rgba(245, 243, 239, 0.7);
            text-align: left;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 0.25rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9375rem;
        }

        .settings-menu-item:hover {
            background: rgba(212, 175, 55, 0.1);
            color: #D4AF37;
        }

        .settings-menu-item.active {
            background: rgba(212, 175, 55, 0.2);
            color: #D4AF37;
            font-weight: 500;
        }

        .settings-menu-item i {
            width: 20px;
            text-align: center;
        }

        .settings-section {
            display: none;
        }

        .settings-section.active {
            display: block;
        }

        .settings-section .form-group {
            margin-bottom: 1.5rem;
        }

        .settings-section .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: rgba(245, 243, 239, 0.9);
            font-weight: 500;
        }

        .settings-section .form-group input[type="text"],
        .settings-section .form-group input[type="email"],
        .settings-section .form-group input[type="number"],
        .settings-section .form-group input[type="password"],
        .settings-section .form-group select {
            width: 100%;
            padding: 0.75rem;
            background: #0F0F0F;
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 8px;
            color: #F5F3EF;
            font-size: 0.9375rem;
        }

        .settings-section .form-group input[type="checkbox"] {
            width: auto;
        }

        .settings-section .form-group small {
            display: block;
            margin-top: 0.5rem;
            color: rgba(245, 243, 239, 0.6);
            font-size: 0.875rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1A1A1A;
            border-radius: 16px;
            width: 90%;
            max-width: 520px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(212, 175, 55, 0.2);
            color: #F5F3EF;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        }

        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #0F0F0F;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(184, 138, 68, 0.3);
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(184, 138, 68, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem;
            border-bottom: 1px solid rgba(184, 138, 68, 0.15);
        }

        .modal-header h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            font-weight: 700;
            color: #D4AF37;
            letter-spacing: -0.02em;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .modal-content form {
            padding: 2rem;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }

        .sale-item-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .sale-item-row select {
            flex: 2;
        }

        .sale-item-row input {
            flex: 1;
            max-width: 100px;
        }

        .sale-total {
            padding: 1.5rem;
            background: linear-gradient(135deg, #0F0F0F 0%, #1A1A1A 100%);
            border-radius: 10px;
            text-align: right;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 1.5rem 0;
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: #D4AF37;
            letter-spacing: -0.02em;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: rgba(184, 138, 68, 0.6);
            font-size: 0.9375rem;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 3rem;
            color: rgba(184, 138, 68, 0.6);
            font-size: 0.9375rem;
        }

        /* Smooth Transitions */
        * {
            transition: border-color 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Selection */
        ::selection {
            background: rgba(212, 175, 55, 0.3);
            color: #F5F3EF;
        }

        /* Focus States */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 2px solid #D4AF37;
            outline-offset: 2px;
        }

        /* Alerts */
        .alerts-container {
            margin-bottom: 2rem;
        }

        .alert-card {
            background: linear-gradient(135deg, #1A1A1A 0%, #2B2B2B 100%);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            border: 2px solid;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            animation: pulse 2s infinite;
        }

        .alert-urgent {
            border-color: #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, #1A1A1A 100%);
        }

        .alert-warning {
            border-color: #F59E0B;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, #1A1A1A 100%);
        }

        .alert-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .alert-urgent .alert-icon {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .alert-content {
            flex: 1;
        }

        .alert-content h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #F5F3EF;
        }

        .alert-content p {
            font-size: 0.875rem;
            color: rgba(245, 243, 239, 0.7);
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            }
            50% {
                box-shadow: 0 4px 24px rgba(239, 68, 68, 0.3);
            }
        }

        /* Priority Badges */
        .priority-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.625rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .priority-urgent {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.4);
        }

        .priority-high {
            background: rgba(245, 158, 11, 0.2);
            color: #F59E0B;
            border: 1px solid rgba(245, 158, 11, 0.4);
        }

        .priority-medium {
            background: rgba(212, 175, 55, 0.2);
            color: #D4AF37;
            border: 1px solid rgba(212, 175, 55, 0.4);
        }

        /* Kanban Card Enhancements */
        .kanban-card.priority {
            border-left: 4px solid;
        }

        .kanban-card.priority-urgent {
            border-left-color: #ef4444;
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, #2B2B2B 100%);
        }

        .kanban-card.priority-high {
            border-left-color: #F59E0B;
        }

        .kanban-card.overdue {
            animation: shake 0.5s;
        }

        .kanban-card .followup-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding: 0.5rem;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 6px;
            font-size: 0.8125rem;
        }

        .kanban-card .followup-indicator.overdue {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .kanban-card .days-in-column {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 0.75rem;
            color: rgba(184, 138, 68, 0.7);
            font-weight: 500;
        }

        .kanban-card {
            position: relative;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(184, 138, 68, 0.2);
        }

        .quick-action-btn {
            flex: 1;
            padding: 0.5rem;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 6px;
            color: #D4AF37;
            font-size: 0.8125rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .quick-action-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #D4AF37;
        }

        /* Hot Lead Indicator */
        .hot-lead {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 12px;
            height: 12px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
        }

        @keyframes pulse-dot {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }
        }

        /* Responsive */
        /* Responsividade Mobile */
        @media (max-width: 1024px) {
            .main-content {
                padding: 1.5rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .kanban-column {
                min-width: 250px;
            }
        }
        
        @media (max-width: 768px) {
            #app-screen {
                position: relative;
                flex-direction: column;
            }

            .mobile-menu-toggle {
                display: flex !important;
            }
            
            .sidebar-overlay {
                display: block;
            }

            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                width: 280px;
                max-width: 85%;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                box-shadow: 4px 0 24px rgba(0,0,0,0.6);
            }

            .sidebar.active {
                transform: translateX(0);
            }
            
            .sidebar-overlay.active {
                display: block;
                opacity: 1;
            }
            
            /* Ajustes do header no mobile */
            .sidebar-header {
                padding: 2rem 1rem;
                min-height: 100px;
                display: flex !important;
                align-items: center;
                justify-content: center;
                background: transparent;
                width: 100%;
                text-align: center;
            }
            
            .sidebar-header img {
                max-width: 180px;
                width: auto;
                height: auto;
                max-height: 90px;
                object-fit: contain;
                display: block !important;
                visibility: visible !important;
                filter: drop-shadow(0 2px 10px rgba(212, 175, 55, 0.3));
                background: transparent;
                margin: 0 auto;
            }
            
            /* Garantir que os itens do menu apareçam no mobile quando o menu está aberto */
            .sidebar.active .nav-item {
                display: flex !important;
                visibility: visible !important;
            }
            
            /* Garantir que a logo apareça no mobile */
            .sidebar.active .sidebar-header {
                display: flex !important;
            }
            
            .sidebar.active .sidebar-header img {
                display: block !important;
                visibility: visible !important;
            }

            .main-content {
                padding: 1rem 0.75rem;
                padding-top: 4.5rem;
                width: 100%;
                margin-left: 0;
                position: relative;
                z-index: 1;
                min-height: calc(100vh - 4.5rem);
                overflow-x: hidden;
                box-sizing: border-box;
            }
            
            /* Prevenir scroll do body quando menu está aberto */
            body.menu-open {
                overflow: hidden;
                position: fixed;
                width: 100%;
                height: 100%;
            }
            
            /* Garantir que o overlay fique acima do conteúdo */
            .sidebar-overlay {
                z-index: 999;
            }
            
            /* Sidebar acima do overlay */
            .sidebar {
                z-index: 1000;
            }
            
            /* Botão hambúrguer acima de tudo */
            .mobile-menu-toggle {
                z-index: 1001;
            }
            
            /* Ajustes para tabelas no mobile */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                width: 100%;
                margin: 0 -1rem;
                padding: 0 1rem;
            }
            
            .data-table {
                font-size: 0.75rem;
                min-width: 600px;
                width: 100%;
            }
            
            .data-table th,
            .data-table td {
                padding: 0.5rem 0.4rem;
                white-space: nowrap;
                font-size: 0.75rem;
            }
            
            .data-table th {
                font-size: 0.7rem;
                font-weight: 600;
            }
            
            /* Esconder tabelas no mobile e mostrar cards */
            .invoices-table-desktop {
                display: block;
            }
            
            .invoices-cards-mobile {
                display: none;
            }
            
            @media (max-width: 768px) {
                .invoices-table-desktop {
                    display: none !important;
                }
                
                .invoices-cards-mobile {
                    display: block !important;
                }
                
                /* Melhorar cards de cobrança no mobile */
                .invoice-card-mobile {
                    margin-bottom: 1rem;
                }
                
                .invoice-card-mobile-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 0.5rem;
                }
                
                .invoice-card-mobile-actions {
                    flex-direction: column;
                }
                
                .invoice-card-mobile-actions .btn {
                    width: 100%;
                }
            }
            
            /* Cards para mobile - Cobranças */
            .invoice-card-mobile {
                background: var(--bg-card);
                border: 1px solid rgba(212, 175, 55, 0.2);
                border-radius: 12px;
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .invoice-card-mobile-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 0.75rem;
                padding-bottom: 0.75rem;
                border-bottom: 1px solid rgba(212, 175, 55, 0.1);
            }
            
            .invoice-card-mobile-number {
                font-weight: 600;
                color: var(--primary-color);
                font-size: 1rem;
            }
            
            .invoice-card-mobile-status {
                padding: 0.25rem 0.5rem;
                border-radius: 6px;
                font-size: 0.7rem;
                font-weight: 600;
            }
            
            .invoice-card-mobile-info {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                margin-bottom: 1rem;
            }
            
            .invoice-card-mobile-info-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.875rem;
            }
            
            .invoice-card-mobile-info-label {
                color: rgba(245, 243, 239, 0.6);
                font-size: 0.8rem;
            }
            
            .invoice-card-mobile-info-value {
                font-weight: 500;
                text-align: right;
                word-break: break-word;
            }
            
            .invoice-card-mobile-actions {
                display: flex;
                gap: 0.5rem;
                margin-top: 1rem;
                padding-top: 1rem;
                border-top: 1px solid rgba(212, 175, 55, 0.1);
            }
            
            .invoice-card-mobile-actions .btn {
                flex: 1;
                padding: 0.75rem;
                font-size: 0.875rem;
            }
            
            /* Cards mais compactos */
            .card {
                padding: 1rem 0.75rem;
                margin-bottom: 1rem;
                width: 100%;
                box-sizing: border-box;
            }
            
            /* Page header melhorado no mobile */
            .page-header {
                padding: 1rem 0;
            }
            
            .page-header h1 {
                font-size: 1.5rem;
                line-height: 1.3;
                word-wrap: break-word;
                width: 100%;
            }
            
            .page-header > div {
                width: 100%;
            }
            
            .page-header select,
            #invoice-filter,
            #financial-period,
            #customer-filter-status,
            #customer-filter-followup {
                width: 100%;
                max-width: 100%;
                font-size: 16px !important;
            }
            
            /* Botões em linha no mobile */
            .btn-group {
                flex-direction: column;
                width: 100%;
            }
            
            .btn-group .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            /* Page header mais compacto */
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .page-header h1 {
                font-size: 1.5rem;
            }
            
            /* Stats grid em 1 coluna */
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            /* Products grid em 1 coluna */
            .products-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            /* Modais em tela cheia no mobile */
            .modal {
                padding: 0;
                align-items: flex-end;
            }
            
            .modal-content {
                width: 100%;
                max-width: 100%;
                margin: 0;
                border-radius: 15px 15px 0 0;
                max-height: 95vh;
                padding: 1rem;
                position: fixed;
                bottom: 0;
                top: auto;
                animation: modalSlideUp 0.3s ease-out;
            }
            
            @keyframes modalSlideUp {
                from {
                    opacity: 0;
                    transform: translateY(100%);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            /* Formulários em coluna */
            .form-row {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .form-group {
                width: 100%;
                margin-bottom: 1rem;
            }
            
            /* Inputs e selects menores - prevenir zoom no iOS */
            input[type="text"],
            input[type="email"],
            input[type="number"],
            input[type="date"],
            input[type="tel"],
            select,
            textarea {
                font-size: 16px; /* Previne zoom no iOS */
                padding: 0.75rem;
            }
            
            /* Garantir que não haja overflow horizontal */
            .main-content,
            .page,
            .card,
            .form-group,
            .btn-group {
                max-width: 100%;
                overflow-x: hidden;
            }
            
            /* Prevenir quebra de layout */
            img {
                max-width: 100%;
                height: auto;
            }
            
            /* Ajustes de toque */
            .btn,
            button,
            .nav-item {
                min-height: 44px;
                -webkit-tap-highlight-color: rgba(212, 175, 55, 0.2);
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .page-header h1 {
                font-size: 1.75rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .kanban-board {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .kanban-column {
                min-width: 280px;
            }

            /* Tabelas responsivas */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 600px;
            }

            /* Cards de produtos */
            .products-grid {
                grid-template-columns: 1fr;
            }

            /* Modais responsivos */
            .modal {
                padding: 0;
                align-items: flex-end;
            }
            
            .modal-content {
                width: 100%;
                max-width: 100%;
                margin: 0;
                border-radius: 15px 15px 0 0;
                max-height: 95vh;
                overflow-y: auto;
                padding: 1rem;
                position: fixed;
                bottom: 0;
                top: auto;
            }

            /* Formulários */
            .form-row {
                flex-direction: column;
            }

            .form-group {
                width: 100%;
            }

            /* Botões */
            .btn {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }

            /* Cards */
            .card {
                padding: 1rem;
            }

            /* Sidebar footer */
            .sidebar-footer {
                padding: 1rem;
            }

            .user-info {
                font-size: 0.875rem;
            }

            /* Kanban cards menores */
            .kanban-card {
                padding: 0.75rem;
                font-size: 0.875rem;
            }

            /* Dashboard stats */
            .stat-card {
                padding: 1rem;
            }

            .stat-icon {
                width: 48px;
                height: 48px;
                font-size: 1.25rem;
            }

            /* Configurações */
            .settings-container {
                flex-direction: column;
            }

            .settings-menu {
                width: 100%;
                margin-bottom: 1rem;
            }

            .settings-content {
                width: 100%;
            }
            
            /* Tabelas com scroll horizontal */
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }
            
            /* Cards de ação em linha */
            .btn-sm {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 0.75rem;
                padding-top: 3.5rem;
            }

            .page-header h1 {
                font-size: 1.5rem;
            }

            .modal-content {
                width: 100%;
                max-width: 100%;
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
                padding: 1rem;
            }

            .modal-header {
                padding: 1rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .modal-header h2 {
                font-size: 1.25rem;
            }
            
            /* Ajustes adicionais para mobile pequeno */
            .main-content {
                padding: 0.75rem;
                padding-top: 3.5rem;
            }
            
            .page-header h1 {
                font-size: 1.25rem;
            }
            
            .card {
                padding: 0.75rem;
            }
            
            .stat-card {
                padding: 0.75rem;
            }
            
            .stat-value {
                font-size: 1.25rem;
            }
            
            .stat-label {
                font-size: 0.75rem;
            }
            
            .btn-sm {
                padding: 0.375rem 0.5rem;
                font-size: 0.7rem;
            }
            
            .data-table {
                font-size: 0.7rem;
            }
            
            .data-table th,
            .data-table td {
                padding: 0.375rem 0.25rem;
            }
            
            input, select, textarea {
                font-size: 16px; /* Previne zoom no iOS */
                padding: 0.625rem;
            }

            .modal-close {
                position: absolute;
                top: 1rem;
                right: 1rem;
                font-size: 1.5rem;
            }

            .mobile-menu-toggle {
                top: 0.75rem;
                left: 0.75rem;
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .sidebar {
                width: 100%;
                max-width: 320px;
            }

            .stats-grid {
                gap: 0.75rem;
            }

            .stat-card {
                padding: 0.75rem;
            }

            /* Tabelas em cards no mobile */
            .table-container {
                margin: -1rem;
                padding: 0;
            }

            table {
                font-size: 0.75rem;
                min-width: 500px;
            }

            table th,
            table td {
                padding: 0.5rem 0.25rem;
            }

            /* Cards de produtos mobile */
            .product-card {
                padding: 0.75rem;
            }

            .product-card img {
                max-width: 80px;
                max-height: 80px;
            }

            .product-card h3 {
                font-size: 1rem;
            }

            /* Formulários mobile */
            .form-group label {
                font-size: 0.875rem;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 0.875rem;
                padding: 0.625rem;
            }

            /* Botões mobile */
            .btn {
                padding: 0.625rem 0.875rem;
                font-size: 0.875rem;
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn-group .btn {
                margin-right: 0;
            }

            /* Kanban mobile */
            .kanban-column {
                min-width: 250px;
            }

            .kanban-card {
                padding: 0.625rem;
                font-size: 0.8125rem;
            }

            /* Inputs de busca */
            .search-box {
                width: 100%;
                margin-bottom: 1rem;
            }

            .search-box input {
                font-size: 0.875rem;
                padding: 0.625rem;
            }

            /* Badges e tags */
            .badge,
            .status-badge {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
            }

            /* Grid de produtos */
            .products-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            /* Cards de estatísticas */
            .stat-icon {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .stat-label {
                font-size: 0.75rem;
            }

            /* Modais de formulário */
            .form-row {
                margin-bottom: 0.75rem;
            }

            /* Imagens de preview */
            #product-image-preview-img {
                max-width: 80px;
                max-height: 80px;
            }

            /* Sidebar footer mobile */
            .sidebar-footer {
                padding: 0.75rem;
            }
            
            /* Garantir que modais não quebrem */
            .modal {
                padding: 0;
            }
            
            /* Ajustes de overflow */
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Garantir que botões não fiquem muito pequenos */
            .btn {
                min-height: 44px; /* Tamanho mínimo para touch */
            }
            
            /* Ajustes de toque */
            .nav-item,
            .btn,
            button {
                -webkit-tap-highlight-color: rgba(212, 175, 55, 0.2);
            }
        }
        
        /* Tablet - entre 481px e 768px */
        @media (min-width: 481px) and (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .main-content {
                padding: 1.25rem;
                padding-top: 4rem;
            }
        }
        
        /* Desktop pequeno - entre 769px e 1024px */
        @media (min-width: 769px) and (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .products-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .main-content {
                padding: 1.5rem;
            }
            
            .user-info {
                font-size: 0.75rem;
            }

            /* Configurações mobile */
            .settings-menu-item {
                padding: 0.75rem;
                font-size: 0.875rem;
            }
        }

        /* Breakpoint extra pequeno */
        @media (max-width: 360px) {
            .main-content {
                padding: 0.5rem;
                padding-top: 3rem;
            }

            .page-header h1 {
                font-size: 1.25rem;
            }

            .modal-content {
                padding: 0.75rem;
            }

            .btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.8125rem;
            }

            table {
                font-size: 0.6875rem;
                min-width: 450px;
            }

            .product-card h3 {
                font-size: 0.9375rem;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page.active {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card {
            animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="screen active">
        <div class="login-container">
            <div class="login-box">
                <div class="login-header">
                    <img src="https://zpqtcrfygjtjtacufgbv.supabase.co/storage/v1/object/public/logos/LOGO%20SEM%20FUNDO.png" alt="CJ Empórium Logo" />
                </div>
                <form id="login-form">
                    <div id="login-error" class="error-message"></div>
                    <div class="form-group">
                        <label><i class="fas fa-envelope"></i> E-mail</label>
                        <input type="email" id="email" value="admin@cjemporium.com" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> Senha</label>
                        <input type="password" id="password" value="admin123" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- App Screen -->
    <div id="app-screen" class="screen">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="https://zpqtcrfygjtjtacufgbv.supabase.co/storage/v1/object/public/logos/LOGO%20SEM%20FUNDO.png" alt="CJ Empórium Logo" />
            </div>
            <nav class="sidebar-nav">
                <a class="nav-item active" data-page="dashboard" data-permission="view_dashboard">
                    <i class="fas fa-chart-line"></i> <span>Dashboard</span>
                </a>
                <a class="nav-item" data-page="customers" data-permission="view_customers">
                    <i class="fas fa-users"></i> <span>Clientes</span>
                </a>
                <a class="nav-item" data-page="products" data-permission="view_products">
                    <i class="fas fa-box"></i> <span>Produtos</span>
                </a>
                <a class="nav-item" data-page="sales" data-permission="view_sales">
                    <i class="fas fa-shopping-cart"></i> <span>Vendas</span>
                </a>
                <a class="nav-item" data-page="invoices" data-permission="view_sales">
                    <i class="fas fa-file-invoice"></i> <span>Cobranças</span>
                </a>
                <a class="nav-item" data-page="financial" data-permission="view_financial">
                    <i class="fas fa-chart-pie"></i> <span>Financeiro</span>
                </a>
                <a class="nav-item" data-page="coupons" data-permission="view_sales">
                    <i class="fas fa-ticket-alt"></i> <span>Cupons</span>
                </a>
                <a class="nav-item" data-page="loyalty" data-permission="view_customers">
                    <i class="fas fa-star"></i> <span>Fidelidade</span>
                </a>
                <a class="nav-item" data-page="recurrence" data-permission="view_customers">
                    <i class="fas fa-sync-alt"></i> <span>Recorrência</span>
                </a>
                <a class="nav-item" data-page="profile" data-permission="view_users">
                    <i class="fas fa-user-circle"></i> <span>Perfil</span>
                </a>
                <a class="nav-item" data-page="settings" data-permission="view_settings">
                    <i class="fas fa-cog"></i> <span>Configurações</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <p class="user-name" id="user-name">Admin</p>
                    <p class="user-role" id="user-role">Administrador</p>
                </div>
                <button class="btn btn-secondary btn-block" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">
            <!-- Botão Hambúrguer Mobile -->
            <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
            
            <!-- Overlay para fechar menu no mobile -->
            <div class="sidebar-overlay" id="sidebar-overlay"></div>
            
            <!-- Dashboard -->
            <div id="dashboard-page" class="page active">
                <div class="page-header">
                    <h1>Dashboard</h1>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-green">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div>
                            <p class="stat-label">Faturamento</p>
                            <p class="stat-value" id="stat-revenue">R$ 0,00</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-blue">
                            <i class="fas fa-users"></i>
                        </div>
                        <div>
                            <p class="stat-label">Total de Leads</p>
                            <p class="stat-value" id="stat-leads">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-purple">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div>
                            <p class="stat-label">Vendas</p>
                            <p class="stat-value" id="stat-sales">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-red">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div>
                            <p class="stat-label">Follow-ups</p>
                            <p class="stat-value" id="stat-followups">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customers -->
            <div id="customers-page" class="page">
                <div class="page-header">
                    <h1>Clientes</h1>
                    <button class="btn btn-primary" id="add-customer-form-btn">
                        <i class="fas fa-plus"></i> Novo Cliente
                    </button>
                </div>
                
                <!-- Barra de Busca e Filtros -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                        <div style="flex: 1; min-width: 250px;">
                            <div style="position: relative;">
                                <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: rgba(245, 243, 239, 0.5);"></i>
                                <input type="text" id="customer-search" placeholder="Buscar por nome, telefone ou e-mail..." 
                                    style="width: 100%; padding: 0.75rem 0.75rem 0.75rem 2.5rem; background: #1A1A1A; border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 8px; color: #F5F3EF; font-size: 0.9rem;">
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <select id="customer-filter-status" style="padding: 0.75rem; background: #1A1A1A; border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 8px; color: #F5F3EF; font-size: 0.9rem; cursor: pointer;">
                                <option value="">Todos os Status</option>
                                <option value="novo">Novo</option>
                                <option value="contato">Contato Realizado</option>
                                <option value="negociacao">Em Negociação</option>
                                <option value="aguardando">Aguardando Retorno</option>
                                <option value="cliente">Cliente</option>
                                <option value="recorrente">Recorrente</option>
                                <option value="perdido">Perdido</option>
                            </select>
                            <select id="customer-filter-followup" style="padding: 0.75rem; background: #1A1A1A; border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 8px; color: #F5F3EF; font-size: 0.9rem; cursor: pointer;">
                                <option value="">Todos os Follow-ups</option>
                                <option value="overdue">Follow-ups Vencidos</option>
                                <option value="today">Hoje</option>
                                <option value="week">Esta Semana</option>
                            </select>
                            <button id="clear-filters" class="btn btn-secondary" style="padding: 0.75rem 1rem;">
                                <i class="fas fa-times"></i> Limpar
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- CRM Kanban -->
                <div class="card" style="margin-bottom: 2rem;">
                    <div class="kanban-board" id="kanban-board"></div>
                </div>
                
                <!-- Tabela de Clientes -->
                <div class="card">
                    <h2 style="margin-bottom: 1rem; color: #D4AF37;">Lista de Clientes</h2>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Telefone</th>
                                    <th>E-mail</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="customers-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Products -->
            <div id="products-page" class="page">
                <div class="page-header">
                    <h1>Produtos</h1>
                    <button class="btn btn-primary" id="add-product-btn">
                        <i class="fas fa-plus"></i> Novo Produto
                    </button>
                </div>
                <div class="products-grid" id="products-grid"></div>
            </div>

            <!-- Sales -->
            <div id="sales-page" class="page">
                <div class="page-header">
                    <h1>Vendas</h1>
                    <button class="btn btn-primary" id="add-sale-btn">
                        <i class="fas fa-plus"></i> Nova Venda
                    </button>
                </div>
                <div class="card">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Número</th>
                                    <th>Cliente</th>
                                    <th>Valor</th>
                                    <th>Pagamento</th>
                                    <th>Status</th>
                                    <th>Data</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="sales-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Invoices (Cobranças) -->
            <div id="invoices-page" class="page">
                <div class="page-header">
                    <h1>Cobranças e Comprovantes</h1>
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <select id="invoice-filter" style="padding: 0.625rem 1rem; border: 1px solid rgba(184, 138, 68, 0.3); border-radius: 8px; background: #0F0F0F; color: #F5F3EF; font-size: 0.9375rem; cursor: pointer; width: 100%; max-width: 300px;">
                            <option value="all">Todas</option>
                            <option value="pending">Pendentes</option>
                            <option value="overdue">Vencidas</option>
                            <option value="this-month">Este Mês</option>
                        </select>
                    </div>
                </div>

                <!-- Desktop Table View -->
                <div class="card invoices-table-desktop">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Número</th>
                                    <th>Cliente</th>
                                    <th>Valor Total</th>
                                    <th>Forma de Pagamento</th>
                                    <th>Parcelas</th>
                                    <th>Próximo Vencimento</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="invoices-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Mobile Cards View -->
                <div id="invoices-cards-mobile" class="invoices-cards-mobile" style="display: none;"></div>
            </div>

            <!-- Financial -->
            <div id="financial-page" class="page">
                <div class="page-header">
                    <h1>Análise Financeira</h1>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <select id="financial-period" style="padding: 0.625rem 1rem; border: 1px solid rgba(184, 138, 68, 0.3); border-radius: 8px; background: #0F0F0F; color: #F5F3EF; font-size: 0.9375rem; cursor: pointer;">
                            <option value="month">Este Mês</option>
                            <option value="week">Esta Semana</option>
                            <option value="day">Hoje</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>
                </div>

                <!-- Financial Overview -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-green">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div>
                            <p class="stat-label">Receita Total</p>
                            <p class="stat-value" id="financial-revenue">R$ 0,00</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-blue">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div>
                            <p class="stat-label">Lucro Líquido</p>
                            <p class="stat-value" id="financial-profit">R$ 0,00</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-purple">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div>
                            <p class="stat-label">Margem</p>
                            <p class="stat-value" id="financial-margin">0%</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-red">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <div>
                            <p class="stat-label">Ticket Médio</p>
                            <p class="stat-value" id="financial-ticket">R$ 0,00</p>
                        </div>
                    </div>
                </div>

                <!-- Top Products -->
                <div class="card">
                    <h2>Produtos Mais Rentáveis</h2>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Produto</th>
                                    <th>Receita</th>
                                    <th>Lucro</th>
                                    <th>Margem</th>
                                    <th>Unidades</th>
                                </tr>
                            </thead>
                            <tbody id="top-products-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Top Customers -->
                <div class="card">
                    <h2>Clientes Mais Lucrativos</h2>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Cliente</th>
                                    <th>Receita Total</th>
                                    <th>Compras</th>
                                    <th>Ticket Médio</th>
                                    <th>Última Compra</th>
                                </tr>
                            </thead>
                            <tbody id="top-customers-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Recurrence -->
            <div id="recurrence-page" class="page">
                <div class="page-header">
                    <h1>Recorrência & Reativação</h1>
                </div>

                <!-- Reactivation Alerts -->
                <div id="reactivation-alerts" class="alerts-container" style="display: none;">
                    <div class="alert-card alert-warning">
                        <div class="alert-icon">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div class="alert-content">
                            <h3>Clientes para Reativar</h3>
                            <p id="reactivation-count">0 clientes precisam de atenção</p>
                        </div>
                    </div>
                </div>

                <!-- Ready for Repurchase -->
                <div class="card">
                    <h2>Clientes Aptos à Recompra</h2>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Compras</th>
                                    <th>Intervalo Médio</th>
                                    <th>Última Compra</th>
                                    <th>Dias Inativo</th>
                                    <th>Próxima Estimada</th>
                                    <th>Prioridade</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="ready-repurchase-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Reactivation List -->
                <div class="card">
                    <h2>Alertas de Reativação</h2>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Dias Inativo</th>
                                    <th>Intervalo Médio</th>
                                    <th>Valor Total</th>
                                    <th>Última Compra</th>
                                    <th>Prioridade</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="reactivation-list-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Profile / Usuários -->
            <div id="profile-page" class="page">
                <div class="page-header">
                    <h1><i class="fas fa-user-circle"></i> Perfil e Usuários</h1>
                    <button class="btn btn-primary" id="add-user-btn">
                        <i class="fas fa-plus"></i> Novo Usuário
                    </button>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; margin-top: 2rem;">
                    <!-- Perfil Atual -->
                    <div class="card">
                        <h2 style="margin-bottom: 1.5rem; color: #D4AF37;">Meu Perfil</h2>
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <div style="width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, #D4AF37 0%, #B88A44 100%); margin: 0 auto; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: #0F0F0F; font-weight: 700;">
                                <i class="fas fa-user"></i>
                            </div>
                            <h3 style="margin-top: 1rem; color: #D4AF37;" id="current-user-name">Admin</h3>
                            <p style="color: rgba(245, 243, 239, 0.6);" id="current-user-role">Administrador</p>
                        </div>
                        <div class="form-group">
                            <label>Nome</label>
                            <input type="text" id="profile-name" placeholder="Seu nome">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="profile-email" placeholder="seu@email.com">
                        </div>
                        <div class="form-group">
                            <label>Telefone</label>
                            <input type="text" id="profile-phone" placeholder="(00) 00000-0000">
                        </div>
                        <div class="form-group">
                            <label>Senha Atual</label>
                            <input type="password" id="profile-current-password" placeholder="Digite sua senha atual">
                        </div>
                        <div class="form-group">
                            <label>Nova Senha</label>
                            <input type="password" id="profile-new-password" placeholder="Deixe em branco para não alterar">
                        </div>
                        <button class="btn btn-primary btn-block" onclick="updateProfile()">
                            <i class="fas fa-save"></i> Atualizar Perfil
                        </button>
                    </div>

                    <!-- Lista de Usuários -->
                    <div class="card">
                        <h2 style="margin-bottom: 1.5rem; color: #D4AF37;">Usuários do Sistema</h2>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Email</th>
                                        <th>Perfil</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coupons -->
            <div id="coupons-page" class="page">
                <div class="page-header">
                    <h1>Cupons e Promoções</h1>
                    <button class="btn btn-primary" id="add-coupon-btn">
                        <i class="fas fa-plus"></i> Novo Cupom
                    </button>
                </div>
                <div class="card">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Tipo</th>
                                    <th>Desconto</th>
                                    <th>Válido até</th>
                                    <th>Usos</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="coupons-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Loyalty Program -->
            <div id="loyalty-page" class="page">
                <div class="page-header">
                    <h1>Programa de Fidelidade</h1>
                    <button class="btn btn-primary" id="configure-loyalty-btn">
                        <i class="fas fa-cog"></i> Configurar
                    </button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-purple">
                            <i class="fas fa-users"></i>
                        </div>
                        <div>
                            <p class="stat-label">Clientes no Programa</p>
                            <p class="stat-value" id="loyalty-customers-count">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-green">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div>
                            <p class="stat-label">Pontos Totais Emitidos</p>
                            <p class="stat-value" id="loyalty-total-points">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-blue">
                            <i class="fas fa-star"></i>
                        </div>
                        <div>
                            <p class="stat-label">Clientes VIP</p>
                            <p class="stat-value" id="loyalty-vip-count">0</p>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 2rem;">
                    <h2 style="margin-bottom: 1rem; color: #D4AF37;">Ranking de Pontos</h2>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Pontos</th>
                                    <th>Nível</th>
                                    <th>Última Compra</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="loyalty-ranking-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div id="settings-page" class="page">
                <div class="page-header">
                    <h1><i class="fas fa-cog"></i> Configurações</h1>
                </div>

                <div style="display: grid; grid-template-columns: 250px 1fr; gap: 2rem; margin-top: 2rem;">
                    <!-- Menu Lateral de Configurações -->
                    <div class="card" style="padding: 0; height: fit-content; position: sticky; top: 2rem;">
                        <div id="settings-menu" style="padding: 0.5rem;">
                            <button class="settings-menu-item active" data-section="general">
                                <i class="fas fa-sliders-h"></i> Geral
                            </button>
                            <button class="settings-menu-item" data-section="stock">
                                <i class="fas fa-box"></i> Estoque
                            </button>
                            <button class="settings-menu-item" data-section="kanban">
                                <i class="fas fa-columns"></i> Kanban
                            </button>
                            <button class="settings-menu-item" data-section="notifications">
                                <i class="fas fa-bell"></i> Notificações
                            </button>
                            <button class="settings-menu-item" data-section="appearance">
                                <i class="fas fa-palette"></i> Aparência
                            </button>
                            <button class="settings-menu-item" data-section="security">
                                <i class="fas fa-shield-alt"></i> Segurança
                            </button>
                        </div>
                    </div>

                    <!-- Conteúdo das Configurações -->
                    <div>
                        <!-- Geral -->
                        <div id="settings-general" class="settings-section active">
                            <div class="card">
                                <h2 style="margin-bottom: 1.5rem; color: #D4AF37;">Configurações Gerais</h2>
                                
                                <div class="form-group">
                                    <label>Nome da Empresa</label>
                                    <input type="text" id="setting-company-name" placeholder="CJ Emporium">
                                </div>

                                <div class="form-group">
                                    <label>Email da Empresa</label>
                                    <input type="email" id="setting-company-email" placeholder="contato@cjemporium.com">
                                </div>

                                <div class="form-group">
                                    <label>Telefone da Empresa</label>
                                    <input type="text" id="setting-company-phone" placeholder="(00) 00000-0000">
                                </div>

                                <div class="form-group">
                                    <label>Moeda Padrão</label>
                                    <select id="setting-currency">
                                        <option value="BRL">Real (R$)</option>
                                        <option value="USD">Dólar ($)</option>
                                        <option value="EUR">Euro (€)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Fuso Horário</label>
                                    <select id="setting-timezone">
                                        <option value="America/Sao_Paulo">America/Sao_Paulo (GMT-3)</option>
                                        <option value="America/New_York">America/New_York (GMT-5)</option>
                                        <option value="Europe/London">Europe/London (GMT+0)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="setting-auto-save" style="margin-right: 0.5rem;">
                                        Salvar automaticamente
                                    </label>
                                </div>

                                <button class="btn btn-primary" onclick="saveSettings('general')">
                                    <i class="fas fa-save"></i> Salvar Configurações Gerais
                                </button>
                            </div>
                        </div>

                        <!-- Estoque -->
                        <div id="settings-stock" class="settings-section">
                            <div class="card">
                                <h2 style="margin-bottom: 1.5rem; color: #D4AF37;">Configurações de Estoque</h2>
                                
                                <div class="form-group">
                                    <label>Limite de Estoque Baixo (unidades)</label>
                                    <input type="number" id="setting-low-stock-threshold" min="0" value="10">
                                    <small style="color: rgba(245, 243, 239, 0.6); display: block; margin-top: 0.5rem;">
                                        Produtos com estoque igual ou abaixo deste valor serão marcados como "Estoque Baixo"
                                    </small>
                                </div>

                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="setting-stock-alerts" style="margin-right: 0.5rem;">
                                        Ativar alertas de estoque baixo
                                    </label>
                                </div>

                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="setting-block-sales-out-of-stock" style="margin-right: 0.5rem;">
                                        Bloquear vendas quando estoque estiver zerado
                                    </label>
                                </div>

                                <div class="form-group">
                                    <label>Método de Custo</label>
                                    <select id="setting-cost-method">
                                        <option value="fifo">FIFO (Primeiro a Entrar, Primeiro a Sair)</option>
                                        <option value="average">Custo Médio</option>
                                        <option value="lifo">LIFO (Último a Entrar, Primeiro a Sair)</option>
                                    </select>
                                </div>

                                <button class="btn btn-primary" onclick="saveSettings('stock')">
                                    <i class="fas fa-save"></i> Salvar Configurações de Estoque
                                </button>
                            </div>
                        </div>

                        <!-- Kanban -->
                        <div id="settings-kanban" class="settings-section">
                            <div class="card">
                                <h2 style="margin-bottom: 1.5rem; color: #D4AF37;">Configurações do Kanban</h2>
                                
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="setting-kanban-auto-move" style="margin-right: 0.5rem;">
                                        Mover automaticamente após venda concluída
                                    </label>
                                </div>

                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="setting-kanban-show-days" style="margin-right: 0.5rem;">
                                        Mostrar dias na coluna atual
                                    </label>
                                </div>

                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="setting-kanban-priority-sort" style="margin-right: 0.5rem;">
                                        Ordenar por prioridade automaticamente
                                    </label>
                                </div>

                                <div class="form-group">
                                    <label>Dias para alerta de prioridade alta</label>
                                    <input type="number" id="setting-kanban-high-priority-days" min="0" value="5">
                                </div>

                                <button class="btn btn-primary" onclick="saveSettings('kanban')">
                                    <i class="fas fa-save"></i> Salvar Configurações do Kanban
                                </button>
                            </div>
                        </div>

                        <!-- Notificações -->
                        <div id="settings-notifications" class="settings-section">
                            <div class="card">
                                <h2 style="margin-bottom: 1.5rem; color: #D4AF37;">Configurações de Notificações</h2>
                                
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="setting-notify-followup" style="margin-right: 0.5rem;">
                                        Notificar sobre follow-ups vencidos
                                    </label>
                                </div>

                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="setting-notify-low-stock" style="margin-right: 0.5rem;">
                                        Notificar sobre estoque baixo
                                    </label>
                                </div>

                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="setting-notify-new-sale" style="margin-right: 0.5rem;">
                                        Notificar sobre novas vendas
                                    </label>
                                </div>

                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="setting-notify-reactivation" style="margin-right: 0.5rem;">
                                        Notificar sobre clientes para reativar
                                    </label>
                                </div>

                                <div class="form-group">
                                    <label>Frequência de verificação de notificações</label>
                                    <select id="setting-notification-frequency">
                                        <option value="realtime">Tempo Real</option>
                                        <option value="5min">A cada 5 minutos</option>
                                        <option value="15min">A cada 15 minutos</option>
                                        <option value="1hour">A cada 1 hora</option>
                                    </select>
                                </div>

                                <button class="btn btn-primary" onclick="saveSettings('notifications')">
                                    <i class="fas fa-save"></i> Salvar Configurações de Notificações
                                </button>
                            </div>
                        </div>

                        <!-- Aparência -->
                        <div id="settings-appearance" class="settings-section">
                            <div class="card">
                                <h2 style="margin-bottom: 1.5rem; color: #D4AF37;">Aparência</h2>
                                
                                <div class="form-group">
                                    <label>Tema</label>
                                    <select id="setting-theme">
                                        <option value="dark">Escuro (Padrão)</option>
                                        <option value="light">Claro</option>
                                        <option value="auto">Automático (Sistema)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Densidade da Interface</label>
                                    <select id="setting-density">
                                        <option value="comfortable">Confortável</option>
                                        <option value="compact">Compacto</option>
                                        <option value="spacious">Espaçoso</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="setting-show-animations" style="margin-right: 0.5rem;">
                                        Mostrar animações
                                    </label>
                                </div>

                                <button class="btn btn-primary" onclick="saveSettings('appearance')">
                                    <i class="fas fa-save"></i> Salvar Configurações de Aparência
                                </button>
                            </div>
                        </div>

                        <!-- Segurança -->
                        <div id="settings-security" class="settings-section">
                            <div class="card">
                                <h2 style="margin-bottom: 1.5rem; color: #D4AF37;">Segurança</h2>
                                
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="setting-require-password-change" style="margin-right: 0.5rem;">
                                        Exigir alteração de senha periodicamente
                                    </label>
                                </div>

                                <div class="form-group">
                                    <label>Dias para expiração de senha</label>
                                    <input type="number" id="setting-password-expiry-days" min="0" value="90">
                                </div>

                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="setting-session-timeout" style="margin-right: 0.5rem;">
                                        Encerrar sessão após inatividade
                                    </label>
                                </div>

                                <div class="form-group">
                                    <label>Minutos de inatividade para logout</label>
                                    <input type="number" id="setting-session-timeout-minutes" min="5" value="30">
                                </div>

                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="setting-log-all-actions" style="margin-right: 0.5rem;">
                                        Registrar todas as ações no log
                                    </label>
                                </div>

                                <button class="btn btn-primary" onclick="saveSettings('security')">
                                    <i class="fas fa-save"></i> Salvar Configurações de Segurança
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="customer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Novo Cliente</h2>
                <button class="modal-close" data-modal="customer-modal" style="color: rgba(245, 243, 239, 0.6);">&times;</button>
            </div>
            <form id="customer-form">
                <div class="form-group">
                    <label>Nome *</label>
                    <input type="text" id="customer-name" required>
                </div>
                <div class="form-group">
                    <label>Telefone</label>
                    <input type="text" id="customer-phone">
                </div>
                <div class="form-group">
                    <label>E-mail</label>
                    <input type="email" id="customer-email">
                </div>
                <div class="form-group">
                    <label>Origem</label>
                    <input type="text" id="customer-origin">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-modal="customer-modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="product-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="product-modal-title">Novo Produto</h2>
                <button class="modal-close" data-modal="product-modal" style="color: rgba(245, 243, 239, 0.6);">&times;</button>
            </div>
            <form id="product-form">
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                    <label>Nome *</label>
                    <input type="text" id="product-name" required>
                </div>
                    <div class="form-group" style="flex: 1;">
                    <label>Marca</label>
                    <input type="text" id="product-brand">
                </div>
                </div>
                
                <!-- Upload de Imagem -->
                <div class="form-group">
                    <label>Imagem do Produto</label>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <input type="file" id="product-image-input" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('product-image-input').click()">
                            <i class="fas fa-upload"></i> Escolher Imagem
                        </button>
                        <div id="product-image-preview" style="display: none;">
                            <img id="product-image-preview-img" src="" alt="Preview" style="max-width: 100px; max-height: 100px; border-radius: 8px; object-fit: cover;">
                            <button type="button" class="btn btn-sm btn-secondary" onclick="removeProductImage()" style="margin-left: 0.5rem;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <input type="hidden" id="product-image-base64">
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                    <label>Concentração</label>
                    <input type="text" id="product-concentration" placeholder="Ex: Eau de Parfum">
                </div>
                    <div class="form-group" style="flex: 1;">
                    <label>Volume</label>
                    <input type="text" id="product-volume" placeholder="Ex: 100ml">
                </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                    <label>Gênero/Sexo *</label>
                    <select id="product-gender" required>
                        <option value="">Selecione</option>
                        <option value="masculino">Masculino</option>
                        <option value="feminino">Feminino</option>
                        <option value="unissex">Unissex</option>
                    </select>
                </div>
                    <div class="form-group" style="flex: 1;">
                    <label>Lote</label>
                    <input type="text" id="product-batch" placeholder="Número do lote">
                </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                    <label>Origem</label>
                    <input type="text" id="product-origin" placeholder="País de origem">
                </div>
                    <div class="form-group" style="flex: 1;">
                    <label>Fragrância</label>
                    <input type="text" id="product-fragrance" placeholder="Descrição da fragrância">
                </div>
                </div>
                
                <!-- Catálogo de Fragrâncias -->
                <div style="background: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                    <h3 style="color: #D4AF37; margin-bottom: 1rem; font-size: 1rem;">Catálogo de Fragrâncias</h3>
                <div class="form-group">
                        <label>Notas de Topo</label>
                        <input type="text" id="product-notes-top" placeholder="Ex: Bergamota, Limão, Lavanda">
                    </div>
                    <div class="form-group">
                        <label>Notas de Coração</label>
                        <input type="text" id="product-notes-heart" placeholder="Ex: Rosa, Jasmim, Canela">
                    </div>
                    <div class="form-group">
                        <label>Notas de Base</label>
                        <input type="text" id="product-notes-base" placeholder="Ex: Sândalo, Baunilha, Âmbar">
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label>Família Olfativa</label>
                            <select id="product-fragrance-family">
                                <option value="">Selecione</option>
                                <option value="floral">Floral</option>
                                <option value="oriental">Oriental</option>
                                <option value="amadeirado">Amadeirado</option>
                                <option value="fresco">Fresco</option>
                                <option value="frutado">Frutado</option>
                                <option value="citrico">Cítrico</option>
                                <option value="especiado">Especiado</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Duração</label>
                            <select id="product-duration">
                                <option value="">Selecione</option>
                                <option value="curta">Curta (2-4h)</option>
                                <option value="media">Média (4-6h)</option>
                                <option value="longa">Longa (6-8h)</option>
                                <option value="muito-longa">Muito Longa (8h+)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label>Projeção</label>
                            <select id="product-projection">
                                <option value="">Selecione</option>
                                <option value="intima">Íntima</option>
                                <option value="moderada">Moderada</option>
                                <option value="forte">Forte</option>
                                <option value="muito-forte">Muito Forte</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Ocasião</label>
                            <select id="product-occasion">
                                <option value="">Selecione</option>
                                <option value="diurno">Diurno</option>
                                <option value="noturno">Noturno</option>
                                <option value="versatil">Versátil</option>
                                <option value="formal">Formal</option>
                                <option value="casual">Casual</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Descrição</label>
                        <textarea id="product-description" rows="3" placeholder="Descrição detalhada da fragrância..."></textarea>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                    <label>Preço *</label>
                    <input type="number" step="0.01" id="product-price" required>
                </div>
                    <div class="form-group" style="flex: 1;">
                    <label>Custo</label>
                    <input type="number" step="0.01" id="product-cost" placeholder="Para cálculo de margem">
                    </div>
                </div>
                <div class="form-group">
                    <label>Estoque</label>
                    <input type="number" id="product-stock" value="0">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-modal="product-modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="sale-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nova Venda</h2>
                <button class="modal-close" data-modal="sale-modal" style="color: rgba(245, 243, 239, 0.6);">&times;</button>
            </div>
            <form id="sale-form">
                <div class="form-group">
                    <label>Cliente</label>
                    <select id="sale-customer">
                        <option value="">Selecione</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Produtos</label>
                    <div id="sale-items"></div>
                    <button type="button" class="btn btn-secondary btn-sm" id="add-sale-item">
                        <i class="fas fa-plus"></i> Adicionar
                    </button>
                </div>
                <div class="form-group">
                    <label>Cupom de Desconto</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="sale-coupon-code" placeholder="Digite o código do cupom" style="flex: 1; text-transform: uppercase;">
                        <button type="button" class="btn btn-secondary" onclick="applyCoupon()">Aplicar</button>
                    </div>
                    <div id="coupon-message" style="margin-top: 0.5rem; font-size: 0.875rem;"></div>
                </div>
                <div class="sale-total">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Subtotal:</span>
                        <span id="sale-subtotal">R$ 0,00</span>
                    </div>
                    <div id="sale-discount-row" style="display: none; justify-content: space-between; margin-bottom: 0.5rem; color: #D4AF37;">
                        <span>Desconto:</span>
                        <span id="sale-discount">- R$ 0,00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 1.5rem; font-weight: 600; padding-top: 0.5rem; border-top: 1px solid rgba(212, 175, 55, 0.3);">
                        <span>Total:</span>
                        <span id="sale-total">R$ 0,00</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Como foi feita a venda</label>
                    <select id="sale-method">
                        <option value="presencial">Presencial</option>
                        <option value="online">Online</option>
                        <option value="telefone">Telefone</option>
                        <option value="whatsapp">WhatsApp</option>
                        <option value="email">E-mail</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
                <div class="form-group" id="sale-method-details-group" style="display: none;">
                    <label>Detalhes da venda</label>
                    <textarea id="sale-method-details" rows="2" placeholder="Descreva como foi feita a venda..."></textarea>
                </div>
                <div class="form-group">
                    <label>Forma de Pagamento</label>
                    <select id="sale-payment-type" onchange="togglePaymentFields()">
                        <option value="dinheiro">Dinheiro</option>
                        <option value="pix">PIX</option>
                        <option value="cartao">Cartão de Crédito/Débito</option>
                        <option value="fonte">Fonte</option>
                        <option value="promissoria">Promissória</option>
                    </select>
                </div>
                <div class="form-group" id="payment-installments-group" style="display: none;">
                    <label>Número de Parcelas</label>
                    <input type="number" id="sale-payment-installments" min="1" value="1" onchange="calculateInstallments()">
                </div>
                <div class="form-group" id="payment-due-date-group" style="display: none;">
                    <label>Data de Vencimento (Primeira Parcela)</label>
                    <input type="date" id="sale-payment-due-date">
                </div>
                <div class="form-group">
                    <label>Observações</label>
                    <textarea id="sale-notes" rows="2" placeholder="Observações adicionais..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-modal="sale-modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Finalizar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Sale Details Modal -->
    <div id="sale-details-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Detalhes da Venda</h2>
                <button class="modal-close" data-modal="sale-details-modal" style="color: rgba(245, 243, 239, 0.6);">&times;</button>
            </div>
            <div id="sale-details-content" style="padding: 1.5rem;">
                <!-- Conteúdo será preenchido dinamicamente -->
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" data-modal="sale-details-modal">Fechar</button>
                <button type="button" class="btn btn-success" id="btn-mark-paid-from-details" style="display: none; background: #10b981; color: white;">
                    <i class="fas fa-check"></i> Marcar como Pago
                </button>
                <button type="button" class="btn btn-primary" id="btn-generate-invoice-from-details" style="display: none;">
                    <i class="fas fa-file-invoice"></i> Gerar Cobrança
                </button>
            </div>
        </div>
    </div>

    <!-- Generate Invoice Modal -->
    <div id="invoice-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Gerar Cobrança</h2>
                <button class="modal-close" data-modal="invoice-modal" style="color: rgba(245, 243, 239, 0.6);">&times;</button>
            </div>
            <div id="invoice-content" style="padding: 1.5rem;">
                <div class="form-group">
                    <label>Tipo de Cobrança</label>
                    <select id="invoice-type">
                        <option value="all">Todas as Parcelas</option>
                        <option value="next">Próxima Parcela</option>
                        <option value="custom">Parcela Específica</option>
                    </select>
                </div>
                <div class="form-group" id="invoice-custom-parcel" style="display: none;">
                    <label>Número da Parcela</label>
                    <input type="number" id="invoice-parcel-number" min="1" value="1">
                </div>
                <div class="form-group">
                    <label>Formato</label>
                    <select id="invoice-format">
                        <option value="whatsapp">WhatsApp</option>
                        <option value="copy">Copiar Mensagem</option>
                        <option value="pdf">PDF</option>
                        <option value="print">Imprimir</option>
                        <option value="email">Enviar por E-mail</option>
                    </select>
                </div>
                <div id="invoice-message-preview" style="margin-top: 1rem; padding: 1rem; background: rgba(212, 175, 55, 0.1); border-radius: 8px; display: none;">
                    <h4 style="margin-bottom: 0.75rem; color: #D4AF37;">Preview da Mensagem:</h4>
                    <div id="invoice-message-content" style="white-space: pre-wrap; color: rgba(245, 243, 239, 0.9); line-height: 1.6;"></div>
                </div>
                <div id="invoice-preview" style="margin-top: 1rem; padding: 1rem; background: rgba(212, 175, 55, 0.1); border-radius: 8px; display: none;">
                    <!-- Preview da cobrança -->
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" data-modal="invoice-modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmGenerateInvoice()">
                    <i class="fas fa-file-invoice"></i> Gerar Cobrança
                </button>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="user-modal-title">Novo Usuário</h2>
                <button class="modal-close" data-modal="user-modal" style="color: rgba(245, 243, 239, 0.6);">&times;</button>
            </div>
            <form id="user-form">
                <div class="form-group">
                    <label>Nome *</label>
                    <input type="text" id="user-name-input" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="user-email-input" required>
                </div>
                <div class="form-group">
                    <label>Telefone</label>
                    <input type="text" id="user-phone-input" placeholder="(00) 00000-0000">
                </div>
                <div class="form-group">
                    <label>Perfil *</label>
                    <select id="user-role-input" required>
                        <option value="">Selecione</option>
                        <option value="admin">Administrador</option>
                        <option value="manager">Gerente</option>
                        <option value="seller">Vendedor</option>
                        <option value="viewer">Visualizador</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Senha *</label>
                    <input type="password" id="user-password-input" required>
                    <small style="color: rgba(245, 243, 239, 0.6); display: block; margin-top: 0.5rem;">
                        Mínimo 6 caracteres
                    </small>
                </div>
                <div class="form-group">
                    <label>Confirmar Senha *</label>
                    <input type="password" id="user-password-confirm-input" required>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="user-active-input" checked style="margin-right: 0.5rem;">
                        Usuário ativo
                    </label>
                </div>
                <input type="hidden" id="user-edit-id">
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-modal="user-modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Certificate Modal -->
    <div id="certificate-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Certificados de Autenticidade</h2>
                <button class="modal-close" data-modal="certificate-modal" style="color: rgba(245, 243, 239, 0.6);">&times;</button>
            </div>
            <div id="certificates-list" style="padding: 1.5rem;">
                <!-- Certificados serão listados aqui -->
            </div>
        </div>
    </div>

    <!-- Coupon Modal -->
    <div id="coupon-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="coupon-modal-title">Novo Cupom</h2>
                <button class="modal-close" data-modal="coupon-modal" style="color: rgba(245, 243, 239, 0.6);">&times;</button>
            </div>
            <form id="coupon-form">
                <div class="form-group">
                    <label>Código do Cupom *</label>
                    <input type="text" id="coupon-code" required placeholder="Ex: DESCONTO10" style="text-transform: uppercase;">
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label>Tipo de Desconto *</label>
                        <select id="coupon-type" required>
                            <option value="percentage">Percentual (%)</option>
                            <option value="fixed">Valor Fixo (R$)</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Valor do Desconto *</label>
                        <input type="number" step="0.01" id="coupon-value" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label>Data de Início</label>
                        <input type="date" id="coupon-start-date">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Data de Término *</label>
                        <input type="date" id="coupon-end-date" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label>Limite de Usos</label>
                        <input type="number" id="coupon-usage-limit" placeholder="Ilimitado se vazio">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Valor Mínimo da Compra</label>
                        <input type="number" step="0.01" id="coupon-min-purchase" placeholder="Sem mínimo">
                    </div>
                </div>
                <div class="form-group">
                    <label>Descrição</label>
                    <textarea id="coupon-description" rows="2" placeholder="Descrição da promoção..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-modal="coupon-modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loyalty Program Modal -->
    <div id="loyalty-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Configurar Programa de Fidelidade</h2>
                <button class="modal-close" data-modal="loyalty-modal" style="color: rgba(245, 243, 239, 0.6);">&times;</button>
            </div>
            <form id="loyalty-form">
                <div style="background: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <h3 style="color: #D4AF37; margin-bottom: 1rem; font-size: 1rem;">Configuração de Pontos</h3>
                    <div class="form-group">
                        <label>Pontos por Real Gasto</label>
                        <input type="number" step="0.1" id="loyalty-points-per-real" value="1" min="0">
                        <small style="color: rgba(245, 243, 239, 0.6);">Ex: 1 ponto para cada R$ 1,00 gasto</small>
                    </div>
                </div>
                
                <div style="background: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <h3 style="color: #D4AF37; margin-bottom: 1rem; font-size: 1rem;">Níveis do Programa</h3>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <span style="color: #CD7F32;">🥉</span>
                            <strong>Bronze</strong>
                        </label>
                        <input type="number" id="loyalty-bronze-min" placeholder="Pontos mínimos" style="width: 100%;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <span style="color: #C0C0C0;">🥈</span>
                            <strong>Prata</strong>
                        </label>
                        <input type="number" id="loyalty-silver-min" placeholder="Pontos mínimos" style="width: 100%;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <span style="color: #FFD700;">🥇</span>
                            <strong>Ouro</strong>
                        </label>
                        <input type="number" id="loyalty-gold-min" placeholder="Pontos mínimos" style="width: 100%;">
                    </div>
                    
                    <div>
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <span style="color: #D4AF37;">💎</span>
                            <strong>Platina</strong>
                        </label>
                        <input type="number" id="loyalty-platinum-min" placeholder="Pontos mínimos" style="width: 100%;">
                    </div>
                </div>
                
                <div style="background: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <h3 style="color: #D4AF37; margin-bottom: 1rem; font-size: 1rem;">Benefícios por Nível</h3>
                    <div class="form-group">
                        <label>Desconto Bronze (%)</label>
                        <input type="number" step="0.1" id="loyalty-bronze-discount" placeholder="0" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label>Desconto Prata (%)</label>
                        <input type="number" step="0.1" id="loyalty-silver-discount" placeholder="0" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label>Desconto Ouro (%)</label>
                        <input type="number" step="0.1" id="loyalty-gold-discount" placeholder="0" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label>Desconto Platina (%)</label>
                        <input type="number" step="0.1" id="loyalty-platinum-discount" placeholder="0" min="0" max="100">
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-modal="loyalty-modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Configuração</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuração do Supabase (única declaração)
        const SUPABASE_CONFIG = {
            url: 'https://zpqtcrfygjtjtacufgbv.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwcXRjcmZ5Z2p0anRhY3VmZ2J2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3MDY3MDAsImV4cCI6MjA4NDI4MjcwMH0.7p_Dtv7HBcBR9Mg6mDApjAWzZC10CdsnNU41yoHPsyo',
            storageBucket: 'product-images'
        };

        // Função para fazer requisições ao Supabase
        async function supabaseRequest(table, method = 'GET', data = null, filters = '') {
            try {
                const url = `${SUPABASE_CONFIG.url}/rest/v1/${table}${filters}`;
                const options = {
                    method: method,
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    }
                };

                if (data && (method === 'POST' || method === 'PATCH' || method === 'PUT')) {
                    options.body = JSON.stringify(data);
                }

                console.log(`📡 Requisição Supabase: ${method} ${table}`, data || filters);

                const response = await fetch(url, options);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`❌ Erro Supabase ${response.status}:`, errorText);
                    throw new Error(`Supabase Error: ${response.status} - ${errorText}`);
                }

                if (method === 'DELETE') {
                    return { success: true };
                }

                const result = await response.json();
                console.log(`✅ Resposta Supabase (${table}):`, result);
                return result;
            } catch (error) {
                console.error(`❌ Erro ao fazer requisição ao Supabase (${table}):`, error);
                throw error; // Re-throw para que o código que chama possa tratar
            }
        }

        // Dados - serão carregados do Supabase
            let customers = [];
            let products = [];
            let sales = [];
            let certificates = [];
            let users = JSON.parse(localStorage.getItem('users') || '[]'); // Users ainda em localStorage
            let appliedCoupon = null; // Variável global para cupom aplicado na venda
            let appSettings = JSON.parse(localStorage.getItem('appSettings') || '{}'); // Settings ainda em localStorage
            let coupons = [];
            let loyaltyProgram = {};
            let currentPage = 'dashboard'; // Página atual
            let currentUser = null; // Usuário atual (será definido após login)
            let useSupabase = true; // Flag para usar Supabase ou localStorage
            
            // Criar usuário admin padrão se não existir
            if (users.length === 0) {
                users = [{
                    id: 1,
                    name: 'Admin',
                    email: 'admin@cjemporium.com',
                    phone: '',
                    password: 'admin123', // Em produção, deve ser hash
                    role: 'admin',
                    isActive: true,
                    createdAt: new Date().toISOString()
                }];
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            // Inicializar currentUser
            // Não inicializar currentUser automaticamente - apenas no login
            // currentUser será definido apenas após login bem-sucedido
            
            // Remover duplicatas de produtos ao carregar (por ID, nome+marca, ou nome se não tiver marca)
            if (products.length > 0) {
                const uniqueProducts = [];
                const seenIds = new Set();
                const seenProducts = new Set(); // Para verificar nome+marca
                
                products.forEach(product => {
                    // Criar chave única: ID ou nome+marca
                    const productKey = product.id 
                        ? `id:${product.id}` 
                        : `name:${(product.name || '').toLowerCase().trim()}_brand:${(product.brand || '').toLowerCase().trim()}`;
                    
                    if (!seenProducts.has(productKey)) {
                        seenProducts.add(productKey);
                        if (product.id) {
                        seenIds.add(product.id);
                        }
                        uniqueProducts.push(product);
                    }
                });
                
                if (uniqueProducts.length !== products.length) {
                    products = uniqueProducts;
                    localStorage.setItem('products', JSON.stringify(products));
                    console.log(`Removidas ${products.length - uniqueProducts.length} duplicatas de produtos`);
                }
            }
            
            // Calcular dias na coluna e follow-ups vencidos
            function updateCustomerMetrics() {
                const now = new Date();
                customers.forEach(customer => {
                    // Calcular dias na coluna atual
                    if (customer.created_at) {
                        const created = new Date(customer.created_at);
                        customer.days_in_current_column = Math.floor(
                            (now - created) / (1000 * 60 * 60 * 24)
                        );
                    } else {
                        customer.days_in_current_column = 0;
                    }
                    
                    // Verificar follow-up vencido
                    if (customer.next_followup_date) {
                        const followupDate = new Date(customer.next_followup_date);
                        customer.followup_overdue = followupDate < now;
                    } else {
                        customer.followup_overdue = false;
                    }
                });
            }
            
            // Atualizar métricas periodicamente
            updateCustomerMetrics();
            setInterval(updateCustomerMetrics, 60000); // Atualizar a cada minuto
            let kanbanColumns = [
            { id: 1, name: 'Novo Lead', color: '#D4AF37', customers: [] },
            { id: 2, name: 'Contato Realizado', color: '#B88A44', customers: [] },
            { id: 3, name: 'Em Negociação', color: '#D4AF37', customers: [] },
            { id: 4, name: 'Aguardando Retorno', color: '#B88A44', customers: [] },
            { id: 5, name: 'Venda Concluída', color: '#D4AF37', customers: [] },
            { id: 6, name: 'Pós-venda', color: '#B88A44', customers: [] },
            { id: 7, name: 'Perdido', color: '#2B2B2B', customers: [] }
        ];

        // Função para aplicar configurações de aparência
        function applyAppearanceSettings() {
            const body = document.body;
            
            // Remover classes anteriores
            body.classList.remove('theme-light', 'theme-dark', 'theme-auto');
            body.classList.remove('density-compact', 'density-comfortable', 'density-spacious');
            body.classList.remove('no-animations');
            
            // Aplicar tema
            const theme = appSettings.theme || 'dark';
            if (theme === 'auto') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                body.classList.add(prefersDark ? 'theme-dark' : 'theme-light');
            } else {
                body.classList.add(`theme-${theme}`);
            }
            
            // Aplicar densidade
            const density = appSettings.density || 'comfortable';
            if (density !== 'comfortable') {
                body.classList.add(`density-${density}`);
            }
            
            // Aplicar animações
            if (appSettings.showAnimations === false) {
                body.classList.add('no-animations');
            }
        }

        // Função para remover duplicatas de produtos
        function removeDuplicateProducts() {
            if (products.length === 0) return false;
            
            const uniqueProducts = [];
            const seenIds = new Set();
            const seenNameBrand = new Map(); // Chave: nome+marca, Valor: índice no uniqueProducts
            
            products.forEach(product => {
                if (!product.name) {
                    // Produtos sem nome são ignorados
                    return;
                }
                
                // Criar chave única: nome + marca (case insensitive)
                const nameKey = `${(product.name || '').toLowerCase().trim()}_${(product.brand || '').toLowerCase().trim()}`;
                
                // Verificar duplicata por ID
                if (product.id && seenIds.has(product.id)) {
                    return; // ID duplicado, ignorar
                }
                
                // Verificar duplicata por nome+marca
                if (seenNameBrand.has(nameKey)) {
                    // Já existe produto com mesmo nome+marca
                    const existingIndex = seenNameBrand.get(nameKey);
                    const existing = uniqueProducts[existingIndex];
                    
                    // Prioridade: manter o que tem ID, ou o primeiro se ambos têm/não têm ID
                    if (product.id && !existing.id) {
                        // Substituir o sem ID pelo com ID
                        uniqueProducts[existingIndex] = product;
                        seenIds.add(product.id);
                    } else if (!product.id && existing.id) {
                        // Manter o existente que tem ID
                        return;
                    } else {
                        // Ambos têm ou não têm ID, manter o primeiro (já está no array)
                        return;
                    }
                } else {
                    // Novo produto único
                    if (product.id) {
                        seenIds.add(product.id);
                    }
                    seenNameBrand.set(nameKey, uniqueProducts.length);
                    uniqueProducts.push(product);
                }
            });
            
            // Se houve remoção de duplicatas, atualizar
            if (uniqueProducts.length !== products.length) {
                const removed = products.length - uniqueProducts.length;
                products = uniqueProducts;
                saveData();
                console.log(`✅ Removidas ${removed} duplicatas de produtos`);
                return true; // Indica que houve remoção
            }
            return false;
        }

        // Função para recarregar dados do localStorage
        function reloadDataFromStorage() {
            try {
                const savedCustomers = localStorage.getItem('customers');
                const savedProducts = localStorage.getItem('products');
                const savedSales = localStorage.getItem('sales');
                const savedCertificates = localStorage.getItem('certificates');
                const savedUsers = localStorage.getItem('users');
                const savedSettings = localStorage.getItem('appSettings');
                const savedCoupons = localStorage.getItem('coupons');
                const savedLoyalty = localStorage.getItem('loyaltyProgram');
                
                if (savedCustomers) customers = JSON.parse(savedCustomers);
                if (savedProducts) {
                    products = JSON.parse(savedProducts);
                    // Remover duplicatas ao carregar
                    removeDuplicateProducts();
                }
                if (savedSales) sales = JSON.parse(savedSales);
                if (savedCertificates) certificates = JSON.parse(savedCertificates);
                if (savedUsers) users = JSON.parse(savedUsers);
                if (savedSettings) appSettings = JSON.parse(savedSettings);
                if (savedCoupons) coupons = JSON.parse(savedCoupons);
                if (savedLoyalty) loyaltyProgram = JSON.parse(savedLoyalty);
                
                // Atualizar métricas dos clientes
                updateCustomerMetrics();
            } catch (e) {
                console.error('Erro ao recarregar dados:', e);
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', async () => {
            // Carregar dados do Supabase (com fallback para localStorage)
            if (useSupabase) {
                await loadDataFromSupabase();
            } else {
                reloadDataFromStorage();
            }
            
            // Carregar usuário do localStorage se existir
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                } catch (e) {
                    currentUser = null;
                    localStorage.removeItem('currentUser');
                }
            }
            
            // Aplicar configurações de aparência ao carregar
            applyAppearanceSettings();
            
            // Atualizar informações do usuário no sidebar
            if (currentUser) {
                document.getElementById('user-name').textContent = currentUser.name || 'Admin';
                document.getElementById('user-role').textContent = getRoleName(currentUser.role || 'admin');
            }
            
            loadKanbanData();
            setupEventListeners();
            if (localStorage.getItem('loggedIn') === 'true' && currentUser) {
                // Aplicar permissões ao carregar
                applyPermissions();
                showApp();
                loadPage('dashboard');
            } else {
                showLogin();
            }
            
            // Recarregar dados quando a página ganha foco (útil para sincronização entre abas)
            window.addEventListener('focus', () => {
                reloadDataFromStorage();
                if (currentPage === 'customers') {
                    loadKanban();
                    loadCustomers();
                } else if (currentPage === 'products') {
                    loadProducts();
                } else if (currentPage === 'sales') {
                    loadSales();
                } else if (currentPage === 'dashboard') {
                    loadDashboard();
                }
            });
        });

        function setupEventListeners() {
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const errorDiv = document.getElementById('login-error');
                
                // Buscar usuário
                const user = users.find(u => u.email === email && u.isActive !== false);
                
                if (!user) {
                    errorDiv.textContent = 'Email ou senha incorretos!';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                // Validar senha (em produção, usar hash)
                if (user.password !== password) {
                    errorDiv.textContent = 'Email ou senha incorretos!';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                // Login bem-sucedido
                currentUser = {
                    id: user.id,
                    name: user.name,
                    email: user.email,
                    phone: user.phone || '',
                    role: user.role
                };
                
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.setItem('loggedIn', 'true');
                
                // Atualizar sidebar
                document.getElementById('user-name').textContent = currentUser.name;
                document.getElementById('user-role').textContent = getRoleName(currentUser.role);
                
                // Aplicar permissões
                applyPermissions();
                
                errorDiv.style.display = 'none';
                showApp();
                loadPage('dashboard');
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                if (confirm('Deseja realmente sair?')) {
                    localStorage.setItem('loggedIn', 'false');
                    currentUser = null;
                    localStorage.removeItem('currentUser');
                    // Limpar formulário de login
                    document.getElementById('login-form').reset();
                    document.getElementById('email').value = '';
                    document.getElementById('password').value = '';
                    document.getElementById('login-error').style.display = 'none';
                    showLogin();
                }
            });

            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    loadPage(item.dataset.page);
                });
            });

            document.getElementById('add-customer-form-btn')?.addEventListener('click', () => openModal('customer-modal'));
            document.getElementById('add-product-btn')?.addEventListener('click', () => {
                editingProductId = null;
                document.getElementById('product-form').reset();
                document.getElementById('product-image-base64').value = '';
                document.getElementById('product-image-preview').style.display = 'none';
                document.getElementById('product-image-input').value = '';
                document.getElementById('product-modal-title').textContent = 'Novo Produto';
                selectedImageFile = null;
                openModal('product-modal');
            });
            document.getElementById('add-coupon-btn')?.addEventListener('click', () => {
                document.getElementById('coupon-modal-title').textContent = 'Novo Cupom';
                document.getElementById('coupon-form').reset();
                openModal('coupon-modal');
            });
            document.getElementById('configure-loyalty-btn')?.addEventListener('click', () => {
                loadLoyaltyConfig();
                openModal('loyalty-modal');
            });
            
            // Menu hambúrguer mobile
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const sidebar = document.querySelector('.sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            
            if (mobileMenuToggle && sidebar && sidebarOverlay) {
                // Função para toggle do menu
                const toggleSidebar = () => {
                    sidebar.classList.toggle('active');
                    sidebarOverlay.classList.toggle('active');
                    mobileMenuToggle.classList.toggle('active');
                    document.body.classList.toggle('menu-open');
                };
                
                // Fechar menu ao clicar no overlay
                sidebarOverlay.addEventListener('click', () => {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                    mobileMenuToggle.classList.remove('active');
                    document.body.classList.remove('menu-open');
                });
                
                // Fechar menu ao clicar em um link
                const navItems = sidebar.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    item.addEventListener('click', () => {
                        if (window.innerWidth <= 768) {
                            sidebar.classList.remove('active');
                            sidebarOverlay.classList.remove('active');
                            mobileMenuToggle.classList.remove('active');
                            document.body.classList.remove('menu-open');
                        }
                    });
                });
                
                // Função única para toggle do menu
                mobileMenuToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    
                    // Recarregar dados quando o menu mobile é aberto
                    if (typeof reloadDataFromStorage === 'function') {
                        reloadDataFromStorage();
                    }
                    // Aplicar permissões novamente para garantir que os itens apareçam
                    if (typeof applyPermissions === 'function') {
                        applyPermissions();
                    }
                    
                    toggleSidebar();
                });
                
                // Fechar menu ao redimensionar para desktop
                let resizeTimer;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => {
                        if (window.innerWidth > 768) {
                            sidebar.classList.remove('active');
                            sidebarOverlay.classList.remove('active');
                            mobileMenuToggle.classList.remove('active');
                            document.body.classList.remove('menu-open');
                        }
                    }, 100);
                });
            }
            
            // Garantir que todos os botões sejam clicáveis
            // Corrigir problema de overlay bloqueando cliques
            document.addEventListener('DOMContentLoaded', function() {
                // Garantir que o overlay só bloqueie quando ativo
                const sidebarOverlay = document.getElementById('sidebar-overlay');
                if (sidebarOverlay && !sidebarOverlay.classList.contains('active')) {
                    sidebarOverlay.style.pointerEvents = 'none';
                    sidebarOverlay.style.display = 'none';
                }
                
                // Garantir que todos os botões tenham pointer-events: auto
                const allButtons = document.querySelectorAll('button, .btn, [onclick]');
                allButtons.forEach(btn => {
                    btn.style.pointerEvents = 'auto';
                    btn.style.cursor = 'pointer';
                    btn.style.zIndex = '10';
                });
                
                // Observar mudanças no DOM para aplicar correções em botões dinâmicos
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1) { // Element node
                                const buttons = node.querySelectorAll ? node.querySelectorAll('button, .btn, [onclick]') : [];
                                buttons.forEach(btn => {
                                    btn.style.pointerEvents = 'auto';
                                    btn.style.cursor = 'pointer';
                                    btn.style.zIndex = '10';
                                });
                                if (node.tagName === 'BUTTON' || node.classList.contains('btn') || node.hasAttribute('onclick')) {
                                    node.style.pointerEvents = 'auto';
                                    node.style.cursor = 'pointer';
                                    node.style.zIndex = '10';
                                }
                            }
                        });
                    });
                });
                
                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });
            });
            
            document.getElementById('add-sale-btn')?.addEventListener('click', () => {
                openModal('sale-modal');
                loadSaleForm();
            });
            document.getElementById('add-user-btn')?.addEventListener('click', () => {
                document.getElementById('user-modal-title').textContent = 'Novo Usuário';
                document.getElementById('user-edit-id').value = '';
                document.getElementById('user-form').reset();
                document.getElementById('user-password-input').required = true;
                document.getElementById('user-password-confirm-input').required = true;
                document.getElementById('user-active-input').checked = true;
                openModal('user-modal');
            });

            // Event listeners para busca e filtros de clientes
            const customerSearch = document.getElementById('customer-search');
            const customerFilterStatus = document.getElementById('customer-filter-status');
            const customerFilterFollowup = document.getElementById('customer-filter-followup');
            const clearFiltersBtn = document.getElementById('clear-filters');

            if (customerSearch) {
                customerSearch.addEventListener('input', () => {
                    if (currentPage === 'customers') {
                        loadKanban();
                        loadCustomers();
                    }
                });
            }

            if (customerFilterStatus) {
                customerFilterStatus.addEventListener('change', () => {
                    if (currentPage === 'customers') {
                        loadKanban();
                        loadCustomers();
                    }
                });
            }

            if (customerFilterFollowup) {
                customerFilterFollowup.addEventListener('change', () => {
                    if (currentPage === 'customers') {
                        loadKanban();
                        loadCustomers();
                    }
                });
            }

            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', () => {
                    if (customerSearch) customerSearch.value = '';
                    if (customerFilterStatus) customerFilterStatus.value = '';
                    if (customerFilterFollowup) customerFilterFollowup.value = '';
                    if (currentPage === 'customers') {
                        loadKanban();
                        loadCustomers();
                    }
                });
            }

            document.querySelectorAll('.modal-close, [data-modal]').forEach(btn => {
                if (btn.type === 'button' || btn.classList.contains('modal-close')) {
                    btn.addEventListener('click', () => {
                        const modalId = btn.dataset.modal || btn.closest('.modal')?.id;
                        if (modalId) closeModal(modalId);
                    });
                }
            });

            document.getElementById('customer-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const customerData = {
                    name: document.getElementById('customer-name').value,
                    phone: document.getElementById('customer-phone').value || null,
                    email: document.getElementById('customer-email').value || null,
                    origin: document.getElementById('customer-origin').value || null,
                    status: 'lead',
                    kanban_column_id: 1,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                try {
                    if (useSupabase) {
                        // Salvar no Supabase
                        const newCustomer = await supabaseRequest('customers', 'POST', customerData);
                        if (newCustomer) {
                            const savedCustomer = Array.isArray(newCustomer) ? newCustomer[0] : newCustomer;
                            customers.push(savedCustomer);
                            console.log('✅ Cliente salvo no Supabase:', savedCustomer);
                            alert('Cliente criado com sucesso!');
                        } else {
                            throw new Error('Erro ao salvar cliente no Supabase');
                        }
                    } else {
                        // Salvar no localStorage
                        const customer = {
                            ...customerData,
                            id: Date.now(),
                            kanbanColumnId: 1,
                            tags: [],
                            next_followup_date: null,
                            followup_overdue: false,
                            days_in_current_column: 0,
                            total_sales: 0,
                            is_recurring: false,
                            contacts: []
                        };
                        customers.push(customer);
                        saveData();
                        alert('Cliente criado com sucesso!');
                    }
                    
                    // Recarregar dados do Supabase se necessário
                    if (useSupabase) {
                        await loadDataFromSupabase();
                    }
                    
                    closeModal('customer-modal');
                    document.getElementById('customer-form').reset();
                    loadCustomers();
                    loadKanban();
                    loadDashboard();
                } catch (error) {
                    console.error('Erro ao criar cliente:', error);
                    alert('Erro ao criar cliente: ' + (error.message || 'Erro desconhecido'));
                }
            });

            // Variável para controlar se está editando
            let editingProductId = null;

            document.getElementById('product-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Desabilitar botão de submit durante upload
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
                
                try {
                const price = parseFloat(document.getElementById('product-price').value);
                const cost = document.getElementById('product-cost').value ? 
                    parseFloat(document.getElementById('product-cost').value) : null;
                
                    // Processar imagem
                    let imageUrl = null;
                    if (selectedImageFile) {
                        // Se está editando, usar o ID existente, senão gerar um temporário
                        const tempId = editingProductId || Date.now();
                        imageUrl = await uploadImageToSupabase(selectedImageFile, tempId);
                    } else if (document.getElementById('product-image-base64').value) {
                        // Se já tem base64 (imagem antiga), manter
                        imageUrl = document.getElementById('product-image-base64').value;
                    }
                    
                    const productData = {
                    name: document.getElementById('product-name').value,
                    brand: document.getElementById('product-brand').value,
                    concentration: document.getElementById('product-concentration').value || '',
                    volume: document.getElementById('product-volume').value || '',
                    batch: document.getElementById('product-batch').value || '',
                    origin: document.getElementById('product-origin').value || '',
                    gender: document.getElementById('product-gender').value || null,
                    fragrance: document.getElementById('product-fragrance').value || null,
                    price: price,
                    cost: cost,
                        stock: parseInt(document.getElementById('product-stock').value) || 0,
                        // Imagem - salvar apenas URL do Supabase (Storage)
                        image: imageUrl,
                        image_url: imageUrl && imageUrl.startsWith('http') ? imageUrl : null, // URL do Supabase Storage
                        // image_base64 removido - não existe no banco, usar apenas image_url
                    // Catálogo de Fragrâncias
                    fragrance: {
                        notesTop: document.getElementById('product-notes-top').value || '',
                        notesHeart: document.getElementById('product-notes-heart').value || '',
                        notesBase: document.getElementById('product-notes-base').value || '',
                        family: document.getElementById('product-fragrance-family').value || '',
                        duration: document.getElementById('product-duration').value || '',
                        projection: document.getElementById('product-projection').value || '',
                        occasion: document.getElementById('product-occasion').value || '',
                        description: document.getElementById('product-description').value || ''
                    }
                };
                
                if (editingProductId) {
                    // Editar produto existente
                    if (useSupabase) {
                        try {
                            // Preparar dados para atualização no Supabase
                            const supabaseUpdate = {
                                name: productData.name,
                                brand: productData.brand || null,
                                concentration: productData.concentration || null,
                                volume: productData.volume || null,
                                batch: productData.batch || null,
                                origin: productData.origin || null,
                                gender: productData.gender || null,
                                fragrance: productData.fragrance ? JSON.stringify(productData.fragrance) : null,
                                price: productData.price,
                                cost: productData.cost || null,
                                stock_quantity: productData.stock || 0,
                                image_url: productData.image_url || null,
                                // image_base64 removido - coluna não existe na tabela
                                updated_at: new Date().toISOString()
                            };

                            console.log('💾 Atualizando produto no Supabase...', supabaseUpdate);
                            
                            // Atualizar no Supabase
                            const updatedProduct = await supabaseRequest('products', 'PATCH', supabaseUpdate, `?id=eq.${editingProductId}`);
                            
                            if (updatedProduct) {
                                console.log('✅ Produto atualizado no Supabase');
                                
                                // Recarregar produtos do Supabase
                                await loadDataFromSupabase();
                                
                                closeModal('product-modal');
                                loadProducts();
                                editingProductId = null;
                                selectedImageFile = null;
                                
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                                
                                alert('✅ Produto atualizado com sucesso!');
                            } else {
                                throw new Error('Produto não foi atualizado no Supabase');
                            }
                        } catch (error) {
                            console.error('❌ Erro ao atualizar produto no Supabase:', error);
                            
                            // Fallback: atualizar localmente
                            const productIndex = products.findIndex(p => p.id === editingProductId);
                            if (productIndex !== -1) {
                                products[productIndex] = {
                                    ...products[productIndex],
                                    ...productData,
                                    id: editingProductId
                                };
                                saveData();
                                closeModal('product-modal');
                                loadProducts();
                                editingProductId = null;
                                selectedImageFile = null;
                                
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                                
                                alert('⚠️ Produto atualizado localmente. Erro ao conectar com Supabase.');
                            } else {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                            }
                        }
                    } else {
                        // Modo localStorage apenas
                        const productIndex = products.findIndex(p => p.id === editingProductId);
                        if (productIndex !== -1) {
                            const existingProduct = products.find(p => 
                                p.id !== editingProductId &&
                                p.name && productData.name &&
                                p.name.toLowerCase().trim() === productData.name.toLowerCase().trim() && 
                                ((!p.brand && !productData.brand) || (p.brand && productData.brand && p.brand.toLowerCase().trim() === productData.brand.toLowerCase().trim()))
                            );
                            
                            if (existingProduct) {
                                alert(`Já existe outro produto com este nome e marca!\n\nProduto existente: ${existingProduct.name}${existingProduct.brand ? ' - ' + existingProduct.brand : ''}`);
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                                return;
                            }
                            
                            products[productIndex] = {
                                ...products[productIndex],
                                ...productData,
                                id: editingProductId
                            };
                            saveData();
                            closeModal('product-modal');
                            loadProducts();
                            editingProductId = null;
                            selectedImageFile = null;
                            
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalText;
                        }
                    }
                } else {
                    // Criar novo produto
                    if (useSupabase) {
                        try {
                            // Preparar dados para o Supabase
                            const supabaseProduct = {
                                name: productData.name,
                                brand: productData.brand || null,
                                description: null,
                                concentration: productData.concentration || null,
                                volume: productData.volume || null,
                                batch: productData.batch || null,
                                origin: productData.origin || null,
                                gender: productData.gender || null,
                                fragrance: productData.fragrance ? JSON.stringify(productData.fragrance) : null,
                                price: productData.price,
                                cost: productData.cost || null,
                                stock_quantity: productData.stock || 0,
                                image_url: productData.image_url || null,
                                // image_base64 removido - coluna não existe na tabela
                                is_active: true,
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            };

                            console.log('💾 Salvando produto no Supabase...', supabaseProduct);
                            
                            // Salvar no Supabase
                            let newProduct;
                            try {
                                newProduct = await supabaseRequest('products', 'POST', supabaseProduct);
                                console.log('📦 Resposta do Supabase:', newProduct);
                            } catch (reqError) {
                                console.error('❌ Erro na requisição:', reqError);
                                throw reqError;
                            }
                            
                            if (newProduct && (Array.isArray(newProduct) ? newProduct.length > 0 : newProduct.id)) {
                                const savedProduct = Array.isArray(newProduct) ? newProduct[0] : newProduct;
                                console.log('✅ Produto salvo no Supabase:', savedProduct);
                                
                                // Recarregar produtos do Supabase
                                await loadDataFromSupabase();
                                
                                closeModal('product-modal');
                                await loadProducts();
                                selectedImageFile = null;
                                
                                // Reabilitar botão
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                                
                                alert('✅ Produto salvo com sucesso no Supabase!');
                            } else {
                                console.error('❌ Produto não foi retornado corretamente:', newProduct);
                                throw new Error('Produto não foi retornado pelo Supabase. Verifique o console para mais detalhes.');
                            }
                        } catch (error) {
                            console.error('❌ Erro ao salvar produto no Supabase:', error);
                            
                            // Fallback: salvar localmente
                            console.log('⚠️ Usando localStorage como fallback...');
                            const product = {
                                id: Date.now(),
                                ...productData
                            };
                            
                            const existingProduct = products.find(p => 
                                p.name && product.name &&
                                p.name.toLowerCase().trim() === product.name.toLowerCase().trim() && 
                                ((!p.brand && !product.brand) || (p.brand && product.brand && p.brand.toLowerCase().trim() === product.brand.toLowerCase().trim()))
                            );
                            
                            if (existingProduct) {
                                alert(`Já existe um produto com este nome e marca!\n\nProduto existente: ${existingProduct.name}${existingProduct.brand ? ' - ' + existingProduct.brand : ''}`);
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                                return;
                            }
                            
                            products.push(product);
                            saveData();
                            closeModal('product-modal');
                            loadProducts();
                            selectedImageFile = null;
                            
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalText;
                            
                            alert('⚠️ Produto salvo localmente. Erro ao conectar com Supabase:\n' + error.message);
                        }
                    } else {
                        // Modo localStorage apenas
                        const product = {
                            id: Date.now(),
                            ...productData
                        };
                        
                        const existingProduct = products.find(p => 
                            p.name && product.name &&
                            p.name.toLowerCase().trim() === product.name.toLowerCase().trim() && 
                            ((!p.brand && !product.brand) || (p.brand && product.brand && p.brand.toLowerCase().trim() === product.brand.toLowerCase().trim()))
                        );
                        
                        if (existingProduct) {
                            alert(`Já existe um produto com este nome e marca!\n\nProduto existente: ${existingProduct.name}${existingProduct.brand ? ' - ' + existingProduct.brand : ''}`);
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalText;
                            return;
                        }
                        
                        products.push(product);
                        saveData();
                        closeModal('product-modal');
                        loadProducts();
                        selectedImageFile = null;
                        
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                }
                
                // Reabilitar botão
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                } catch (error) {
                    console.error('Erro ao salvar produto:', error);
                    alert('Erro ao salvar produto. Tente novamente.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            });

            // Função para editar produto
            window.editProduct = function(productId) {
                const product = products.find(p => p.id === productId);
                if (!product) return;
                
                editingProductId = productId;
                
                // Preencher formulário
                document.getElementById('product-name').value = product.name || '';
                document.getElementById('product-brand').value = product.brand || '';
                document.getElementById('product-concentration').value = product.concentration || '';
                document.getElementById('product-volume').value = product.volume || '';
                document.getElementById('product-batch').value = product.batch || '';
                document.getElementById('product-origin').value = product.origin || '';
                document.getElementById('product-gender').value = product.gender || '';
                // Campo de fragrância simples (descrição)
                let fragranceDesc = '';
                if (product.fragrance) {
                    if (typeof product.fragrance === 'string' && product.fragrance.startsWith('{')) {
                        try {
                            const fragObj = JSON.parse(product.fragrance);
                            fragranceDesc = fragObj.description || '';
                        } catch (e) {
                            fragranceDesc = '';
                        }
                    } else if (typeof product.fragrance === 'object' && product.fragrance.description) {
                        fragranceDesc = product.fragrance.description;
                    } else if (typeof product.fragrance === 'string') {
                        fragranceDesc = product.fragrance;
                    }
                }
                document.getElementById('product-fragrance').value = fragranceDesc;
                document.getElementById('product-price').value = product.price || '';
                document.getElementById('product-cost').value = product.cost || '';
                document.getElementById('product-stock').value = product.stock || 0;
                
                // Imagem - usar apenas URL do Supabase Storage
                const imageUrl = product.image_url || product.image;
                if (imageUrl) {
                    document.getElementById('product-image-base64').value = imageUrl;
                    document.getElementById('product-image-preview-img').src = imageUrl;
                    document.getElementById('product-image-preview').style.display = 'flex';
                } else {
                    document.getElementById('product-image-base64').value = '';
                    document.getElementById('product-image-preview').style.display = 'none';
                }
                selectedImageFile = null;
                
                // Fragrâncias - fazer parse se for string JSON
                let fragranceData = product.fragrance;
                if (typeof fragranceData === 'string' && fragranceData.startsWith('{')) {
                    try {
                        fragranceData = JSON.parse(fragranceData);
                    } catch (e) {
                        fragranceData = null;
                    }
                }
                
                if (fragranceData && typeof fragranceData === 'object') {
                    document.getElementById('product-notes-top').value = fragranceData.notesTop || '';
                    document.getElementById('product-notes-heart').value = fragranceData.notesHeart || '';
                    document.getElementById('product-notes-base').value = fragranceData.notesBase || '';
                    document.getElementById('product-fragrance-family').value = fragranceData.family || '';
                    document.getElementById('product-duration').value = fragranceData.duration || '';
                    document.getElementById('product-projection').value = fragranceData.projection || '';
                    document.getElementById('product-occasion').value = fragranceData.occasion || '';
                    document.getElementById('product-description').value = fragranceData.description || '';
                }
                
                // Atualizar título do modal
                document.getElementById('product-modal-title').textContent = 'Editar Produto';
                
                // Abrir modal
                openModal('product-modal');
            };

            // Função para excluir produto
            window.deleteProduct = async function(productId) {
                const product = products.find(p => p.id === productId);
                if (!product) return;
                
                if (confirm(`Tem certeza que deseja excluir o produto "${product.name}"?\n\nEsta ação não pode ser desfeita!`)) {
                    // Verificar se o produto está em alguma venda
                    const productInSales = sales.some(sale => 
                        sale.items && sale.items.some(item => item.productId === productId)
                    );
                    
                    if (productInSales) {
                        if (!confirm('Este produto está associado a vendas. Deseja realmente excluí-lo?\n\nO produto será removido, mas as vendas serão mantidas.')) {
                            return;
                        }
                    }
                    
                    if (useSupabase) {
                        try {
                            // Deletar no Supabase (marcar como inativo ao invés de deletar)
                            await supabaseRequest('products', 'PATCH', {
                                is_active: false,
                                updated_at: new Date().toISOString()
                            }, `?id=eq.${productId}`);
                            
                            console.log('✅ Produto desativado no Supabase');
                            await loadDataFromSupabase();
                            loadProducts();
                            loadDashboard();
                        } catch (error) {
                            console.error('Erro ao deletar produto no Supabase:', error);
                            // Fallback: remover localmente
                            products = products.filter(p => p.id !== productId);
                            saveData();
                            loadProducts();
                            loadDashboard();
                        }
                    } else {
                        products = products.filter(p => p.id !== productId);
                        saveData();
                        loadProducts();
                        loadDashboard();
                    }
                }
            };
            
            // SUPABASE_CONFIG já foi declarado acima, não precisa redeclarar

            // Função para comprimir imagem
            function compressImage(file, maxWidth = 800, quality = 0.7) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            
                            // Redimensionar se necessário
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Converter para base64 com qualidade reduzida
                            const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                            resolve(compressedBase64);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }

            // Função para fazer upload de imagem para o Supabase Storage
            async function uploadImageToSupabase(file, productId) {
                try {
                    // Validar tamanho do arquivo (máximo 2MB antes de compressão)
                    if (file.size > 2 * 1024 * 1024) {
                        console.warn('Arquivo muito grande, comprimindo...');
                    }

                    const fileExt = file.name.split('.').pop();
                    const fileName = `${productId}_${Date.now()}.${fileExt}`;
                    const filePath = `${fileName}`;

                    // Comprimir imagem antes de fazer upload
                    const compressedBase64 = await compressImage(file, 800, 0.7);
                    
                    // Converter base64 para blob
                    const base64Response = await fetch(compressedBase64);
                    const blob = await base64Response.blob();
                    
                    // URL correta para upload no Supabase Storage
                    const uploadUrl = `${SUPABASE_CONFIG.url}/storage/v1/object/${SUPABASE_CONFIG.storageBucket}/${filePath}`;
                    
                    // Tentar upload com método correto
                    const response = await fetch(uploadUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Content-Type': blob.type || 'image/jpeg',
                            'x-upsert': 'true'
                        },
                        body: blob
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.warn('⚠️ Upload para Supabase falhou:', errorText);
                        console.info('💡 Usando base64 comprimido (reduzido para economizar espaço)');
                        // Retornar base64 comprimido (já foi comprimido acima)
                        return compressedBase64;
                    }

                    // Retornar URL pública da imagem
                    const imageUrl = `${SUPABASE_CONFIG.url}/storage/v1/object/public/${SUPABASE_CONFIG.storageBucket}/${filePath}`;
                    console.log('Imagem enviada com sucesso:', imageUrl);
                    return imageUrl;
                } catch (error) {
                    console.error('Erro ao fazer upload da imagem:', error);
                    // Fallback para base64 comprimido
                    try {
                        const compressedBase64 = await compressImage(file, 600, 0.6);
                        return compressedBase64;
                    } catch (compressError) {
                        console.error('Erro ao comprimir imagem:', compressError);
                        // Último recurso: base64 sem compressão (mas avisar)
                        const reader = new FileReader();
                        return new Promise((resolve) => {
                            reader.onload = function(e) {
                                const base64 = e.target.result;
                                // Verificar tamanho
                                if (base64.length > 500000) { // ~500KB
                                    console.warn('⚠️ Imagem muito grande! Considere usar imagens menores.');
                                }
                                resolve(base64);
                            };
                            reader.readAsDataURL(file);
                        });
                    }
                }
            }

            // Variável para armazenar arquivo selecionado
            let selectedImageFile = null;

            // Funções para upload de imagem
            window.handleImageUpload = async function(event) {
                const file = event.target.files[0];
                if (file) {
                    selectedImageFile = file;
                    
                    // Mostrar preview imediatamente
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const base64 = e.target.result;
                        document.getElementById('product-image-preview-img').src = base64;
                        document.getElementById('product-image-preview').style.display = 'flex';
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            window.removeProductImage = function() {
                document.getElementById('product-image-base64').value = '';
                document.getElementById('product-image-preview').style.display = 'none';
                document.getElementById('product-image-input').value = '';
                selectedImageFile = null;
            };

            window.applyCoupon = function() {
                const code = document.getElementById('sale-coupon-code').value.toUpperCase();
                const messageDiv = document.getElementById('coupon-message');
                
                if (!code) {
                    messageDiv.innerHTML = '<span style="color: #ef4444;">Digite um código de cupom</span>';
                    return;
                }
                
                const coupon = coupons.find(c => c.code === code);
                if (!coupon) {
                    messageDiv.innerHTML = '<span style="color: #ef4444;">Cupom não encontrado</span>';
                    appliedCoupon = null;
                    updateSaleTotal();
                    return;
                }
                
                // Verificar validade
                const now = new Date();
                const endDate = new Date(coupon.endDate);
                if (endDate < now) {
                    messageDiv.innerHTML = '<span style="color: #ef4444;">Cupom expirado</span>';
                    appliedCoupon = null;
                    updateSaleTotal();
                    return;
                }
                
                // Verificar limite de usos
                if (coupon.usageLimit && coupon.usedCount >= coupon.usageLimit) {
                    messageDiv.innerHTML = '<span style="color: #ef4444;">Cupom esgotado</span>';
                    appliedCoupon = null;
                    updateSaleTotal();
                    return;
                }
                
                // Calcular subtotal para verificar valor mínimo
                let subtotal = 0;
                document.querySelectorAll('.sale-item-row').forEach(row => {
                    const productId = parseInt(row.querySelector('.sale-item-product').value);
                    const quantity = parseInt(row.querySelector('.sale-item-quantity').value);
                    if (productId && quantity) {
                        const product = products.find(p => p.id === productId);
                        if (product) {
                            subtotal += product.price * quantity;
                        }
                    }
                });
                
                if (coupon.minPurchase && subtotal < coupon.minPurchase) {
                    messageDiv.innerHTML = `<span style="color: #ef4444;">Valor mínimo: R$ ${coupon.minPurchase.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>`;
                    appliedCoupon = null;
                    updateSaleTotal();
                    return;
                }
                
                appliedCoupon = coupon;
                messageDiv.innerHTML = `<span style="color: #D4AF37;">✓ Cupom aplicado: ${coupon.type === 'percentage' ? coupon.value + '%' : 'R$ ' + coupon.value.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>`;
                updateSaleTotal();
            };

            document.getElementById('sale-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const items = [];
                document.querySelectorAll('.sale-item-row').forEach(row => {
                    const productId = parseInt(row.querySelector('.sale-item-product').value);
                    const quantity = parseInt(row.querySelector('.sale-item-quantity').value);
                    if (productId && quantity) {
                        items.push({ productId, quantity });
                    }
                });
                if (items.length === 0) {
                    alert('Adicione pelo menos um produto');
                    return;
                }
                let subtotal = 0;
                const saleItems = [];
                
                items.forEach(item => {
                    const product = products.find(p => p.id === item.productId);
                    if (product) {
                        const itemTotal = product.price * item.quantity;
                        subtotal += itemTotal;
                        product.stock = Math.max(0, product.stock - item.quantity);
                        
                        saleItems.push({
                            productId: item.productId,
                            quantity: item.quantity,
                            unitPrice: product.price,
                            totalPrice: itemTotal
                        });
                    }
                });
                
                // Aplicar desconto do cupom
                let discount = 0;
                if (appliedCoupon) {
                    if (appliedCoupon.type === 'percentage') {
                        discount = subtotal * (appliedCoupon.value / 100);
                    } else {
                        discount = Math.min(appliedCoupon.value, subtotal);
                    }
                    
                    // Incrementar contador de uso
                    appliedCoupon.usedCount = (appliedCoupon.usedCount || 0) + 1;
                }
                
                const total = subtotal - discount;
                
                const sale = {
                    id: Date.now(),
                    number: 'V' + Date.now().toString().slice(-6),
                    customerId: parseInt(document.getElementById('sale-customer').value) || null,
                    items: saleItems,
                    subtotal: subtotal,
                    discount: discount,
                    total,
                    couponCode: appliedCoupon ? appliedCoupon.code : null,
                    date: new Date().toISOString(),
                    status: 'completed'
                };
                
                // Salvar no Supabase se estiver usando
                if (useSupabase) {
                    try {
                        // Tentar usar os nomes corretos das colunas
                        // Calcular parcelas se necessário
                        const paymentType = document.getElementById('sale-payment-type').value;
                        const installments = parseInt(document.getElementById('sale-payment-installments')?.value || '1');
                        const dueDate = document.getElementById('sale-payment-due-date')?.value || null;
                        
                        // Calcular valores das parcelas
                        let installmentsDates = null;
                        let installmentsValues = null;
                        if (installments > 1 && dueDate) {
                            const dates = [];
                            const values = [];
                            const installmentValue = sale.total / installments;
                            const dueDateObj = new Date(dueDate);
                            
                            for (let i = 0; i < installments; i++) {
                                const currentDate = new Date(dueDateObj);
                                currentDate.setMonth(currentDate.getMonth() + i);
                                dates.push(currentDate.toISOString().split('T')[0]);
                                values.push(installmentValue.toFixed(2));
                            }
                            installmentsDates = JSON.stringify(dates);
                            installmentsValues = JSON.stringify(values);
                        }
                        
                        const saleData = {
                            sale_number: sale.number, // Nome padrão no schema
                            customer_id: sale.customerId,
                            items: JSON.stringify(sale.items), // JSON string dos itens
                            subtotal: sale.subtotal,
                            discount: sale.discount,
                            total_amount: sale.total, // Nome padrão no schema
                            coupon_code: sale.couponCode,
                            status: sale.status,
                            payment_method: paymentType === 'dinheiro' ? 'cash' : paymentType === 'pix' ? 'pix' : paymentType,
                            payment_type: paymentType,
                            payment_installments: installments,
                            payment_due_date: dueDate,
                            payment_installments_dates: installmentsDates,
                            payment_installments_values: installmentsValues,
                            sale_method: document.getElementById('sale-method').value,
                            sale_method_details: document.getElementById('sale-method-details').value || null,
                            notes: document.getElementById('sale-notes').value || null
                        };
                        
                        const savedSale = await supabaseRequest('sales', 'POST', saleData);
                        
                        // Supabase pode retornar um array ou um objeto único
                        let saleResult = Array.isArray(savedSale) ? savedSale[0] : savedSale;
                        
                        if (saleResult && saleResult.id) {
                            sale.id = saleResult.id;
                            console.log('✅ Venda salva no Supabase:', saleResult);
                            
                            // Salvar itens da venda na tabela sale_items (se existir)
                            if (saleResult.id && sale.items && sale.items.length > 0) {
                                for (const item of sale.items) {
                                    try {
                                        await supabaseRequest('sale_items', 'POST', {
                                            sale_id: saleResult.id,
                                            product_id: item.productId,
                                            quantity: item.quantity,
                                            unit_price: item.unitPrice,
                                            total_price: item.totalPrice
                                        });
                                    } catch (itemError) {
                                        console.warn('Aviso: Não foi possível salvar item da venda:', itemError);
                                    }
                                }
                            }
                        } else {
                            // Mesmo se não retornar ID, a venda pode ter sido salva
                            // Verificar se há vendas no banco depois
                            console.warn('⚠️ Resposta do Supabase não contém ID, mas a venda pode ter sido salva:', savedSale);
                        }
                    } catch (error) {
                        // Verificar se o erro é realmente crítico ou se a venda foi salva
                        const errorMessage = error.message || error.toString();
                        if (errorMessage.includes('ambiguous') || errorMessage.includes('points_earned')) {
                            console.error('❌ Erro de ambiguidade ao salvar venda no Supabase:', error);
                            console.warn('⚠️ A venda pode ter sido salva mesmo com o erro. Verifique no banco de dados.');
                        } else {
                            console.error('❌ Erro ao salvar venda no Supabase:', error);
                        }
                        // Continuar mesmo com erro - a venda pode ter sido salva
                    }
                }
                
                sales.push(sale);
                
                // Atualizar cliente se houver
                if (sale.customerId) {
                    const customer = customers.find(c => c.id === sale.customerId);
                    if (customer) {
                        customer.total_sales = (customer.total_sales || 0) + sale.total;
                        customer.last_sale_date = sale.date;
                        const customerSales = sales.filter(s => s.customerId === customer.id);
                        if (customerSales.length > 1 && !customer.is_recurring) {
                            customer.is_recurring = true;
                            customer.status = 'recorrente';
                        }
                        
                        // Adicionar pontos de fidelidade
                        if (loyaltyProgram && loyaltyProgram.pointsPerReal) {
                            const pointsEarned = Math.floor(total * loyaltyProgram.pointsPerReal);
                            customer.loyaltyPoints = (customer.loyaltyPoints || 0) + pointsEarned;
                            customer.loyaltyLevel = getLoyaltyLevel(customer.loyaltyPoints);
                        }
                        
                        // Atualizar cliente no Supabase (SEM loyalty_points/loyalty_level para evitar ambiguidade)
                        if (useSupabase) {
                            try {
                                // Atualizar apenas campos básicos, sem loyalty para evitar ambiguidade
                                const updateData = {
                                    total_sales: customer.total_sales,
                                    last_sale_date: customer.last_sale_date,
                                    is_recurring: customer.is_recurring,
                                    status: customer.status
                                };
                                
                                // NÃO enviar loyalty_points ou loyalty_level para evitar ambiguidade
                                // Esses campos serão atualizados separadamente se necessário
                                
                                await supabaseRequest('customers', 'PATCH', updateData, `?id=eq.${customer.id}`);
                            } catch (error) {
                                console.error('Erro ao atualizar cliente no Supabase:', error);
                            }
                        }
                    }
                }
                
                // Atualizar estoque dos produtos no Supabase
                items.forEach(item => {
                    const product = products.find(p => p.id === item.productId);
                    if (product && useSupabase) {
                        try {
                            supabaseRequest('products', 'PATCH', {
                                stock_quantity: product.stock
                            }, `?id=eq.${product.id}`);
                        } catch (error) {
                            console.error('Erro ao atualizar estoque no Supabase:', error);
                        }
                    }
                });
                
                // Limpar cupom aplicado
                appliedCoupon = null;
                document.getElementById('sale-coupon-code').value = '';
                document.getElementById('coupon-message').innerHTML = '';
                
                // Gerar certificados automaticamente para cada produto vendido
                saleItems.forEach(item => {
                    const product = products.find(p => p.id === item.productId);
                    if (product && sale.customerId) {
                        generateCertificate(sale, product, customers.find(c => c.id === sale.customerId));
                    }
                });
                
                saveData();
                closeModal('sale-modal');
                loadSales();
                loadProducts();
                loadCustomers();
                loadDashboard();
                if (currentPage === 'financial') loadFinancial();
                if (currentPage === 'recurrence') loadRecurrence();
            });

            document.getElementById('add-sale-item').addEventListener('click', addSaleItem);
            
            // Filtro de cobranças
            const invoiceFilter = document.getElementById('invoice-filter');
            if (invoiceFilter) {
                invoiceFilter.addEventListener('change', () => {
                    loadInvoices();
                });
            }
            
            // Limpar cupom ao fechar modal de venda
            const saleModal = document.getElementById('sale-modal');
            if (saleModal) {
                saleModal.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal') || e.target.classList.contains('modal-close')) {
                        appliedCoupon = null;
                        document.getElementById('sale-coupon-code').value = '';
                        if (document.getElementById('coupon-message')) {
                            document.getElementById('coupon-message').innerHTML = '';
                        }
                    }
                });
            }

            // Formulário de usuários
            document.getElementById('user-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const editId = document.getElementById('user-edit-id').value;
                const name = document.getElementById('user-name-input').value;
                const email = document.getElementById('user-email-input').value;
                const phone = document.getElementById('user-phone-input').value;
                const role = document.getElementById('user-role-input').value;
                const password = document.getElementById('user-password-input').value;
                const passwordConfirm = document.getElementById('user-password-confirm-input').value;
                const isActive = document.getElementById('user-active-input').checked;
                
                if (!name || !email || !role) {
                    alert('Preencha todos os campos obrigatórios!');
                    return;
                }
                
                // Validar senha apenas se for novo usuário ou se estiver alterando
                if (!editId || password) {
                    if (!password || password.length < 6) {
                        alert('A senha deve ter no mínimo 6 caracteres!');
                        return;
                    }
                    if (password !== passwordConfirm) {
                        alert('As senhas não coincidem!');
                        return;
                    }
                }
                
                // Verificar se email já existe (exceto se for edição do mesmo usuário)
                const existingUser = users.find(u => u.email === email && u.id !== parseInt(editId));
                if (existingUser) {
                    alert('Este email já está cadastrado!');
                    return;
                }
                
                if (editId) {
                    // Editar usuário existente
                    const userIndex = users.findIndex(u => u.id === parseInt(editId));
                    if (userIndex !== -1) {
                        users[userIndex].name = name;
                        users[userIndex].email = email;
                        users[userIndex].phone = phone;
                        users[userIndex].role = role;
                        users[userIndex].isActive = isActive;
                        if (password) {
                            users[userIndex].password = password; // Em produção, usar hash
                        }
                        users[userIndex].updatedAt = new Date().toISOString();
                    }
                } else {
                    // Novo usuário
                    const newUser = {
                        id: Date.now(),
                        name,
                        email,
                        phone,
                        password, // Em produção, usar hash
                        role,
                        isActive,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    users.push(newUser);
                }
                
                saveData();
                closeModal('user-modal');
                loadUsers();
                alert(editId ? 'Usuário atualizado com sucesso!' : 'Usuário criado com sucesso!');
            });
        }

        function showLogin() {
            document.getElementById('login-screen').classList.add('active');
            document.getElementById('app-screen').classList.remove('active');
            // Limpar qualquer estado da aplicação
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        }

        function showApp() {
            document.getElementById('login-screen').classList.remove('active');
            document.getElementById('app-screen').classList.add('active');
            // Aplicar permissões ao mostrar app
            if (currentUser) {
                applyPermissions();
            }
        }

        function loadPage(page) {
            // Verificar permissão antes de carregar a página
            if (!checkPagePermission(page)) {
                return;
            }
            
            // Recarregar dados do localStorage antes de carregar a página
            reloadDataFromStorage();
            
            currentPage = page; // Atualizar página atual
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === page) item.classList.add('active');
            });
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const pageElement = document.getElementById(`${page}-page`);
            if (pageElement) {
                pageElement.classList.add('active');
            }
            
            // Aplicar permissões novamente ao mudar de página
            applyPermissions();
            
            switch(page) {
                case 'dashboard': loadDashboard(); break;
                case 'customers': 
                    loadKanban(); 
                    loadCustomers(); 
                    break;
                case 'products': loadProducts(); break;
                case 'sales': loadSales(); break;
                case 'invoices': loadInvoices(); break;
                case 'financial': loadFinancial(); break;
                case 'coupons': loadCoupons(); break;
                case 'loyalty': loadLoyalty(); break;
                case 'recurrence': loadRecurrence(); break;
                case 'profile': loadProfile(); break;
                case 'settings': loadSettings(); break;
            }
        }

        function loadDashboard() {
            updateCustomerMetrics();
            
            // Calcular faturamento - verificar ambos os campos possíveis
            const totalRevenue = sales.reduce((sum, s) => {
                const amount = s.total_amount || s.total || 0;
                const numAmount = typeof amount === 'number' ? amount : parseFloat(amount) || 0;
                return sum + (isNaN(numAmount) ? 0 : numAmount);
            }, 0);
            
            const totalLeads = customers.length;
            const totalSales = sales.length;
            const overdueCount = customers.filter(c => c.followup_overdue).length;
            
            // Garantir que o valor seja um número válido
            const formattedRevenue = isNaN(totalRevenue) || !isFinite(totalRevenue) 
                ? '0,00' 
                : totalRevenue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            document.getElementById('stat-revenue').textContent = 'R$ ' + formattedRevenue;
            document.getElementById('stat-leads').textContent = totalLeads;
            document.getElementById('stat-sales').textContent = totalSales;
            document.getElementById('stat-followups').textContent = overdueCount;
            
            // Mostrar alerta se houver follow-ups vencidos
            const alertsContainer = document.getElementById('followup-alerts');
            if (alertsContainer) {
                if (overdueCount > 0) {
                    alertsContainer.style.display = 'block';
                    const overdueCountEl = document.getElementById('overdue-count');
                    if (overdueCountEl) {
                        overdueCountEl.textContent = 
                            `${overdueCount} ${overdueCount === 1 ? 'cliente precisa' : 'clientes precisam'} de atenção imediata`;
                    }
                } else {
                    alertsContainer.style.display = 'none';
                }
            }
        }

        function filterCustomers() {
            const searchTerm = (document.getElementById('customer-search')?.value || '').toLowerCase();
            const statusFilter = document.getElementById('customer-filter-status')?.value || '';
            const followupFilter = document.getElementById('customer-filter-followup')?.value || '';
            
            return customers.filter(customer => {
                // Busca por nome, telefone ou email
                const matchesSearch = !searchTerm || 
                    customer.name?.toLowerCase().includes(searchTerm) ||
                    customer.phone?.toLowerCase().includes(searchTerm) ||
                    customer.email?.toLowerCase().includes(searchTerm);
                
                // Filtro por status
                const matchesStatus = !statusFilter || customer.status === statusFilter;
                
                // Filtro por follow-up
                let matchesFollowup = true;
                if (followupFilter) {
                    const now = new Date();
                    if (followupFilter === 'overdue') {
                        matchesFollowup = customer.followup_overdue === true;
                    } else if (followupFilter === 'today' && customer.next_followup_date) {
                        const followupDate = new Date(customer.next_followup_date);
                        matchesFollowup = followupDate.toDateString() === now.toDateString();
                    } else if (followupFilter === 'week' && customer.next_followup_date) {
                        const followupDate = new Date(customer.next_followup_date);
                        const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                        matchesFollowup = followupDate >= now && followupDate <= weekFromNow;
                    }
                }
                
                return matchesSearch && matchesStatus && matchesFollowup;
            });
        }

        function loadKanbanData() {
            kanbanColumns.forEach(col => col.customers = []);
            const filteredCustomers = filterCustomers();
            filteredCustomers.forEach(customer => {
                const col = kanbanColumns.find(c => c.id === customer.kanbanColumnId || c.id === 1);
                if (col) col.customers.push(customer);
            });
        }

        function loadKanban() {
            loadKanbanData();
            const board = document.getElementById('kanban-board');
            if (!board) return;
            board.innerHTML = '';
            
            kanbanColumns.forEach(column => {
                const colDiv = document.createElement('div');
                colDiv.className = 'kanban-column';
                colDiv.dataset.columnId = column.id;
                
                const header = document.createElement('div');
                header.className = 'kanban-column-header';
                header.style.borderColor = column.color;
                header.style.color = column.color;
                header.textContent = `${column.name} (${column.customers.length})`;
                
                const cardsContainer = document.createElement('div');
                cardsContainer.className = 'kanban-cards';
                cardsContainer.dataset.columnId = column.id;
                
                // Ordenar clientes por prioridade
                const sortedCustomers = [...column.customers].sort((a, b) => {
                    // Priorizar follow-ups vencidos
                    if (a.followup_overdue && !b.followup_overdue) return -1;
                    if (!a.followup_overdue && b.followup_overdue) return 1;
                    // Depois por tempo na coluna
                    return (b.days_in_current_column || 0) - (a.days_in_current_column || 0);
                });
                
                sortedCustomers.forEach(customer => {
                    const card = createKanbanCard(customer);
                    cardsContainer.appendChild(card);
                });
                
                colDiv.appendChild(header);
                colDiv.appendChild(cardsContainer);
                board.appendChild(colDiv);
            });
            
            setupDragDrop();
        }

        function createKanbanCard(customer) {
            const card = document.createElement('div');
            card.className = 'kanban-card';
            card.draggable = true;
            card.dataset.customerId = customer.id;
            
            // Prioridade e classes
            const isOverdue = customer.followup_overdue || false;
            const daysInColumn = customer.days_in_current_column || 0;
            const isHotLead = customer.tags && customer.tags.some(t => 
                t.name && t.name.toLowerCase().includes('quente')
            );
            
            if (isOverdue) {
                card.classList.add('priority', 'priority-urgent', 'overdue');
            } else if (daysInColumn > 5) {
                card.classList.add('priority', 'priority-high');
            } else if (isHotLead) {
                card.classList.add('priority', 'priority-medium');
            }
            
            // Tags
            let tagsHtml = '';
            if (customer.tags && customer.tags.length > 0) {
                tagsHtml = '<div class="kanban-tags">';
                customer.tags.forEach(tag => {
                    tagsHtml += `<span class="kanban-tag" style="background-color: ${tag.color || '#D4AF37'}">${tag.icon || ''} ${tag.name}</span>`;
                });
                tagsHtml += '</div>';
            }
            
            // Follow-up indicator
            let followupHtml = '';
            if (customer.next_followup_date || isOverdue) {
                const followupDate = customer.next_followup_date ? 
                    new Date(customer.next_followup_date) : null;
                const isOverdueFollowup = followupDate && followupDate < new Date();
                
                followupHtml = `
                    <div class="followup-indicator ${isOverdueFollowup ? 'overdue' : ''}">
                        <i class="fas fa-calendar-alt"></i>
                        <span>
                            ${isOverdueFollowup ? 
                                `Vencido há ${Math.floor((new Date() - followupDate) / (1000*60*60*24))} dias` :
                                followupDate ? `Próximo: ${followupDate.toLocaleDateString('pt-BR')}` :
                                'Sem follow-up definido'
                            }
                        </span>
                    </div>
                `;
            } else if (daysInColumn > 3) {
                followupHtml = `
                    <div class="followup-indicator">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>Sem follow-up há ${daysInColumn} dias</span>
                    </div>
                `;
            }
            
            // Quick actions
            const quickActions = `
                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="quickContact(${customer.id}, 'whatsapp')">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                    <button class="quick-action-btn" onclick="quickContact(${customer.id}, 'call')">
                        <i class="fas fa-phone"></i> Ligar
                    </button>
                    <button class="quick-action-btn" onclick="scheduleFollowup(${customer.id})">
                        <i class="fas fa-calendar-plus"></i> Follow-up
                    </button>
                </div>
            `;
            
            card.innerHTML = `
                ${isHotLead ? '<div class="hot-lead"></div>' : ''}
                ${daysInColumn > 0 ? `<span class="days-in-column">${daysInColumn}d</span>` : ''}
                <h3>${customer.name}</h3>
                ${customer.phone ? `<p><i class="fas fa-phone"></i> ${customer.phone}</p>` : ''}
                ${customer.email ? `<p><i class="fas fa-envelope"></i> ${customer.email}</p>` : ''}
                ${tagsHtml}
                ${followupHtml}
                ${quickActions}
            `;
            
            return card;
        }

        function setupDragDrop() {
            document.querySelectorAll('.kanban-card').forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('customerId', card.dataset.customerId);
                    card.classList.add('dragging');
                });
                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                });
            });
            
            document.querySelectorAll('.kanban-cards').forEach(container => {
                container.addEventListener('dragover', (e) => e.preventDefault());
                container.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const customerId = parseInt(e.dataTransfer.getData('customerId'));
                    const toColumnId = parseInt(container.dataset.columnId);
                    const customer = customers.find(c => c.id === customerId);
                    if (customer) {
                        customer.kanbanColumnId = toColumnId;
                        saveData();
                        loadKanban();
                    }
                });
            });
        }

        async function loadCustomers() {
            // Carregar do Supabase se disponível
            if (useSupabase) {
                await loadDataFromSupabase();
            } else {
                // Recarregar dados do localStorage antes de exibir
                reloadDataFromStorage();
            }
            
            const tbody = document.getElementById('customers-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            
            const filteredCustomers = filterCustomers();
            
            if (filteredCustomers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Nenhum cliente encontrado</td></tr>';
                return;
            }
            
            filteredCustomers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.name}</td>
                    <td>${customer.phone || '-'}</td>
                    <td>${customer.email || '-'}</td>
                    <td><span class="status-badge ${customer.status}">${customer.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="deleteCustomer(${customer.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function loadProducts() {
            // Carregar do Supabase se disponível
            if (useSupabase) {
                await loadDataFromSupabase();
            } else {
                // Recarregar dados do localStorage antes de exibir
                reloadDataFromStorage();
            }
            
            const grid = document.getElementById('products-grid');
            if (!grid) return;
            
            // Remover duplicatas antes de exibir (sempre verificar)
            removeDuplicateProducts();
            
            grid.innerHTML = '';
            if (products.length === 0) {
                grid.innerHTML = '<div class="empty-state">Nenhum produto cadastrado</div>';
                return;
            }
            
            // Definir limite de estoque baixo das configurações (padrão: 10 unidades)
            const lowStockThreshold = (appSettings && appSettings.lowStockThreshold) || 10;
            
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                
                const stock = product.stock || 0;
                const isLowStock = stock <= lowStockThreshold;
                const isOutOfStock = stock === 0;
                
                // Adicionar classe para estoque baixo
                if (isOutOfStock) {
                    card.classList.add('out-of-stock');
                } else if (isLowStock) {
                    card.classList.add('low-stock');
                }
                
                let marginHtml = '';
                if (product.cost && product.price) {
                    const margin = ((product.price - product.cost) / product.cost * 100);
                    marginHtml = `
                        <div class="product-info">
                            <span>Margem:</span>
                            <strong style="color: #D4AF37;">${margin.toFixed(1)}%</strong>
                        </div>
                    `;
                }
                
                // Alerta de estoque
                let stockAlertHtml = '';
                if (isOutOfStock) {
                    stockAlertHtml = `
                        <div style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); border-radius: 6px; padding: 0.5rem; margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>
                            <span style="color: #ef4444; font-size: 0.875rem; font-weight: 500;">ESGOTADO</span>
                        </div>
                    `;
                } else if (isLowStock) {
                    stockAlertHtml = `
                        <div style="background: rgba(251, 191, 36, 0.2); border: 1px solid rgba(251, 191, 36, 0.5); border-radius: 6px; padding: 0.5rem; margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-exclamation-circle" style="color: #fbbf24;"></i>
                            <span style="color: #fbbf24; font-size: 0.875rem; font-weight: 500;">ESTOQUE BAIXO</span>
                        </div>
                    `;
                }
                
                // Imagem do produto
                let imageHtml = '';
                if (product.image) {
                    imageHtml = `
                        <div style="width: 100%; height: 200px; margin-bottom: 1rem; border-radius: 8px; overflow: hidden; background: rgba(26, 26, 26, 0.5);">
                            <img src="${product.image}" alt="${product.name}" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                    `;
                } else {
                    imageHtml = `
                        <div style="width: 100%; height: 200px; margin-bottom: 1rem; border-radius: 8px; background: rgba(26, 26, 26, 0.5); display: flex; align-items: center; justify-content: center; color: rgba(245, 243, 239, 0.3);">
                            <i class="fas fa-image" style="font-size: 3rem;"></i>
                        </div>
                    `;
                }
                
                // Informações do catálogo de fragrâncias
                let fragranceHtml = '';
                // Fazer parse da fragrância se for string JSON
                let frag = product.fragrance;
                if (typeof frag === 'string' && frag.startsWith('{')) {
                    try {
                        frag = JSON.parse(frag);
                    } catch (e) {
                        frag = null;
                    }
                }
                
                if (frag && typeof frag === 'object') {
                    fragranceHtml = `
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(212, 175, 55, 0.2);">
                            ${frag.notesTop ? `<div style="margin-bottom: 0.5rem;"><span style="color: rgba(245, 243, 239, 0.6); font-size: 0.75rem;">Notas de Topo:</span> <span style="font-size: 0.875rem;">${frag.notesTop}</span></div>` : ''}
                            ${frag.notesHeart ? `<div style="margin-bottom: 0.5rem;"><span style="color: rgba(245, 243, 239, 0.6); font-size: 0.75rem;">Notas de Coração:</span> <span style="font-size: 0.875rem;">${frag.notesHeart}</span></div>` : ''}
                            ${frag.notesBase ? `<div style="margin-bottom: 0.5rem;"><span style="color: rgba(245, 243, 239, 0.6); font-size: 0.75rem;">Notas de Base:</span> <span style="font-size: 0.875rem;">${frag.notesBase}</span></div>` : ''}
                            ${frag.family ? `<div style="margin-bottom: 0.5rem;"><span style="color: rgba(245, 243, 239, 0.6); font-size: 0.75rem;">Família:</span> <span style="color: #D4AF37; font-size: 0.875rem; text-transform: capitalize;">${frag.family}</span></div>` : ''}
                            ${frag.duration ? `<div style="margin-bottom: 0.5rem;"><span style="color: rgba(245, 243, 239, 0.6); font-size: 0.75rem;">Duração:</span> <span style="font-size: 0.875rem;">${frag.duration}</span></div>` : ''}
                            ${frag.projection ? `<div style="margin-bottom: 0.5rem;"><span style="color: rgba(245, 243, 239, 0.6); font-size: 0.75rem;">Projeção:</span> <span style="font-size: 0.875rem;">${frag.projection}</span></div>` : ''}
                            ${frag.occasion ? `<div style="margin-bottom: 0.5rem;"><span style="color: rgba(245, 243, 239, 0.6); font-size: 0.75rem;">Ocasião:</span> <span style="font-size: 0.875rem;">${frag.occasion}</span></div>` : ''}
                        </div>
                    `;
                }
                
                card.innerHTML = `
                    <div style="position: relative;">
                        ${isLowStock ? '<div style="position: absolute; top: 8px; right: 8px; background: ' + (isOutOfStock ? '#ef4444' : '#fbbf24') + '; color: #0F0F0F; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; z-index: 10;">' + (isOutOfStock ? 'ESGOTADO' : 'BAIXO') + '</div>' : ''}
                        <div style="position: absolute; top: 8px; left: 8px; display: flex; gap: 0.5rem; z-index: 10;">
                            <button onclick="editProduct(${product.id})" style="background: rgba(212, 175, 55, 0.2); border: 1px solid rgba(212, 175, 55, 0.5); color: #D4AF37; padding: 0.5rem; border-radius: 6px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(212, 175, 55, 0.3)'; this.style.borderColor='#D4AF37'" onmouseout="this.style.background='rgba(212, 175, 55, 0.2)'; this.style.borderColor='rgba(212, 175, 55, 0.5)'" title="Editar produto">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteProduct(${product.id})" style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); color: #ef4444; padding: 0.5rem; border-radius: 6px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'; this.style.borderColor='#ef4444'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'; this.style.borderColor='rgba(239, 68, 68, 0.5)'" title="Excluir produto">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    ${imageHtml}
                    <h3>${product.name}</h3>
                    ${product.brand ? `<p style="color: rgba(245, 243, 239, 0.6); font-size: 0.875rem;">${product.brand}</p>` : ''}
                    <div class="product-info">
                        <span>Preço:</span>
                        <strong>R$ ${product.price.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</strong>
                    </div>
                    ${fragranceHtml}
                    ${product.cost ? `
                    <div class="product-info">
                        <span>Custo:</span>
                        <strong>R$ ${product.cost.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</strong>
                    </div>
                    ` : ''}
                    ${marginHtml}
                    <div class="product-info">
                        <span>Estoque:</span>
                        <strong style="color: ${isOutOfStock ? '#ef4444' : isLowStock ? '#fbbf24' : '#D4AF37'};">${stock} unidades</strong>
                    </div>
                    ${stockAlertHtml}
                `;
                grid.appendChild(card);
            });
        }

        // Função para carregar cobranças (vendas parceladas)
        function loadInvoices() {
            const tbody = document.getElementById('invoices-table-body');
            tbody.innerHTML = '';
            
            // Filtrar vendas que precisam de cobrança:
            // - Têm parcelas (payment_installments > 1)
            // - E não são PIX, dinheiro ou débito
            // - Ou têm status de pagamento pendente
            const invoiceSales = sales.filter(sale => {
                const paymentType = (sale.payment_type || sale.payment_method || '').toLowerCase();
                const excludedTypes = ['pix', 'dinheiro', 'cash', 'debit_card', 'débito'];
                const hasInstallments = sale.payment_installments > 1;
                const isPending = sale.payment_status === 'pending';
                const isExcluded = excludedTypes.includes(paymentType);
                
                // Incluir se: tem parcelas E não é tipo excluído OU está pendente
                return (hasInstallments && !isExcluded) || (isPending && !isExcluded);
            });
            
            if (invoiceSales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Nenhuma cobrança pendente</td></tr>';
                return;
            }
            
            // Aplicar filtro se houver
            const filterValue = document.getElementById('invoice-filter')?.value || 'all';
            let filteredSales = invoiceSales;
            
            if (filterValue === 'pending') {
                filteredSales = invoiceSales.filter(s => s.payment_status === 'pending');
            } else if (filterValue === 'overdue') {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                filteredSales = invoiceSales.filter(s => {
                    if (!s.payment_due_date) return false;
                    const dueDate = new Date(s.payment_due_date);
                    dueDate.setHours(0, 0, 0, 0);
                    return dueDate < today && s.payment_status !== 'paid';
                });
            } else if (filterValue === 'this-month') {
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                filteredSales = invoiceSales.filter(s => {
                    if (!s.created_at) return false;
                    const saleDate = new Date(s.created_at);
                    return saleDate >= firstDay;
                });
            }
            
            if (filteredSales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Nenhuma cobrança encontrada com os filtros selecionados</td></tr>';
                return;
            }
            
            filteredSales.forEach(sale => {
                const customerName = sale.customer_name || (customers.find(c => c.id === sale.customer_id || c.id === sale.customerId)?.name) || 'Não informado';
                const saleTotal = sale.total || sale.total_amount || 0;
                const formattedTotal = typeof saleTotal === 'number' 
                    ? saleTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })
                    : '0,00';
                
                // Formatar forma de pagamento
                const paymentType = sale.payment_type || sale.payment_method || '-';
                const paymentNames = {
                    'dinheiro': 'Dinheiro',
                    'cash': 'Dinheiro',
                    'pix': 'PIX',
                    'cartao': 'Cartão',
                    'credit_card': 'Cartão',
                    'debit_card': 'Débito',
                    'fonte': 'Fonte',
                    'promissoria': 'Promissória',
                    'boleto': 'Boleto'
                };
                const paymentInfo = paymentNames[paymentType] || paymentType;
                
                // Parsear parcelas
                let installmentsDates = [];
                let installmentsValues = [];
                if (sale.payment_installments_dates) {
                    try {
                        installmentsDates = typeof sale.payment_installments_dates === 'string' 
                            ? JSON.parse(sale.payment_installments_dates) 
                            : sale.payment_installments_dates;
                    } catch (e) {
                        console.error('Erro ao parsear datas:', e);
                    }
                }
                if (sale.payment_installments_values) {
                    try {
                        installmentsValues = typeof sale.payment_installments_values === 'string' 
                            ? JSON.parse(sale.payment_installments_values) 
                            : sale.payment_installments_values;
                    } catch (e) {
                        console.error('Erro ao parsear valores:', e);
                    }
                }
                
                // Encontrar próxima parcela a vencer
                let nextDueDate = null;
                let nextParcelNumber = null;
                if (installmentsDates.length > 0) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    for (let i = 0; i < installmentsDates.length; i++) {
                        const dueDate = new Date(installmentsDates[i]);
                        dueDate.setHours(0, 0, 0, 0);
                        if (dueDate >= today) {
                            nextDueDate = installmentsDates[i];
                            nextParcelNumber = i + 1;
                            break;
                        }
                    }
                    // Se não encontrou próxima, pega a última
                    if (!nextDueDate && installmentsDates.length > 0) {
                        nextDueDate = installmentsDates[installmentsDates.length - 1];
                        nextParcelNumber = installmentsDates.length;
                    }
                } else if (sale.payment_due_date) {
                    nextDueDate = sale.payment_due_date;
                    nextParcelNumber = 1;
                }
                
                const nextDueDateFormatted = nextDueDate 
                    ? new Date(nextDueDate).toLocaleDateString('pt-BR')
                    : '-';
                
                // Status da cobrança
                let statusBadge = '';
                if (sale.payment_status === 'paid') {
                    statusBadge = '<span class="status-badge cliente">Pago</span>';
                } else if (nextDueDate) {
                    const dueDate = new Date(nextDueDate);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    dueDate.setHours(0, 0, 0, 0);
                    if (dueDate < today) {
                        statusBadge = '<span class="status-badge" style="background: #ef4444;">Vencida</span>';
                    } else {
                        statusBadge = '<span class="status-badge" style="background: #fbbf24;">Pendente</span>';
                    }
                } else {
                    statusBadge = '<span class="status-badge" style="background: #fbbf24;">Pendente</span>';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${sale.number || sale.sale_number || '-'}</td>
                    <td>${customerName}</td>
                    <td>R$ ${formattedTotal}</td>
                    <td>${paymentInfo}</td>
                    <td>${sale.payment_installments > 1 ? `${sale.payment_installments}x` : '1x'}</td>
                    <td>${nextDueDateFormatted}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            ${sale.payment_status !== 'paid' ? `
                                <button class="btn btn-sm btn-success" onclick="markPaymentAsPaid(${sale.id})" title="Marcar como Pago" style="background: #10b981; color: white;">
                                    <i class="fas fa-check"></i> Pago
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-primary" onclick="generateInvoice(${sale.id})" title="Gerar Cobrança">
                                <i class="fas fa-file-invoice"></i> Gerar
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="viewSaleDetails(${sale.id})" title="Ver Detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Carregar cards para mobile
            loadInvoicesCards(filteredSales);
        }
        
        // Função para carregar cards de cobranças no mobile
        function loadInvoicesCards(sales) {
            const cardsContainer = document.getElementById('invoices-cards-mobile');
            if (!cardsContainer) return;
            
            cardsContainer.innerHTML = '';
            
            if (sales.length === 0) {
                cardsContainer.innerHTML = '<div class="empty-state" style="text-align: center; padding: 2rem; color: rgba(245, 243, 239, 0.6);">Nenhuma cobrança encontrada</div>';
                return;
            }
            
            sales.forEach(sale => {
                const customerName = sale.customer_name || (customers.find(c => c.id === sale.customer_id || c.id === sale.customerId)?.name) || 'Não informado';
                const saleTotal = sale.total || sale.total_amount || 0;
                const formattedTotal = typeof saleTotal === 'number' 
                    ? saleTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })
                    : '0,00';
                
                const paymentType = sale.payment_type || sale.payment_method || '-';
                const paymentNames = {
                    'dinheiro': 'Dinheiro',
                    'cash': 'Dinheiro',
                    'pix': 'PIX',
                    'cartao': 'Cartão',
                    'credit_card': 'Cartão',
                    'debit_card': 'Débito',
                    'fonte': 'Fonte',
                    'promissoria': 'Promissória',
                    'boleto': 'Boleto'
                };
                const paymentInfo = paymentNames[paymentType] || paymentType;
                
                let installmentsDates = [];
                if (sale.payment_installments_dates) {
                    try {
                        installmentsDates = typeof sale.payment_installments_dates === 'string' 
                            ? JSON.parse(sale.payment_installments_dates) 
                            : sale.payment_installments_dates;
                    } catch (e) {
                        console.error('Erro ao parsear datas:', e);
                    }
                }
                
                const nextDueDate = installmentsDates.length > 0 ? installmentsDates[0] : (sale.payment_due_date || '-');
                const nextDueDateFormatted = nextDueDate !== '-' ? new Date(nextDueDate).toLocaleDateString('pt-BR') : '-';
                
                const status = sale.payment_status || 'pending';
                const statusColors = {
                    'paid': '#10b981',
                    'pending': '#f59e0b',
                    'overdue': '#ef4444',
                    'cancelled': '#6b7280'
                };
                const statusNames = {
                    'paid': 'Pago',
                    'pending': 'Pendente',
                    'overdue': 'Vencido',
                    'cancelled': 'Cancelado'
                };
                const statusColor = statusColors[status] || '#f59e0b';
                const statusName = statusNames[status] || status;
                
                const card = document.createElement('div');
                card.className = 'invoice-card-mobile';
                card.innerHTML = `
                    <div class="invoice-card-mobile-header">
                        <div class="invoice-card-mobile-number">${sale.number || sale.sale_number || '-'}</div>
                        <div class="invoice-card-mobile-status" style="background: ${statusColor}20; color: ${statusColor}; border: 1px solid ${statusColor}40;">
                            ${statusName}
                        </div>
                    </div>
                    <div class="invoice-card-mobile-info">
                        <div class="invoice-card-mobile-info-item">
                            <span class="invoice-card-mobile-info-label">Cliente:</span>
                            <span class="invoice-card-mobile-info-value">${customerName}</span>
                        </div>
                        <div class="invoice-card-mobile-info-item">
                            <span class="invoice-card-mobile-info-label">Valor Total:</span>
                            <span class="invoice-card-mobile-info-value" style="color: #D4AF37; font-weight: 600;">R$ ${formattedTotal}</span>
                        </div>
                        <div class="invoice-card-mobile-info-item">
                            <span class="invoice-card-mobile-info-label">Forma de Pagamento:</span>
                            <span class="invoice-card-mobile-info-value">${paymentInfo}</span>
                        </div>
                        <div class="invoice-card-mobile-info-item">
                            <span class="invoice-card-mobile-info-label">Parcelas:</span>
                            <span class="invoice-card-mobile-info-value">${sale.payment_installments > 1 ? `${sale.payment_installments}x` : '1x'}</span>
                        </div>
                        <div class="invoice-card-mobile-info-item">
                            <span class="invoice-card-mobile-info-label">Próximo Vencimento:</span>
                            <span class="invoice-card-mobile-info-value">${nextDueDateFormatted}</span>
                        </div>
                    </div>
                    <div class="invoice-card-mobile-actions">
                        ${sale.payment_status !== 'paid' ? `
                            <button class="btn btn-success" data-action="paid" data-sale-id="${sale.id}" style="flex: 1; background: #10b981; color: white;">
                                <i class="fas fa-check"></i> Marcar Pago
                            </button>
                        ` : ''}
                        <button class="btn btn-primary" data-action="generate" data-sale-id="${sale.id}" style="flex: 1;">
                            <i class="fas fa-file-invoice"></i> Gerar Cobrança
                        </button>
                        <button class="btn btn-secondary" data-action="view" data-sale-id="${sale.id}" style="flex: 1;">
                            <i class="fas fa-eye"></i> Detalhes
                        </button>
                    </div>
                `;
                
                // Adicionar event listeners aos botões
                const paidBtn = card.querySelector('[data-action="paid"]');
                const generateBtn = card.querySelector('[data-action="generate"]');
                const viewBtn = card.querySelector('[data-action="view"]');
                
                if (paidBtn) {
                    paidBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const saleId = parseInt(this.getAttribute('data-sale-id'));
                        if (typeof window.markPaymentAsPaid === 'function') {
                            window.markPaymentAsPaid(saleId);
                        } else if (typeof markPaymentAsPaid === 'function') {
                            markPaymentAsPaid(saleId);
                        } else {
                            console.error('markPaymentAsPaid não está definida');
                            alert('Erro: Função de marcar como pago não encontrada');
                        }
                    });
                }
                
                if (generateBtn) {
                    generateBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const saleId = parseInt(this.getAttribute('data-sale-id'));
                        if (typeof window.generateInvoice === 'function') {
                            window.generateInvoice(saleId);
                        } else if (typeof generateInvoice === 'function') {
                            generateInvoice(saleId);
                        } else {
                            console.error('generateInvoice não está definida');
                            alert('Erro: Função de gerar cobrança não encontrada');
                        }
                    });
                }
                
                if (viewBtn) {
                    viewBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const saleId = parseInt(this.getAttribute('data-sale-id'));
                        if (typeof window.viewSaleDetails === 'function') {
                            window.viewSaleDetails(saleId);
                        } else if (typeof viewSaleDetails === 'function') {
                            viewSaleDetails(saleId);
                        } else {
                            console.error('viewSaleDetails não está definida');
                            alert('Erro: Função de visualizar detalhes não encontrada');
                        }
                    });
                }
                
                cardsContainer.appendChild(card);
            });
        }
        
        // Expor funções globalmente para uso em onclick
        window.generateInvoice = generateInvoice;
        window.viewSaleDetails = viewSaleDetails;
        
        function loadSales() {
            const tbody = document.getElementById('sales-table-body');
            tbody.innerHTML = '';
            if (sales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Nenhuma venda registrada</td></tr>';
                return;
            }
            sales.forEach(sale => {
                // Usar customer_name da view se disponível, senão buscar no array
                const customerName = sale.customer_name || (customers.find(c => c.id === sale.customer_id || c.id === sale.customerId)?.name) || '-';
                const saleDate = sale.created_at ? new Date(sale.created_at) : (sale.date ? (typeof sale.date === 'string' ? new Date(sale.date) : sale.date) : new Date());
                const saleCertificates = certificates.filter(c => c.sale_id === sale.id);
                
                // Garantir que total existe e é um número
                const saleTotal = sale.total || sale.total_amount || 0;
                const formattedTotal = typeof saleTotal === 'number' 
                    ? saleTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })
                    : '0,00';
                
                // Forma de pagamento - traduzir e formatar
                let paymentInfo = '-';
                if (sale.payment_type || sale.payment_method) {
                    const paymentType = sale.payment_type || sale.payment_method;
                    const paymentNames = {
                        'dinheiro': 'Dinheiro',
                        'cash': 'Dinheiro',
                        'pix': 'PIX',
                        'cartao': 'Cartão',
                        'credit_card': 'Cartão',
                        'debit_card': 'Cartão',
                        'fonte': 'Fonte',
                        'promissoria': 'Promissória',
                        'boleto': 'Boleto'
                    };
                    paymentInfo = paymentNames[paymentType] || paymentType;
                    if (sale.payment_installments > 1) {
                        paymentInfo += ` (${sale.payment_installments}x)`;
                    }
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${sale.number || sale.sale_number || '-'}</td>
                    <td>${customerName}</td>
                    <td>R$ ${formattedTotal}</td>
                    <td>${paymentInfo}</td>
                    <td><span class="status-badge cliente">${sale.status || 'completed'}</span></td>
                    <td>${saleDate instanceof Date ? saleDate.toLocaleDateString('pt-BR') : (sale.date || '-')}</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-sm btn-secondary" onclick="viewSaleDetails(${sale.id})" title="Ver Detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${sale.payment_installments > 1 || sale.payment_status === 'pending' ? `
                                <button class="btn btn-sm btn-primary" onclick="generateInvoice(${sale.id})" title="Gerar Cobrança">
                                    <i class="fas fa-file-invoice"></i>
                                </button>
                            ` : ''}
                            ${saleCertificates.length > 0 ? `
                                <button class="btn btn-sm btn-primary" onclick="viewCertificates(${sale.id})" title="Ver Certificados">
                                    <i class="fas fa-certificate"></i> (${saleCertificates.length})
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadSaleForm() {
            const select = document.getElementById('sale-customer');
            select.innerHTML = '<option value="">Selecione</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                select.appendChild(option);
            });
            
            const itemsContainer = document.getElementById('sale-items');
            itemsContainer.innerHTML = '';
            addSaleItem();
            
            // Limpar cupom e recalcular total
            appliedCoupon = null;
            const couponCodeInput = document.getElementById('sale-coupon-code');
            if (couponCodeInput) {
                couponCodeInput.value = '';
            }
            const couponMessage = document.getElementById('coupon-message');
            if (couponMessage) {
                couponMessage.innerHTML = '';
            }
            calculateTotal();
        }

        // Funções para campos de pagamento
        function togglePaymentFields() {
            const paymentType = document.getElementById('sale-payment-type').value;
            const installmentsGroup = document.getElementById('payment-installments-group');
            const dueDateGroup = document.getElementById('payment-due-date-group');
            const methodDetailsGroup = document.getElementById('sale-method-details-group');
            const saleMethod = document.getElementById('sale-method').value;
            
            // Mostrar campos de parcelas apenas para cartão, fonte ou promissória
            if (paymentType === 'cartao' || paymentType === 'fonte' || paymentType === 'promissoria') {
                installmentsGroup.style.display = 'block';
                dueDateGroup.style.display = 'block';
                calculateInstallments();
            } else {
                installmentsGroup.style.display = 'none';
                dueDateGroup.style.display = 'none';
                document.getElementById('sale-payment-installments').value = '1';
            }
            
            // Mostrar detalhes se método de venda for "outro"
            if (saleMethod === 'outro') {
                methodDetailsGroup.style.display = 'block';
            } else {
                methodDetailsGroup.style.display = 'none';
            }
        }
        
        function calculateInstallments() {
            const installments = parseInt(document.getElementById('sale-payment-installments')?.value || '1');
            const total = parseFloat(document.getElementById('sale-total')?.textContent.replace(/[^\d,]/g, '').replace(',', '.') || '0');
            
            if (installments > 1 && total > 0) {
                const installmentValue = total / installments;
                console.log(`Valor por parcela: R$ ${installmentValue.toFixed(2)}`);
            }
        }
        
        // Listener para mudança no método de venda
        document.addEventListener('DOMContentLoaded', function() {
            const saleMethodSelect = document.getElementById('sale-method');
            if (saleMethodSelect) {
                saleMethodSelect.addEventListener('change', function() {
                    const methodDetailsGroup = document.getElementById('sale-method-details-group');
                    if (this.value === 'outro') {
                        methodDetailsGroup.style.display = 'block';
                    } else {
                        methodDetailsGroup.style.display = 'none';
                    }
                });
            }
        });
        
        // Função para visualizar detalhes da venda
        function viewSaleDetails(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) {
                alert('Venda não encontrada');
                return;
            }
            
            const customer = customers.find(c => c.id === sale.customer_id || c.id === sale.customerId);
            const customerName = sale.customer_name || customer?.name || 'Não informado';
            const customerEmail = sale.customer_email || customer?.email || 'Não informado';
            const customerPhone = sale.customer_phone || customer?.phone || 'Não informado';
            
            // Formatar forma de pagamento
            let paymentInfo = 'Não informado';
            if (sale.payment_type || sale.payment_method) {
                const paymentType = sale.payment_type || sale.payment_method;
                const paymentNames = {
                    'dinheiro': 'Dinheiro',
                    'cash': 'Dinheiro',
                    'pix': 'PIX',
                    'cartao': 'Cartão',
                    'credit_card': 'Cartão',
                    'debit_card': 'Cartão',
                    'fonte': 'Fonte',
                    'promissoria': 'Promissória',
                    'boleto': 'Boleto'
                };
                paymentInfo = paymentNames[paymentType] || paymentType;
                if (sale.payment_installments > 1) {
                    paymentInfo += ` (${sale.payment_installments} parcelas)`;
                }
            }
            
            // Formatar método de venda
            const saleMethodNames = {
                'presencial': 'Presencial',
                'online': 'Online',
                'telefone': 'Telefone',
                'whatsapp': 'WhatsApp',
                'email': 'E-mail',
                'outro': 'Outro'
            };
            const saleMethod = saleMethodNames[sale.sale_method] || sale.sale_method || 'Não informado';
            
            // Parsear itens se for string JSON
            let saleItems = [];
            if (sale.items) {
                try {
                    saleItems = typeof sale.items === 'string' ? JSON.parse(sale.items) : sale.items;
                } catch (e) {
                    console.error('Erro ao parsear itens:', e);
                }
            }
            
            // Parsear parcelas se existir
            let installmentsDates = [];
            let installmentsValues = [];
            if (sale.payment_installments_dates) {
                try {
                    installmentsDates = typeof sale.payment_installments_dates === 'string' 
                        ? JSON.parse(sale.payment_installments_dates) 
                        : sale.payment_installments_dates;
                } catch (e) {
                    console.error('Erro ao parsear datas:', e);
                }
            }
            if (sale.payment_installments_values) {
                try {
                    installmentsValues = typeof sale.payment_installments_values === 'string' 
                        ? JSON.parse(sale.payment_installments_values) 
                        : sale.payment_installments_values;
                } catch (e) {
                    console.error('Erro ao parsear valores:', e);
                }
            }
            
            const content = document.getElementById('sale-details-content');
            content.innerHTML = `
                <div style="display: grid; gap: 1.5rem;">
                    <div>
                        <h3 style="margin-bottom: 1rem; color: #D4AF37;">Informações da Venda</h3>
                        <div style="display: grid; gap: 0.75rem;">
                            <div><strong>Número:</strong> ${sale.number || sale.sale_number || '-'}</div>
                            <div><strong>Data:</strong> ${sale.created_at ? new Date(sale.created_at).toLocaleString('pt-BR') : (sale.date || '-')}</div>
                            <div><strong>Status:</strong> <span class="status-badge cliente">${sale.status || 'completed'}</span></div>
                            <div><strong>Método de Venda:</strong> ${saleMethod}</div>
                            ${sale.sale_method_details ? `<div><strong>Detalhes:</strong> ${sale.sale_method_details}</div>` : ''}
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="margin-bottom: 1rem; color: #D4AF37;">Cliente</h3>
                        <div style="display: grid; gap: 0.75rem;">
                            <div><strong>Nome:</strong> ${customerName}</div>
                            <div><strong>E-mail:</strong> ${customerEmail}</div>
                            <div><strong>Telefone:</strong> ${customerPhone}</div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="margin-bottom: 1rem; color: #D4AF37;">Pagamento</h3>
                        <div style="display: grid; gap: 0.75rem;">
                            <div><strong>Forma:</strong> ${paymentInfo}</div>
                            <div><strong>Status:</strong> ${sale.payment_status || 'pending'}</div>
                            ${sale.payment_due_date ? `<div><strong>Vencimento:</strong> ${new Date(sale.payment_due_date).toLocaleDateString('pt-BR')}</div>` : ''}
                            ${installmentsDates.length > 0 ? `
                                <div>
                                    <strong>Parcelas:</strong>
                                    <div style="margin-top: 0.5rem; padding: 0.75rem; background: rgba(212, 175, 55, 0.1); border-radius: 8px;">
                                        ${installmentsDates.map((date, index) => `
                                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: ${index < installmentsDates.length - 1 ? '1px solid rgba(212, 175, 55, 0.2)' : 'none'};">
                                                <span>Parcela ${index + 1}:</span>
                                                <span>R$ ${installmentsValues[index] || (sale.total_amount / sale.payment_installments).toFixed(2)} - Venc: ${new Date(date).toLocaleDateString('pt-BR')}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="margin-bottom: 1rem; color: #D4AF37;">Itens da Venda</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 1px solid rgba(212, 175, 55, 0.3);">
                                        <th style="text-align: left; padding: 0.5rem;">Produto</th>
                                        <th style="text-align: center; padding: 0.5rem;">Qtd</th>
                                        <th style="text-align: right; padding: 0.5rem;">Valor Unit.</th>
                                        <th style="text-align: right; padding: 0.5rem;">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${saleItems.length > 0 ? saleItems.map(item => {
                                        const product = products.find(p => p.id === item.productId);
                                        return `
                                            <tr style="border-bottom: 1px solid rgba(212, 175, 55, 0.1);">
                                                <td style="padding: 0.5rem;">${product?.name || 'Produto não encontrado'}</td>
                                                <td style="text-align: center; padding: 0.5rem;">${item.quantity}</td>
                                                <td style="text-align: right; padding: 0.5rem;">R$ ${(item.unitPrice || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                                                <td style="text-align: right; padding: 0.5rem;">R$ ${(item.totalPrice || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                                            </tr>
                                        `;
                                    }).join('') : '<tr><td colspan="4" style="padding: 1rem; text-align: center;">Nenhum item encontrado</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="margin-bottom: 1rem; color: #D4AF37;">Valores</h3>
                        <div style="display: grid; gap: 0.75rem; padding: 1rem; background: rgba(212, 175, 55, 0.1); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Subtotal:</span>
                                <strong>R$ ${(sale.subtotal || sale.total_amount || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</strong>
                            </div>
                            ${sale.discount > 0 ? `
                                <div style="display: flex; justify-content: space-between; color: #D4AF37;">
                                    <span>Desconto:</span>
                                    <strong>- R$ ${sale.discount.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</strong>
                                </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; font-size: 1.25rem; padding-top: 0.5rem; border-top: 1px solid rgba(212, 175, 55, 0.3);">
                                <span><strong>Total:</strong></span>
                                <strong style="color: #D4AF37;">R$ ${(sale.total || sale.total_amount || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</strong>
                            </div>
                        </div>
                    </div>
                    
                    ${sale.notes ? `
                        <div>
                            <h3 style="margin-bottom: 1rem; color: #D4AF37;">Observações</h3>
                            <div style="padding: 0.75rem; background: rgba(212, 175, 55, 0.1); border-radius: 8px;">
                                ${sale.notes}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Mostrar botões de ação se necessário
            const btnGenerate = document.getElementById('btn-generate-invoice-from-details');
            const btnMarkPaid = document.getElementById('btn-mark-paid-from-details');
            
            if (sale.payment_installments > 1 || sale.payment_status === 'pending') {
                if (btnGenerate) {
                    btnGenerate.style.display = 'inline-block';
                    btnGenerate.onclick = () => {
                        closeModal('sale-details-modal');
                        generateInvoice(saleId);
                    };
                }
            } else {
                if (btnGenerate) btnGenerate.style.display = 'none';
            }
            
            if (sale.payment_status !== 'paid') {
                if (btnMarkPaid) {
                    btnMarkPaid.style.display = 'inline-block';
                    btnMarkPaid.onclick = () => {
                        closeModal('sale-details-modal');
                        markPaymentAsPaid(saleId);
                    };
                }
            } else {
                if (btnMarkPaid) btnMarkPaid.style.display = 'none';
            }
            
            openModal('sale-details-modal');
        }
        
        // Função para gerar cobrança
        function generateInvoice(saleId) {
            currentInvoiceSaleId = saleId;
            const sale = sales.find(s => s.id === saleId);
            if (!sale) {
                alert('Venda não encontrada');
                return;
            }
            
            // Parsear parcelas
            let installmentsDates = [];
            let installmentsValues = [];
            if (sale.payment_installments_dates) {
                try {
                    installmentsDates = typeof sale.payment_installments_dates === 'string' 
                        ? JSON.parse(sale.payment_installments_dates) 
                        : sale.payment_installments_dates;
                } catch (e) {
                    console.error('Erro ao parsear datas:', e);
                }
            }
            if (sale.payment_installments_values) {
                try {
                    installmentsValues = typeof sale.payment_installments_values === 'string' 
                        ? JSON.parse(sale.payment_installments_values) 
                        : sale.payment_installments_values;
                } catch (e) {
                    console.error('Erro ao parsear valores:', e);
                }
            }
            
            // Atualizar preview
            const preview = document.getElementById('invoice-preview');
            if (sale.payment_installments > 1 && installmentsDates.length > 0) {
                preview.style.display = 'block';
                preview.innerHTML = `
                    <h4 style="margin-bottom: 0.75rem;">Parcelas:</h4>
                    ${installmentsDates.map((date, index) => `
                        <div style="padding: 0.5rem 0; border-bottom: ${index < installmentsDates.length - 1 ? '1px solid rgba(212, 175, 55, 0.2)' : 'none'};">
                            Parcela ${index + 1}: R$ ${installmentsValues[index] || (sale.total_amount / sale.payment_installments).toFixed(2)} - Venc: ${new Date(date).toLocaleDateString('pt-BR')}
                        </div>
                    `).join('')}
                `;
            } else {
                preview.style.display = 'none';
            }
            
            // Atualizar preview da mensagem
            updateInvoiceMessagePreview(sale, installmentsDates, installmentsValues);
            
            // Mostrar/ocultar campo de parcela customizada e atualizar preview
            const invoiceTypeSelect = document.getElementById('invoice-type');
            invoiceTypeSelect.addEventListener('change', function() {
                document.getElementById('invoice-custom-parcel').style.display = 
                    this.value === 'custom' ? 'block' : 'none';
                updateInvoiceMessagePreview(sale, installmentsDates, installmentsValues);
            });
            
            // Atualizar preview quando mudar parcela customizada
            document.getElementById('invoice-parcel-number')?.addEventListener('input', function() {
                updateInvoiceMessagePreview(sale, installmentsDates, installmentsValues);
            });
            
            openModal('invoice-modal');
        }
        
        // Variável global para armazenar ID da venda atual no modal de cobrança
        let currentInvoiceSaleId = null;
        
        // Função para gerar template de mensagem de cobrança
        function generateInvoiceMessage(sale, parcelNumber, installmentsDates, installmentsValues) {
            const customer = customers.find(c => c.id === sale.customer_id || c.id === sale.customerId);
            const customerName = sale.customer_name || customer?.name || 'Cliente';
            
            // Obter dados da parcela
            let parcelInfo = {
                number: parcelNumber,
                total: sale.payment_installments,
                value: 0,
                dueDate: ''
            };
            
            if (parcelNumber > 0 && parcelNumber <= sale.payment_installments) {
                parcelInfo.value = installmentsValues[parcelNumber - 1] || (sale.total_amount / sale.payment_installments);
                parcelInfo.dueDate = installmentsDates[parcelNumber - 1] ? new Date(installmentsDates[parcelNumber - 1]).toLocaleDateString('pt-BR') : '';
            } else {
                parcelInfo.value = sale.total_amount / sale.payment_installments;
                parcelInfo.dueDate = sale.payment_due_date ? new Date(sale.payment_due_date).toLocaleDateString('pt-BR') : '';
            }
            
            // Obter produtos da venda
            let saleItems = [];
            if (sale.items) {
                try {
                    saleItems = typeof sale.items === 'string' ? JSON.parse(sale.items) : sale.items;
                } catch (e) {
                    console.error('Erro ao parsear itens:', e);
                }
            }
            
            const productsList = saleItems.length > 0 
                ? saleItems.map(item => {
                    const product = products.find(p => p.id === item.productId);
                    return product?.name || 'Produto';
                }).join(', ')
                : 'Perfume adquirido';
            
            // Template da mensagem
            const message = `Olá, tudo bem? 😊

Passando apenas para lembrar que a parcela referente ao seu perfume está disponível para pagamento.

📦 Produto: ${productsList}
💳 Parcela: ${parcelInfo.number}/${parcelInfo.total}
💰 Valor: R$ ${parcelInfo.value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
📅 Vencimento: ${parcelInfo.dueDate}

Qualquer dúvida ou se precisar de apoio com o pagamento, é só me avisar.
Fico à disposição!

Atenciosamente,
CJ Perfumes`;

            return message;
        }
        
        // Função para atualizar preview da mensagem
        function updateInvoiceMessagePreview(sale, installmentsDates, installmentsValues) {
            const invoiceType = document.getElementById('invoice-type')?.value || 'next';
            const parcelNumberInput = document.getElementById('invoice-parcel-number');
            let parcelNumber = 1;
            
            if (invoiceType === 'next') {
                // Encontrar próxima parcela não vencida
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const nextParcelIndex = installmentsDates.findIndex(date => {
                    const dueDate = new Date(date);
                    dueDate.setHours(0, 0, 0, 0);
                    return dueDate >= today;
                });
                parcelNumber = nextParcelIndex >= 0 ? nextParcelIndex + 1 : 1;
            } else if (invoiceType === 'custom' && parcelNumberInput) {
                parcelNumber = parseInt(parcelNumberInput.value) || 1;
            } else if (invoiceType === 'all') {
                parcelNumber = 1; // Mostrar primeira parcela como exemplo
            }
            
            const message = generateInvoiceMessage(sale, parcelNumber, installmentsDates, installmentsValues);
            const messagePreview = document.getElementById('invoice-message-preview');
            const messageContent = document.getElementById('invoice-message-content');
            
            if (messagePreview && messageContent) {
                messagePreview.style.display = 'block';
                messageContent.textContent = message;
            }
        }
        
        // Função para marcar pagamento como pago
        function markPaymentAsPaid(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) {
                alert('Venda não encontrada');
                return;
            }
            
            // Verificar se já está pago
            if (sale.payment_status === 'paid') {
                alert('Esta venda já está marcada como paga.');
                return;
            }
            
            // Perguntar qual parcela foi paga (se houver parcelas)
            let parcelNumber = null;
            if (sale.payment_installments > 1) {
                const parcelInput = prompt(`Esta venda tem ${sale.payment_installments} parcelas.\n\nQual parcela foi paga? (Digite o número da parcela ou "todas" para marcar todas como pagas):`);
                
                if (parcelInput === null) return; // Usuário cancelou
                
                if (parcelInput.toLowerCase() === 'todas' || parcelInput.toLowerCase() === 'all') {
                    parcelNumber = 'all';
                } else {
                    parcelNumber = parseInt(parcelInput);
                    if (isNaN(parcelNumber) || parcelNumber < 1 || parcelNumber > sale.payment_installments) {
                        alert('Número de parcela inválido.');
                        return;
                    }
                }
            }
            
            // Confirmar
            const confirmMessage = parcelNumber === 'all' 
                ? `Confirmar pagamento de TODAS as ${sale.payment_installments} parcelas?`
                : parcelNumber 
                    ? `Confirmar pagamento da parcela ${parcelNumber} de ${sale.payment_installments}?`
                    : 'Confirmar pagamento desta venda?';
            
            if (!confirm(confirmMessage)) return;
            
            // Atualizar status no banco de dados
            const updateData = {
                payment_status: parcelNumber === 'all' ? 'paid' : 'partial'
            };
            
            // Se todas as parcelas foram pagas, marcar como pago completamente
            if (parcelNumber === 'all') {
                updateData.payment_status = 'paid';
            }
            
            // Atualizar no Supabase
            if (useSupabase && sale.id) {
                supabaseRequest('sales', 'PATCH', updateData, `?id=eq.${sale.id}`)
                    .then(() => {
                        // Gerar comprovante em PDF
                        generatePaymentReceiptPDF(sale, parcelNumber);
                        
                        alert('Pagamento registrado com sucesso! O comprovante será baixado automaticamente.');
                        
                        // Recarregar dados
                        if (useSupabase) {
                            loadDataFromSupabase();
                        } else {
                            loadSales();
                            loadInvoices();
                        }
                    })
                    .catch(err => {
                        console.error('Erro ao atualizar pagamento:', err);
                        alert('Erro ao registrar pagamento. Tente novamente.');
                    });
            } else {
                // Atualizar localmente
                const saleIndex = sales.findIndex(s => s.id === saleId);
                if (saleIndex >= 0) {
                    sales[saleIndex].payment_status = updateData.payment_status;
                    saveData();
                    
                    // Gerar comprovante em PDF
                    generatePaymentReceiptPDF(sale, parcelNumber);
                    
                    alert('Pagamento registrado com sucesso! O comprovante será baixado automaticamente.');
                    loadSales();
                    loadInvoices();
                }
            }
        }
        
        // Função para gerar comprovante de pagamento em PDF
        function generatePaymentReceiptPDF(sale, parcelNumber) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            const customer = customers.find(c => c.id === sale.customer_id || c.id === sale.customerId);
            const customerName = sale.customer_name || customer?.name || 'Cliente';
            
            // Parsear parcelas
            let installmentsDates = [];
            let installmentsValues = [];
            if (sale.payment_installments_dates) {
                try {
                    installmentsDates = typeof sale.payment_installments_dates === 'string' 
                        ? JSON.parse(sale.payment_installments_dates) 
                        : sale.payment_installments_dates;
                } catch (e) {
                    console.error('Erro ao parsear datas:', e);
                }
            }
            if (sale.payment_installments_values) {
                try {
                    installmentsValues = typeof sale.payment_installments_values === 'string' 
                        ? JSON.parse(sale.payment_installments_values) 
                        : sale.payment_installments_values;
                } catch (e) {
                    console.error('Erro ao parsear valores:', e);
                }
            }
            
            // Fundo branco
            doc.setFillColor(255, 255, 255);
            doc.rect(0, 0, 210, 297, 'F');
            
            // Borda dourada superior
            doc.setDrawColor(212, 175, 55);
            doc.setLineWidth(2);
            doc.line(0, 0, 210, 0);
            
            // Logo/Título
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(212, 175, 55);
            doc.text('CJ PERFUMES', 105, 25, { align: 'center' });
            
            // Subtítulo
            doc.setFontSize(16);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(43, 43, 43);
            doc.text('COMPROVANTE DE PAGAMENTO', 105, 35, { align: 'center' });
            
            // Linha decorativa
            doc.setDrawColor(212, 175, 55);
            doc.setLineWidth(0.5);
            doc.line(30, 42, 180, 42);
            
            let yPos = 55;
            
            // Informações da venda
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(43, 43, 43);
            doc.text('INFORMAÇÕES DA VENDA', 30, yPos);
            
            yPos += 10;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(`Número da Venda: ${sale.sale_number || sale.number || '-'}`, 30, yPos);
            yPos += 7;
            doc.text(`Data: ${sale.created_at ? new Date(sale.created_at).toLocaleDateString('pt-BR') : (sale.date || '-')}`, 30, yPos);
            
            // Informações do cliente
            yPos += 12;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('DADOS DO CLIENTE', 30, yPos);
            
            yPos += 10;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(`Nome: ${customerName}`, 30, yPos);
            yPos += 7;
            if (customer?.email) {
                doc.text(`E-mail: ${customer.email}`, 30, yPos);
                yPos += 7;
            }
            if (customer?.phone || sale.customer_phone) {
                doc.text(`Telefone: ${customer?.phone || sale.customer_phone}`, 30, yPos);
                yPos += 7;
            }
            
            // Informações do pagamento
            yPos += 8;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(212, 175, 55);
            doc.text('DADOS DO PAGAMENTO', 30, yPos);
            
            yPos += 10;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(43, 43, 43);
            
            const paymentType = sale.payment_type || sale.payment_method || '-';
            const paymentNames = {
                'dinheiro': 'Dinheiro',
                'cash': 'Dinheiro',
                'pix': 'PIX',
                'cartao': 'Cartão de Crédito',
                'credit_card': 'Cartão de Crédito',
                'debit_card': 'Cartão de Débito',
                'fonte': 'Fonte',
                'promissoria': 'Promissória'
            };
            const paymentName = paymentNames[paymentType] || paymentType;
            
            doc.text(`Forma de Pagamento: ${paymentName}`, 30, yPos);
            yPos += 7;
            
            if (parcelNumber === 'all') {
                doc.text(`Status: TODAS AS PARCELAS PAGAS`, 30, yPos);
                yPos += 7;
                doc.text(`Total de Parcelas: ${sale.payment_installments}`, 30, yPos);
                yPos += 7;
                doc.text(`Valor Total: R$ ${(sale.total || sale.total_amount || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`, 30, yPos);
            } else if (parcelNumber) {
                const parcelValue = installmentsValues[parcelNumber - 1] || (sale.total_amount / sale.payment_installments);
                const parcelDate = installmentsDates[parcelNumber - 1] ? new Date(installmentsDates[parcelNumber - 1]).toLocaleDateString('pt-BR') : '-';
                doc.text(`Parcela Paga: ${parcelNumber} de ${sale.payment_installments}`, 30, yPos);
                yPos += 7;
                doc.text(`Valor da Parcela: R$ ${parcelValue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`, 30, yPos);
                yPos += 7;
                doc.text(`Data de Vencimento: ${parcelDate}`, 30, yPos);
            } else {
                doc.text(`Valor Total: R$ ${(sale.total || sale.total_amount || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`, 30, yPos);
            }
            
            yPos += 7;
            doc.text(`Data do Pagamento: ${new Date().toLocaleDateString('pt-BR')}`, 30, yPos);
            
            // Itens da venda
            yPos += 15;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(43, 43, 43);
            doc.text('ITENS DA VENDA', 30, yPos);
            
            yPos += 8;
            let saleItems = [];
            if (sale.items) {
                try {
                    saleItems = typeof sale.items === 'string' ? JSON.parse(sale.items) : sale.items;
                } catch (e) {
                    console.error('Erro ao parsear itens:', e);
                }
            }
            
            if (saleItems.length > 0) {
                saleItems.forEach((item, index) => {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    const product = products.find(p => p.id === item.productId);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    doc.text(`${product?.name || 'Produto'} - Qtd: ${item.quantity} - R$ ${(item.totalPrice || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`, 30, yPos);
                    yPos += 6;
                });
            } else {
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                doc.text('Nenhum item encontrado', 30, yPos);
                yPos += 6;
            }
            
            // Total
            yPos += 5;
            doc.setDrawColor(212, 175, 55);
            doc.setLineWidth(0.5);
            doc.line(30, yPos, 180, yPos);
            
            yPos += 8;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(212, 175, 55);
            doc.text(`TOTAL: R$ ${(sale.total || sale.total_amount || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`, 30, yPos);
            
            // Rodapé
            yPos = 270;
            doc.setDrawColor(212, 175, 55);
            doc.setLineWidth(0.5);
            doc.line(30, yPos, 180, yPos);
            
            yPos += 10;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            doc.text('Este é um comprovante de pagamento gerado automaticamente.', 105, yPos, { align: 'center' });
            yPos += 6;
            doc.text('CJ Perfumes - Haute Parfumarie', 105, yPos, { align: 'center' });
            yPos += 6;
            doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, yPos, { align: 'center' });
            
            // Salvar PDF
            const fileName = parcelNumber === 'all' 
                ? `Comprovante_Pagamento_${sale.sale_number || sale.number}_Todas_Parcelas.pdf`
                : parcelNumber 
                    ? `Comprovante_Pagamento_${sale.sale_number || sale.number}_Parcela_${parcelNumber}.pdf`
                    : `Comprovante_Pagamento_${sale.sale_number || sale.number}.pdf`;
            
            doc.save(fileName);
        }
        
        // Função para gerar PDF de cobrança
        function generateInvoicePDF(sale, parcelNumber, installmentsDates, installmentsValues, forPrint = false) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            const customer = customers.find(c => c.id === sale.customer_id || c.id === sale.customerId);
            const customerName = sale.customer_name || customer?.name || 'Cliente';
            const customerPhone = sale.customer_phone || customer?.phone || '';
            const customerEmail = sale.customer_email || customer?.email || '';
            
            // Obter dados da parcela
            let parcelInfo = {
                number: parcelNumber,
                total: sale.payment_installments,
                value: 0,
                dueDate: ''
            };
            
            if (parcelNumber > 0 && parcelNumber <= sale.payment_installments) {
                parcelInfo.value = installmentsValues[parcelNumber - 1] || (sale.total_amount / sale.payment_installments);
                parcelInfo.dueDate = installmentsDates[parcelNumber - 1] ? new Date(installmentsDates[parcelNumber - 1]).toLocaleDateString('pt-BR') : '';
            } else {
                parcelInfo.value = sale.total_amount / sale.payment_installments;
                parcelInfo.dueDate = sale.payment_due_date ? new Date(sale.payment_due_date).toLocaleDateString('pt-BR') : '';
            }
            
            // Obter produtos da venda
            let saleItems = [];
            if (sale.items) {
                try {
                    saleItems = typeof sale.items === 'string' ? JSON.parse(sale.items) : sale.items;
                } catch (e) {
                    console.error('Erro ao parsear itens:', e);
                }
            }
            
            const productsList = saleItems.length > 0 
                ? saleItems.map(item => {
                    const product = products.find(p => p.id === item.productId);
                    return product?.name || 'Produto';
                }).join(', ')
                : 'Perfume adquirido';
            
            // Fundo branco
            doc.setFillColor(255, 255, 255);
            doc.rect(0, 0, 210, 297, 'F');
            
            // Borda dourada superior
            doc.setDrawColor(212, 175, 55);
            doc.setLineWidth(2);
            doc.line(0, 0, 210, 0);
            
            // Logo/Título
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(212, 175, 55);
            doc.text('CJ PERFUMES', 105, 25, { align: 'center' });
            
            // Subtítulo
            doc.setFontSize(16);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(43, 43, 43);
            doc.text('COBRANÇA', 105, 35, { align: 'center' });
            
            // Linha decorativa
            doc.setDrawColor(212, 175, 55);
            doc.setLineWidth(0.5);
            doc.line(30, 42, 180, 42);
            
            let yPos = 55;
            
            // Informações da cobrança
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(212, 175, 55);
            doc.text('DADOS DA COBRANÇA', 30, yPos);
            
            yPos += 12;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            doc.setTextColor(43, 43, 43);
            doc.text(`Número da Venda: ${sale.sale_number || sale.number || '-'}`, 30, yPos);
            yPos += 8;
            doc.text(`Produto: ${productsList}`, 30, yPos);
            yPos += 8;
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(212, 175, 55);
            doc.text(`Parcela: ${parcelInfo.number}/${parcelInfo.total}`, 30, yPos);
            yPos += 8;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.setTextColor(43, 43, 43);
            doc.text(`Valor: R$ ${parcelInfo.value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 30, yPos);
            yPos += 10;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(212, 175, 55);
            doc.text(`Vencimento: ${parcelInfo.dueDate}`, 30, yPos);
            
            // Informações do cliente
            yPos += 15;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(43, 43, 43);
            doc.text('DADOS DO CLIENTE', 30, yPos);
            
            yPos += 10;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(`Nome: ${customerName}`, 30, yPos);
            yPos += 7;
            if (customerEmail) {
                doc.text(`E-mail: ${customerEmail}`, 30, yPos);
                yPos += 7;
            }
            if (customerPhone) {
                doc.text(`Telefone: ${customerPhone}`, 30, yPos);
                yPos += 7;
            }
            
            // Forma de pagamento
            yPos += 8;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(43, 43, 43);
            doc.text('FORMA DE PAGAMENTO', 30, yPos);
            
            yPos += 10;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            const paymentType = sale.payment_type || sale.payment_method || '-';
            const paymentNames = {
                'dinheiro': 'Dinheiro',
                'cash': 'Dinheiro',
                'pix': 'PIX',
                'cartao': 'Cartão de Crédito',
                'credit_card': 'Cartão de Crédito',
                'debit_card': 'Cartão de Débito',
                'fonte': 'Fonte',
                'promissoria': 'Promissória'
            };
            const paymentName = paymentNames[paymentType] || paymentType;
            doc.text(`Forma: ${paymentName}`, 30, yPos);
            
            // Mensagem de lembrete
            yPos += 15;
            doc.setDrawColor(212, 175, 55);
            doc.setLineWidth(0.5);
            doc.line(30, yPos, 180, yPos);
            
            yPos += 10;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(43, 43, 43);
            const reminderText = [
                'Olá, tudo bem?',
                '',
                'Passando apenas para lembrar que a parcela referente ao seu perfume',
                'está disponível para pagamento.',
                '',
                'Qualquer dúvida ou se precisar de apoio com o pagamento,',
                'é só nos avisar. Ficamos à disposição!'
            ];
            reminderText.forEach(line => {
                doc.text(line, 30, yPos);
                yPos += 6;
            });
            
            // Rodapé
            yPos = 270;
            doc.setDrawColor(212, 175, 55);
            doc.setLineWidth(0.5);
            doc.line(30, yPos, 180, yPos);
            
            yPos += 10;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            doc.text('Atenciosamente,', 30, yPos);
            yPos += 7;
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(212, 175, 55);
            doc.text('CJ Perfumes', 30, yPos);
            yPos += 6;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text('Haute Parfumarie', 30, yPos);
            yPos += 8;
            doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, yPos, { align: 'center' });
            
            // Salvar ou imprimir
            if (forPrint) {
                doc.autoPrint();
                doc.output('dataurlnewwindow');
            } else {
                const fileName = `Cobranca_${sale.sale_number || sale.number}_Parcela_${parcelNumber}.pdf`;
                doc.save(fileName);
            }
        }
        
        // Expor funções globalmente para uso em onclick e event listeners
        window.generateInvoice = generateInvoice;
        window.viewSaleDetails = viewSaleDetails;
        window.markPaymentAsPaid = markPaymentAsPaid;
        
        // Função para confirmar geração de cobrança
        function confirmGenerateInvoice() {
            if (!currentInvoiceSaleId) {
                alert('Erro: Venda não identificada');
                return;
            }
            
            const sale = sales.find(s => s.id === currentInvoiceSaleId);
            if (!sale) {
                alert('Venda não encontrada');
                return;
            }
            
            const invoiceType = document.getElementById('invoice-type').value;
            const invoiceFormat = document.getElementById('invoice-format').value;
            const parcelNumber = parseInt(document.getElementById('invoice-parcel-number').value) || 1;
            
            // Parsear parcelas
            let installmentsDates = [];
            let installmentsValues = [];
            if (sale.payment_installments_dates) {
                try {
                    installmentsDates = typeof sale.payment_installments_dates === 'string' 
                        ? JSON.parse(sale.payment_installments_dates) 
                        : sale.payment_installments_dates;
                } catch (e) {
                    console.error('Erro ao parsear datas:', e);
                }
            }
            if (sale.payment_installments_values) {
                try {
                    installmentsValues = typeof sale.payment_installments_values === 'string' 
                        ? JSON.parse(sale.payment_installments_values) 
                        : sale.payment_installments_values;
                } catch (e) {
                    console.error('Erro ao parsear valores:', e);
                }
            }
            
            // Determinar qual parcela processar
            let parcelsToProcess = [];
            
            if (invoiceType === 'all' && sale.payment_installments > 1) {
                // Todas as parcelas
                for (let i = 1; i <= sale.payment_installments; i++) {
                    parcelsToProcess.push(i);
                }
            } else if (invoiceType === 'next') {
                // Próxima parcela não vencida
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const nextParcelIndex = installmentsDates.findIndex(date => {
                    const dueDate = new Date(date);
                    dueDate.setHours(0, 0, 0, 0);
                    return dueDate >= today;
                });
                if (nextParcelIndex >= 0) {
                    parcelsToProcess.push(nextParcelIndex + 1);
                } else {
                    alert('Todas as parcelas já venceram.');
                    return;
                }
            } else if (invoiceType === 'custom') {
                if (parcelNumber > 0 && parcelNumber <= sale.payment_installments) {
                    parcelsToProcess.push(parcelNumber);
                } else {
                    alert('Número de parcela inválido');
                    return;
                }
            } else {
                parcelsToProcess.push(1);
            }
            
            // Processar cada parcela
            const customer = customers.find(c => c.id === sale.customer_id || c.id === sale.customerId);
            const customerPhone = sale.customer_phone || customer?.phone || '';
            
            if (invoiceFormat === 'whatsapp' || invoiceFormat === 'copy') {
                // Gerar mensagem para WhatsApp ou copiar
                const messages = parcelsToProcess.map(parcelNum => {
                    return generateInvoiceMessage(sale, parcelNum, installmentsDates, installmentsValues);
                });
                
                if (invoiceFormat === 'whatsapp') {
                    // Abrir WhatsApp
                    const phoneNumber = customerPhone.replace(/\D/g, ''); // Remove caracteres não numéricos
                    if (phoneNumber) {
                        const whatsappMessage = encodeURIComponent(messages[0]);
                        window.open(`https://wa.me/${phoneNumber}?text=${whatsappMessage}`, '_blank');
                        alert(`Mensagem de cobrança gerada! WhatsApp aberto para ${customerPhone}`);
                    } else {
                        // Se não tiver telefone, copiar mensagem
                        navigator.clipboard.writeText(messages[0]).then(() => {
                            alert('Mensagem copiada para a área de transferência! Cole no WhatsApp manualmente.');
                        }).catch(() => {
                            // Fallback para navegadores antigos
                            const textArea = document.createElement('textarea');
                            textArea.value = messages[0];
                            document.body.appendChild(textArea);
                            textArea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textArea);
                            alert('Mensagem copiada para a área de transferência! Cole no WhatsApp manualmente.');
                        });
                    }
                } else if (invoiceFormat === 'copy') {
                    // Copiar mensagem
                    const messageToCopy = messages.join('\n\n---\n\n');
                    navigator.clipboard.writeText(messageToCopy).then(() => {
                        alert('Mensagem copiada para a área de transferência!');
                    }).catch(() => {
                        // Fallback para navegadores antigos
                        const textArea = document.createElement('textarea');
                        textArea.value = messageToCopy;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        alert('Mensagem copiada para a área de transferência!');
                    });
                }
            } else if (invoiceFormat === 'pdf') {
                // Gerar PDF de cobrança
                parcelsToProcess.forEach(parcelNum => {
                    generateInvoicePDF(sale, parcelNum, installmentsDates, installmentsValues);
                });
                alert('PDF(s) de cobrança gerado(s) com sucesso!');
            } else if (invoiceFormat === 'print') {
                // Imprimir (gerar PDF e abrir diálogo de impressão)
                parcelsToProcess.forEach(parcelNum => {
                    generateInvoicePDF(sale, parcelNum, installmentsDates, installmentsValues, true);
                });
            } else {
                // Email (futuro)
                let message = `Cobrança gerada para venda ${sale.sale_number || sale.number}!\n\n`;
                message += `Parcelas processadas: ${parcelsToProcess.join(', ')}\n`;
                message += `Formato: E-mail (funcionalidade em desenvolvimento)`;
                alert(message);
            }
            
            // Marcar como gerado
            if (useSupabase && sale.id) {
                supabaseRequest('sales', 'PATCH', {
                    payment_receipt_generated: true,
                    payment_receipt_generated_at: new Date().toISOString()
                }, `?id=eq.${sale.id}`).then(() => {
                    console.log('✅ Comprovante marcado como gerado');
                }).catch(err => {
                    console.error('Erro ao atualizar status:', err);
                });
            }
            
            closeModal('invoice-modal');
            
            // Recarregar vendas para atualizar status
            if (useSupabase) {
                loadDataFromSupabase();
            } else {
                loadSales();
            }
        }
        
        function addSaleItem() {
            const container = document.getElementById('sale-items');
            const row = document.createElement('div');
            row.className = 'sale-item-row';
            
            const select = document.createElement('select');
            select.className = 'sale-item-product';
            select.innerHTML = '<option value="">Selecione produto</option>';
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} - R$ ${product.price.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                option.dataset.price = product.price;
                select.appendChild(option);
            });
            select.addEventListener('change', calculateTotal);
            
            const quantity = document.createElement('input');
            quantity.type = 'number';
            quantity.className = 'sale-item-quantity';
            quantity.value = '1';
            quantity.min = '1';
            quantity.addEventListener('input', calculateTotal);
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-danger btn-sm';
            removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
            removeBtn.onclick = () => {
                row.remove();
                calculateTotal();
            };
            
            row.appendChild(select);
            row.appendChild(quantity);
            row.appendChild(removeBtn);
            container.appendChild(row);
        }

        function calculateTotal() {
            let subtotal = 0;
            document.querySelectorAll('.sale-item-row').forEach(row => {
                const select = row.querySelector('.sale-item-product');
                const quantity = parseInt(row.querySelector('.sale-item-quantity').value) || 0;
                const price = parseFloat(select.selectedOptions[0]?.dataset.price || 0);
                subtotal += price * quantity;
            });
            
            // Calcular desconto do cupom
            let discount = 0;
            if (appliedCoupon) {
                if (appliedCoupon.type === 'percentage') {
                    discount = subtotal * (appliedCoupon.value / 100);
                } else {
                    discount = Math.min(appliedCoupon.value, subtotal);
                }
            }
            
            const total = subtotal - discount;
            
            // Atualizar exibição
            const subtotalEl = document.getElementById('sale-subtotal');
            const discountRowEl = document.getElementById('sale-discount-row');
            const discountEl = document.getElementById('sale-discount');
            const totalEl = document.getElementById('sale-total');
            
            if (subtotalEl) {
                subtotalEl.textContent = 'R$ ' + subtotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            }
            
            if (discountRowEl && discountEl) {
                if (discount > 0) {
                    discountRowEl.style.display = 'flex';
                    discountEl.textContent = '- R$ ' + discount.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                } else {
                    discountRowEl.style.display = 'none';
                }
            }
            
            if (totalEl) {
                totalEl.textContent = 'R$ ' + total.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            }
        }
        
        // Alias para compatibilidade
        window.updateSaleTotal = calculateTotal;

        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
            if (id === 'customer-modal') {
                document.getElementById('customer-form').reset();
            }
            if (id === 'product-modal') {
                document.getElementById('product-form').reset();
            }
            if (id === 'sale-modal') {
                document.getElementById('sale-form').reset();
            }
            if (id === 'certificate-modal') {
                document.getElementById('certificates-list').innerHTML = '';
            }
            if (id === 'certificate-modal') {
                document.getElementById('certificates-list').innerHTML = '';
            }
        }

        // Função para carregar dados do Supabase
        async function loadDataFromSupabase() {
            try {
                console.log('🔄 Carregando dados do Supabase...');
                
                // Carregar produtos
                const supabaseProducts = await supabaseRequest('products', 'GET', null, '?is_active=eq.true&order=created_at.desc');
                if (supabaseProducts) {
                    products = supabaseProducts.map(p => ({
                        id: p.id,
                        name: p.name,
                        brand: p.brand,
                        concentration: p.concentration,
                        volume: p.volume,
                        batch: p.batch,
                        origin: p.origin,
                        gender: p.gender,
                        fragrance: p.fragrance,
                        price: parseFloat(p.price),
                        cost: p.cost ? parseFloat(p.cost) : null,
                        stock: p.stock_quantity || 0,
                        stock_quantity: p.stock_quantity || 0,
                        image: p.image_url || null, // Usar apenas image_url do Supabase
                        image_url: p.image_url,
                        image_base64: null, // Não existe no banco
                        is_active: p.is_active !== false,
                        fragrance: (() => {
                            // Se fragrance for string JSON, fazer parse
                            if (typeof p.fragrance === 'string' && p.fragrance.startsWith('{')) {
                                try {
                                    return JSON.parse(p.fragrance);
                                } catch (e) {
                                    return null;
                                }
                            }
                            return p.fragrance || null;
                        })()
                    }));
                    console.log(`✅ ${products.length} produtos carregados do Supabase`);
                }

                // Carregar clientes
                const supabaseCustomers = await supabaseRequest('customers', 'GET', null, '?order=created_at.desc');
                if (supabaseCustomers) {
                    customers = supabaseCustomers;
                    console.log(`✅ ${customers.length} clientes carregados do Supabase`);
                }

                // Carregar vendas (usar view com nome do cliente)
                try {
                    const supabaseSales = await supabaseRequest('sales_with_customer_name', 'GET', null, '?order=created_at.desc');
                    if (supabaseSales) {
                        sales = supabaseSales;
                        console.log(`✅ ${sales.length} vendas carregadas do Supabase`);
                    }
                } catch (viewError) {
                    // Fallback para tabela sales se view não existir
                    console.warn('View não encontrada, usando tabela sales:', viewError);
                    const supabaseSales = await supabaseRequest('sales', 'GET', null, '?select=*,customers(name,email,phone)&order=created_at.desc');
                    if (supabaseSales) {
                        sales = supabaseSales;
                        console.log(`✅ ${sales.length} vendas carregadas do Supabase`);
                    }
                }

                // Carregar cupons
                const supabaseCoupons = await supabaseRequest('coupons', 'GET', null, '?is_active=eq.true&order=created_at.desc');
                if (supabaseCoupons) {
                    coupons = supabaseCoupons;
                    console.log(`✅ ${coupons.length} cupons carregados do Supabase`);
                }

                // Salvar no localStorage como cache
                try {
            localStorage.setItem('products', JSON.stringify(products));
                    localStorage.setItem('customers', JSON.stringify(customers));
                    localStorage.setItem('sales', JSON.stringify(sales));
                    localStorage.setItem('coupons', JSON.stringify(coupons));
                } catch (e) {
                    console.warn('Não foi possível salvar cache no localStorage:', e);
                }

            } catch (error) {
                console.error('Erro ao carregar dados do Supabase:', error);
                // Fallback para localStorage
                console.log('⚠️ Usando dados do localStorage como fallback');
                loadDataFromLocalStorage();
            }
        }

        // Função para carregar dados do localStorage (fallback)
        function loadDataFromLocalStorage() {
            customers = JSON.parse(localStorage.getItem('customers') || '[]');
            products = JSON.parse(localStorage.getItem('products') || '[]');
            sales = JSON.parse(localStorage.getItem('sales') || '[]');
            certificates = JSON.parse(localStorage.getItem('certificates') || '[]');
            coupons = JSON.parse(localStorage.getItem('coupons') || '[]');
            loyaltyProgram = JSON.parse(localStorage.getItem('loyaltyProgram') || '{}');
        }

        // Função para salvar dados (Supabase + localStorage como cache)
        async function saveData() {
            try {
                if (useSupabase) {
                    // Salvar no Supabase (produtos são salvos individualmente)
                    // Esta função salva apenas no localStorage como cache
                    console.log('💾 Salvando cache no localStorage...');
                }

                // Comprimir imagens base64 grandes antes de salvar
                const compressedProducts = products.map(product => {
                    if (product.image && product.image.startsWith('data:image')) {
                        if (product.image.length > 300000) {
                            console.warn(`Imagem do produto ${product.name} muito grande, será comprimida na próxima edição`);
                        }
                    }
                    return product;
                });

                // Salvar no localStorage como cache
                localStorage.setItem('customers', JSON.stringify(customers));
                localStorage.setItem('products', JSON.stringify(compressedProducts));
            localStorage.setItem('sales', JSON.stringify(sales));
            localStorage.setItem('certificates', JSON.stringify(certificates));
            localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('coupons', JSON.stringify(coupons));
                localStorage.setItem('loyaltyProgram', JSON.stringify(loyaltyProgram));
            } catch (error) {
                if (error.name === 'QuotaExceededError') {
                    console.error('⚠️ LocalStorage cheio! Limpando imagens grandes...');
                    
                    // Estratégia: Remover imagens base64 grandes, manter apenas URLs do Supabase
                    let productsCleaned = products.map(product => {
                        // Se tem imagem base64 grande, remover
                        if (product.image && product.image.startsWith('data:image')) {
                            if (product.image.length > 150000) { // >150KB
                                console.log(`Removendo imagem grande do produto: ${product.name}`);
                                return { 
                                    ...product, 
                                    image: null, 
                                    image_base64: null,
                                    image_url: product.image_url || null // Manter URL se existir
                                };
                            }
                        }
                        return product;
                    });
                    
                    // Tentar salvar novamente
                    try {
                        localStorage.setItem('products', JSON.stringify(productsCleaned));
                        products = productsCleaned;
                        console.log('✅ Imagens grandes removidas. Espaço liberado.');
                        alert('⚠️ Espaço no navegador estava cheio!\n\nImagens grandes foram removidas automaticamente.\n\nDica: Configure o Supabase Storage para salvar imagens online e evitar este problema.');
                    } catch (e) {
                        // Se ainda falhar, remover TODAS as imagens base64
                        console.error('Ainda sem espaço. Removendo todas as imagens base64...');
                        productsCleaned = products.map(product => ({
                            ...product,
                            image: product.image_url || null, // Manter apenas URL
                            image_base64: null
                        }));
                        try {
                            localStorage.setItem('products', JSON.stringify(productsCleaned));
                            products = productsCleaned;
                            alert('⚠️ Espaço crítico! Todas as imagens base64 foram removidas.\n\nConfigure o Supabase Storage para salvar imagens online.');
                        } catch (e2) {
                            console.error('Erro crítico: Não foi possível salvar dados:', e2);
                            alert('❌ Erro crítico: Não foi possível salvar dados.\n\nLimpe o cache do navegador ou remova dados antigos manualmente.');
                        }
                    }
                } else {
                    console.error('Erro ao salvar dados:', error);
                    alert('Erro ao salvar dados: ' + error.message);
                }
            }
        }

        function deleteCustomer(id) {
            if (!hasPermission('delete_customers')) {
                alert('Você não tem permissão para excluir clientes!');
                return;
            }
            if (confirm('Deseja realmente excluir este cliente?')) {
                customers = customers.filter(c => c.id !== id);
                saveData();
                loadCustomers();
                loadKanban();
                loadDashboard();
            }
        }

        window.deleteCustomer = deleteCustomer;

        // Quick Actions
        function quickContact(customerId, type) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            if (type === 'whatsapp' && customer.whatsapp) {
                window.open(`https://wa.me/55${customer.whatsapp.replace(/\D/g, '')}`, '_blank');
            } else if (type === 'whatsapp' && customer.phone) {
                window.open(`https://wa.me/55${customer.phone.replace(/\D/g, '')}`, '_blank');
            } else if (type === 'call' && customer.phone) {
                window.location.href = `tel:${customer.phone}`;
            }
            
            // Registrar contato
            if (!customer.contacts) customer.contacts = [];
            customer.contacts.push({
                type: type,
                date: new Date().toISOString(),
                direction: 'outbound'
            });
            saveData();
        }

        function scheduleFollowup(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            const dateStr = prompt('Data do follow-up (DD/MM/YYYY):');
            if (dateStr) {
                const [day, month, year] = dateStr.split('/');
                const followupDate = new Date(year, month - 1, day);
                customer.next_followup_date = followupDate.toISOString();
                customer.followup_overdue = false;
                saveData();
                updateCustomerMetrics();
                loadKanban();
                alert('Follow-up agendado com sucesso!');
            }
        }

        window.quickContact = quickContact;
        window.scheduleFollowup = scheduleFollowup;

        // Financial Analysis
        function loadFinancial() {
            updateCustomerMetrics();
            
            const periodSelect = document.getElementById('financial-period');
            const periodValue = periodSelect ? periodSelect.value : 'month';
            
            const now = new Date();
            let startDate, endDate;
            
            switch(periodValue) {
                case 'day':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                    break;
                case 'week':
                    const dayOfWeek = now.getDay();
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - dayOfWeek);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'month':
                default:
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                    break;
            }
            
            const periodSales = sales.filter(sale => {
                if (!sale.date) return false;
                const saleDate = typeof sale.date === 'string' ? new Date(sale.date) : sale.date;
                return saleDate >= startDate && saleDate <= endDate;
            });
            
            let totalRevenue = 0;
            let totalCosts = 0;
            
            periodSales.forEach(sale => {
                const amount = sale.total_amount || sale.total || 0;
                const numAmount = typeof amount === 'number' ? amount : parseFloat(amount) || 0;
                totalRevenue += isNaN(numAmount) ? 0 : numAmount;
                if (sale.items && Array.isArray(sale.items)) {
                    sale.items.forEach(item => {
                        const product = products.find(p => p.id === item.productId);
                        if (product && product.cost) {
                            totalCosts += (product.cost || 0) * (item.quantity || 0);
                        }
                    });
                }
            });
            
            const profit = totalRevenue - totalCosts;
            const margin = totalRevenue > 0 ? (profit / totalRevenue * 100) : 0;
            const averageTicket = periodSales.length > 0 ? totalRevenue / periodSales.length : 0;
            
            document.getElementById('financial-revenue').textContent = 
                'R$ ' + totalRevenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            document.getElementById('financial-profit').textContent = 
                'R$ ' + profit.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            document.getElementById('financial-margin').textContent = 
                margin.toFixed(1) + '%';
            document.getElementById('financial-ticket').textContent = 
                'R$ ' + averageTicket.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            
            loadTopProducts(periodSales);
            loadTopCustomers(periodSales);
        }

        function loadTopProducts(periodSales) {
            const productMap = new Map();
            
            periodSales.forEach(sale => {
                if (sale.items && Array.isArray(sale.items)) {
                    sale.items.forEach(item => {
                        const product = products.find(p => p.id === item.productId);
                        if (!product) return;
                        
                        const existing = productMap.get(item.productId) || {
                            name: product.name,
                            revenue: 0,
                            costs: 0,
                            units: 0
                        };
                        
                        existing.revenue += (item.quantity || 0) * (product.price || 0);
                        existing.costs += (item.quantity || 0) * (product.cost || 0);
                        existing.units += (item.quantity || 0);
                        
                        productMap.set(item.productId, existing);
                    });
                }
            });
            
            const profitability = Array.from(productMap.entries())
                .map(([id, data]) => ({
                    id,
                    ...data,
                    profit: data.revenue - data.costs,
                    margin: data.revenue > 0 ? ((data.revenue - data.costs) / data.revenue * 100) : 0
                }))
                .sort((a, b) => b.profit - a.profit)
                .slice(0, 10);
            
            const tbody = document.getElementById('top-products-body');
            tbody.innerHTML = '';
            
            if (profitability.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Nenhum dado no período</td></tr>';
                return;
            }
            
            profitability.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="priority-badge priority-medium">#${index + 1}</span></td>
                    <td>${item.name}</td>
                    <td>R$ ${item.revenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    <td>R$ ${item.profit.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    <td>${item.margin.toFixed(1)}%</td>
                    <td>${item.units}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadTopCustomers(periodSales) {
            const customerMap = new Map();
            
            periodSales.forEach(sale => {
                if (!sale.customerId) return;
                const customer = customers.find(c => c.id === sale.customerId);
                if (!customer) return;
                
                const existing = customerMap.get(sale.customerId) || {
                    name: customer.name,
                    revenue: 0,
                    purchases: 0,
                    lastPurchase: null
                };
                
                existing.revenue += sale.total || 0;
                existing.purchases += 1;
                const saleDate = sale.date ? (typeof sale.date === 'string' ? new Date(sale.date) : sale.date) : new Date();
                if (!existing.lastPurchase || saleDate > existing.lastPurchase) {
                    existing.lastPurchase = saleDate;
                }
                
                customerMap.set(sale.customerId, existing);
            });
            
            const profitability = Array.from(customerMap.entries())
                .map(([id, data]) => ({
                    id,
                    ...data,
                    averageTicket: data.purchases > 0 ? data.revenue / data.purchases : 0
                }))
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 10);
            
            const tbody = document.getElementById('top-customers-body');
            tbody.innerHTML = '';
            
            if (profitability.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Nenhum dado no período</td></tr>';
                return;
            }
            
            profitability.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="priority-badge priority-medium">#${index + 1}</span></td>
                    <td>${item.name}</td>
                    <td>R$ ${item.revenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    <td>${item.purchases}</td>
                    <td>R$ ${item.averageTicket.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    <td>${item.lastPurchase ? item.lastPurchase.toLocaleDateString('pt-BR') : '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Recurrence Analysis
        function loadRecurrence() {
            updateCustomerMetrics();
            
            const readyCustomers = getCustomersReadyForRepurchase();
            const reactivationAlerts = generateReactivationAlerts();
            
            const alertsContainer = document.getElementById('reactivation-alerts');
            if (reactivationAlerts.length > 0) {
                alertsContainer.style.display = 'block';
                document.getElementById('reactivation-count').textContent = 
                    `${reactivationAlerts.length} ${reactivationAlerts.length === 1 ? 'cliente precisa' : 'clientes precisam'} de reativação`;
            } else {
                alertsContainer.style.display = 'none';
            }
            
            loadReadyForRepurchase(readyCustomers);
            loadReactivationAlerts(reactivationAlerts);
        }

        function getCustomersReadyForRepurchase() {
            const ready = [];
            
            customers.forEach(customer => {
                if (customer.status === 'perdido') return;
                
                const customerSales = sales.filter(s => s.customerId === customer.id);
                if (customerSales.length < 2) return;
                
                const sortedSales = customerSales.sort((a, b) => {
                    const dateA = a.date ? (typeof a.date === 'string' ? new Date(a.date) : a.date) : new Date(0);
                    const dateB = b.date ? (typeof b.date === 'string' ? new Date(b.date) : b.date) : new Date(0);
                    return dateA - dateB;
                });
                
                let totalDays = 0;
                for (let i = 1; i < sortedSales.length; i++) {
                    const prev = sortedSales[i - 1].date ? (typeof sortedSales[i - 1].date === 'string' ? new Date(sortedSales[i - 1].date) : sortedSales[i - 1].date) : new Date(0);
                    const curr = sortedSales[i].date ? (typeof sortedSales[i].date === 'string' ? new Date(sortedSales[i].date) : sortedSales[i].date) : new Date(0);
                    totalDays += Math.floor((curr - prev) / (1000 * 60 * 60 * 24));
                }
                
                const avgInterval = Math.round(totalDays / (sortedSales.length - 1));
                const lastSale = sortedSales[sortedSales.length - 1];
                const lastDate = lastSale.date ? (typeof lastSale.date === 'string' ? new Date(lastSale.date) : lastSale.date) : new Date();
                const daysSince = Math.floor((new Date() - lastDate) / (1000 * 60 * 60 * 24));
                
                if (daysSince >= avgInterval) {
                    const nextEstimate = new Date(lastDate);
                    nextEstimate.setDate(nextEstimate.getDate() + avgInterval);
                    
                    ready.push({
                        customer,
                        totalPurchases: sortedSales.length,
                        avgInterval,
                        lastPurchase: lastDate,
                        daysInactive: daysSince,
                        nextEstimate,
                        priority: daysSince > avgInterval * 1.3 ? 'high' : 
                                 daysSince > avgInterval * 0.9 ? 'medium' : 'low'
                    });
                }
            });
            
            return ready.sort((a, b) => (b.customer.total_sales || 0) - (a.customer.total_sales || 0));
        }

        function generateReactivationAlerts() {
            const alerts = [];
            
            customers.forEach(customer => {
                if (customer.status === 'perdido') return;
                
                const customerSales = sales.filter(s => s.customerId === customer.id);
                if (customerSales.length < 1) return;
                
                const sortedByDate = customerSales.sort((a, b) => {
                    const dateA = a.date ? (typeof a.date === 'string' ? new Date(a.date) : a.date) : new Date(0);
                    const dateB = b.date ? (typeof b.date === 'string' ? new Date(b.date) : b.date) : new Date(0);
                    return dateB - dateA;
                });
                const lastSale = sortedByDate[0];
                
                const lastDate = lastSale.date ? (typeof lastSale.date === 'string' ? new Date(lastSale.date) : lastSale.date) : new Date();
                const daysInactive = Math.floor((new Date() - lastDate) / (1000 * 60 * 60 * 24));
                
                let avgInterval = 30;
                if (customerSales.length >= 2) {
                    const intervals = [];
                    const sorted = customerSales.sort((a, b) => {
                        const dateA = a.date ? (typeof a.date === 'string' ? new Date(a.date) : a.date) : new Date(0);
                        const dateB = b.date ? (typeof b.date === 'string' ? new Date(b.date) : b.date) : new Date(0);
                        return dateA - dateB;
                    });
                    for (let i = 1; i < sorted.length; i++) {
                        const prev = sorted[i - 1].date ? (typeof sorted[i - 1].date === 'string' ? new Date(sorted[i - 1].date) : sorted[i - 1].date) : new Date(0);
                        const curr = sorted[i].date ? (typeof sorted[i].date === 'string' ? new Date(sorted[i].date) : sorted[i].date) : new Date(0);
                        intervals.push(Math.floor((curr - prev) / (1000 * 60 * 60 * 24)));
                    }
                    avgInterval = Math.round(intervals.reduce((a, b) => a + b, 0) / intervals.length);
                }
                
                if (daysInactive >= avgInterval * 0.8) {
                    const totalLTV = customerSales.reduce((sum, s) => sum + (s.total || 0), 0);
                    
                    alerts.push({
                        customer,
                        daysInactive,
                        avgInterval,
                        lastPurchaseValue: lastSale.total || 0,
                        totalLTV,
                        priority: daysInactive > avgInterval * 1.3 ? 'high' : 
                                 daysInactive > avgInterval * 0.9 ? 'medium' : 'low'
                    });
                }
            });
            
            return alerts.sort((a, b) => {
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                const diff = priorityOrder[a.priority] - priorityOrder[b.priority];
                return diff !== 0 ? diff : b.totalLTV - a.totalLTV;
            });
        }

        function loadReadyForRepurchase(readyCustomers) {
            const tbody = document.getElementById('ready-repurchase-body');
            tbody.innerHTML = '';
            
            if (readyCustomers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Nenhum cliente apto à recompra no momento</td></tr>';
                return;
            }
            
            readyCustomers.forEach(item => {
                const row = document.createElement('tr');
                const priorityClass = item.priority === 'high' ? 'priority-urgent' : 
                                     item.priority === 'medium' ? 'priority-high' : 'priority-medium';
                
                row.innerHTML = `
                    <td>${item.customer.name}</td>
                    <td>${item.totalPurchases}</td>
                    <td>${item.avgInterval} dias</td>
                    <td>${item.lastPurchase.toLocaleDateString('pt-BR')}</td>
                    <td>${item.daysInactive} dias</td>
                    <td>${item.nextEstimate.toLocaleDateString('pt-BR')}</td>
                    <td><span class="priority-badge ${priorityClass}">${item.priority}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="quickContact(${item.customer.id}, 'whatsapp')">
                            <i class="fab fa-whatsapp"></i> Contatar
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadReactivationAlerts(alerts) {
            const tbody = document.getElementById('reactivation-list-body');
            tbody.innerHTML = '';
            
            if (alerts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Nenhum alerta de reativação</td></tr>';
                return;
            }
            
            alerts.forEach(alert => {
                const row = document.createElement('tr');
                const priorityClass = alert.priority === 'high' ? 'priority-urgent' : 
                                     alert.priority === 'medium' ? 'priority-high' : 'priority-medium';
                
                row.innerHTML = `
                    <td>${alert.customer.name}</td>
                    <td>${alert.daysInactive} dias</td>
                    <td>${alert.avgInterval} dias</td>
                    <td>R$ ${alert.totalLTV.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    <td>R$ ${alert.lastPurchaseValue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    <td><span class="priority-badge ${priorityClass}">${alert.priority}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="quickContact(${alert.customer.id}, 'whatsapp')">
                            <i class="fab fa-whatsapp"></i> Reativar
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Atualizar quando período mudar
        const periodSelect = document.getElementById('financial-period');
        if (periodSelect) {
            periodSelect.addEventListener('change', () => {
                if (currentPage === 'financial') {
                    loadFinancial();
                }
            });
        }

        // Certificate Functions
        function generateCertificate(sale, product, customer) {
            if (!sale || !product || !customer) return;
            
            // Verificar se já existe certificado para esta venda e produto
            const existing = certificates.find(c => 
                c.sale_id === sale.id && 
                c.product_id === product.id && 
                c.customer_id === customer.id
            );
            
            if (existing) return; // Não duplicar
            
            // Gerar código único
            const certificateCode = 'CJ-' + Date.now().toString(36).toUpperCase() + '-' + 
                Math.random().toString(36).substring(2, 6).toUpperCase();
            
            const certificate = {
                id: Date.now(),
                code: certificateCode,
                sale_id: sale.id,
                sale_number: sale.number,
                product_id: product.id,
                product_name: product.name,
                product_brand: product.brand || '',
                product_concentration: product.concentration || '',
                product_volume: product.volume || '',
                product_batch: product.batch || '',
                product_origin: product.origin || '',
                customer_id: customer.id,
                customer_name: customer.name,
                customer_code: customer.id.toString(),
                issue_date: new Date().toISOString(),
                sale_date: sale.date
            };
            
            certificates.push(certificate);
            
            // Adicionar ao cliente
            if (!customer.certificates) customer.certificates = [];
            customer.certificates.push(certificate.id);
            
            return certificate;
        }

        function viewCertificates(saleId) {
            const saleCertificates = certificates.filter(c => c.sale_id === saleId);
            
            if (saleCertificates.length === 0) {
                alert('Nenhum certificado encontrado para esta venda.');
                return;
            }
            
            const listContainer = document.getElementById('certificates-list');
            listContainer.innerHTML = '';
            
            saleCertificates.forEach(cert => {
                const certCard = document.createElement('div');
                certCard.style.cssText = 'background: #2B2B2B; padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid rgba(212, 175, 55, 0.2);';
                
                certCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div>
                            <h3 style="color: #D4AF37; margin-bottom: 0.5rem; font-family: \'Playfair Display\', serif;">Certificado de Autenticidade</h3>
                            <p style="color: rgba(245, 243, 239, 0.7); font-size: 0.875rem;">Código: <strong>${cert.code}</strong></p>
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <p style="margin-bottom: 0.5rem;"><strong>Cliente:</strong> ${cert.customer_name}</p>
                        <p style="margin-bottom: 0.5rem;"><strong>Produto:</strong> ${cert.product_name}${cert.product_brand ? ' - ' + cert.product_brand : ''}</p>
                        <p style="margin-bottom: 0.5rem;"><strong>Venda:</strong> ${cert.sale_number}</p>
                        <p style="margin-bottom: 0.5rem;"><strong>Data de Emissão:</strong> ${new Date(cert.issue_date).toLocaleDateString('pt-BR')}</p>
                    </div>
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="downloadCertificateCompact(${cert.id})">
                            <i class="fas fa-download"></i> Baixar Certificado
                        </button>
                        <button class="btn btn-secondary" onclick="viewCertificateCard(${cert.id})">
                            <i class="fas fa-eye"></i> Ver Digital
                        </button>
                        <button class="btn btn-secondary" onclick="sendCertificateWhatsApp(${cert.id})">
                            <i class="fab fa-whatsapp"></i> Enviar WhatsApp
                        </button>
                    </div>
                `;
                
                listContainer.appendChild(certCard);
            });
            
            openModal('certificate-modal');
        }

        function downloadCertificateCompact(certificateId) {
            const cert = certificates.find(c => c.id === certificateId);
            if (!cert) {
                alert('Certificado não encontrado.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            // Formato compacto premium (A5 landscape - 148mm x 105mm)
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: [148, 105]
            });
            
            // Fundo branco premium
            doc.setFillColor(255, 255, 255);
            doc.rect(0, 0, 148, 105, 'F');
            
            // Marca d'água (fundo) - será adicionada após carregar
            const watermarkUrl = 'https://zpqtcrfygjtjtacufgbv.supabase.co/storage/v1/object/public/logos/LOGO%20MARCA%20D\'AGUA%20(1).png';
            try {
                doc.addImage(watermarkUrl, 'PNG', 20, 20, 108, 65, undefined, 'FAST', 0.03);
            } catch(e) {
                console.log('Marca d\'água não pôde ser carregada no PDF');
            }
            
            // Borda dourada elegante
            doc.setDrawColor(212, 175, 55);
            doc.setLineWidth(1.2);
            doc.rect(8, 8, 132, 89);
            doc.setLineWidth(0.6);
            doc.setDrawColor(184, 138, 68);
            doc.rect(9, 9, 130, 87);
            
            // Título Principal
            doc.setTextColor(43, 43, 43);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('CERTIFICADO DE AUTENTICIDADE', 74, 18, { align: 'center' });
            
            // Linha decorativa
            doc.setDrawColor(212, 175, 55);
            doc.setLineWidth(0.8);
            doc.line(18, 22, 130, 22);
            
            // Texto de Autenticidade
            const authenticityText = `A CJ Empórium certifica que o perfume ${cert.product_name}, da marca ${cert.product_brand || 'N/A'}, adquirido por ${cert.customer_name}, é um produto original, importado e proveniente de fornecedores oficialmente selecionados. Este certificado confirma a autenticidade e procedência do produto, refletindo o compromisso da CJ Empórium com a excelência, a exclusividade e a experiência premium na perfumaria árabe de luxo.`;
            
            doc.setTextColor(43, 43, 43);
            doc.setFontSize(7.5);
            doc.setFont('helvetica', 'italic');
            const splitText = doc.splitTextToSize(authenticityText, 120);
            doc.text(splitText, 74, 30, { align: 'center' });
            
            // Linha separadora
            doc.setDrawColor(212, 175, 55);
            doc.setLineWidth(0.5);
            doc.line(18, 50, 130, 50);
            
            // Dados do Produto - Layout em duas colunas
            let yPos = 56;
            const labelStart = 18; // Início dos labels
            const valueStart = 32; // Início dos valores (alinhado)
            const rightColumnStart = 80; // Início da coluna direita
            
            // CLIENTE (linha completa)
            doc.setFontSize(7);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(212, 175, 55);
            doc.text('CLIENTE:', labelStart, yPos);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(43, 43, 43);
            const customerName = cert.customer_name.length > 48 ? cert.customer_name.substring(0, 48) : cert.customer_name;
            doc.text(customerName, valueStart, yPos);
            
            yPos += 7;
            // PERFUME (esquerda) e MARCA (direita) - mesma linha
            doc.setFontSize(7);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(212, 175, 55);
            doc.text('PERFUME:', labelStart, yPos);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(43, 43, 43);
            const productName = cert.product_name.length > 30 ? cert.product_name.substring(0, 30) : cert.product_name;
            doc.text(productName, valueStart, yPos);
            
            if (cert.product_brand) {
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(212, 175, 55);
                doc.text('MARCA:', rightColumnStart, yPos);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                doc.setTextColor(184, 138, 68);
                const brandName = cert.product_brand.length > 25 ? cert.product_brand.substring(0, 25) : cert.product_brand;
                doc.text(brandName, rightColumnStart + 12, yPos);
            }
            
            const details = [];
            if (cert.product_concentration) details.push(cert.product_concentration);
            if (cert.product_volume) details.push(cert.product_volume);
            if (cert.product_batch) details.push(`Lote: ${cert.product_batch}`);
            
            yPos += 7;
            // TIPO (esquerda) e DATA (direita) - mesma linha
            if (details.length > 0) {
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(212, 175, 55);
                doc.text('TIPO:', labelStart, yPos);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(184, 138, 68);
                const detailsText = details.join(' • ');
                const detailsLines = doc.splitTextToSize(detailsText, 50);
                doc.text(detailsLines, valueStart, yPos);
            }
            
            doc.setFontSize(7);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(212, 175, 55);
            doc.text('DATA:', rightColumnStart, yPos);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(43, 43, 43);
            doc.text(new Date(cert.sale_date).toLocaleDateString('pt-BR'), rightColumnStart + 12, yPos);
            
            // Linha decorativa inferior
            yPos += 6;
            doc.setDrawColor(212, 175, 55);
            doc.setLineWidth(1);
            doc.line(18, yPos, 130, yPos);
            
            // Assinatura (abaixo da linha, no espaço em branco)
            yPos += 5;
            const signatureUrl = 'https://zpqtcrfygjtjtacufgbv.supabase.co/storage/v1/object/public/logos/White%20Minimalist%20Handwritten%20Signature%20Typography%20Logo%20(1).png';
            try {
                doc.addImage(signatureUrl, 'PNG', 40, yPos, 68, 7, undefined, 'FAST');
            } catch(e) {
                doc.setFontSize(9);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(43, 43, 43);
                doc.text('CJ Empórium', 74, yPos + 3, { align: 'center' });
            }
            
            // Haute Parfumarie (mais abaixo, depois da assinatura)
            yPos += 9;
            doc.setFontSize(7);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(184, 138, 68);
            doc.text('Haute Parfumarie', 74, yPos, { align: 'center' });
            
            // Salvar PDF compacto
            doc.save(`Certificado_${cert.code}_Compacto.pdf`);
        }

        function viewCertificateCard(certificateId) {
            const cert = certificates.find(c => c.id === certificateId);
            if (!cert) {
                alert('Certificado não encontrado.');
                return;
            }
            
            const cardModal = document.createElement('div');
            cardModal.id = 'certificate-card-modal';
            cardModal.className = 'modal active';
            cardModal.style.cssText = 'z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);';
            
            const details = [];
            if (cert.product_concentration) details.push(cert.product_concentration);
            if (cert.product_volume) details.push(cert.product_volume);
            if (cert.product_batch) details.push(`Lote: ${cert.product_batch}`);
            
            const authenticityText = `A CJ Empórium certifica que o perfume ${cert.product_name}, da marca ${cert.product_brand || 'N/A'}, adquirido por ${cert.customer_name}, é um produto original, importado e proveniente de fornecedores oficialmente selecionados. Este certificado confirma a autenticidade e procedência do produto, refletindo o compromisso da CJ Empórium com a excelência, a exclusividade e a experiência premium na perfumaria árabe de luxo.`;
            
            cardModal.innerHTML = `
                <div style="max-width: 700px; width: 95%; padding: 0; background: transparent;">
                    <div style="background: #FFFFFF; padding: 3.5rem 3rem; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.12); overflow: hidden; border: 4px solid #D4AF37; border-radius: 0; box-shadow: inset 0 0 0 1px rgba(184, 138, 68, 0.5);">
                        <!-- Borda interna -->
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; border: 1px solid rgba(184, 138, 68, 0.6); pointer-events: none; z-index: 0;"></div>
                        
                        <!-- Marca d'água (fundo quase transparente com tom dourado) -->
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-12deg); width: 70%; height: 70%; pointer-events: none; opacity: 0.03; z-index: 0;">
                            <img src="https://zpqtcrfygjtjtacufgbv.supabase.co/storage/v1/object/public/logos/LOGO%20MARCA%20D'AGUA%20(1).png" alt="Marca d'água" style="width: 100%; height: 100%; object-fit: contain; filter: sepia(100%) saturate(200%) brightness(0.8) hue-rotate(15deg);" />
                        </div>
                        
                        <button onclick="this.closest('.modal').remove()" style="position: absolute; top: 1.25rem; right: 1.25rem; background: rgba(255, 255, 255, 0.98); border: 2px solid rgba(212, 175, 55, 0.4); color: #D4AF37; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; transition: all 0.3s; font-weight: 300; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">×</button>
                        
                        <!-- Header -->
                        <div style="text-align: center; margin-bottom: 2.5rem; position: relative; z-index: 1;">
                            <h1 style="color: #2B2B2B; font-size: 1.5rem; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; margin: 0; font-family: 'Helvetica', 'Arial', sans-serif;">CERTIFICADO DE AUTENTICIDADE</h1>
                        </div>
                        
                        <!-- Texto de Autenticidade -->
                        <div style="margin-bottom: 2.5rem; position: relative; z-index: 1;">
                            <p style="color: #2B2B2B; font-size: 0.9375rem; line-height: 1.9; margin: 0; text-align: center; font-style: normal; font-weight: 400; font-family: 'Helvetica', 'Arial', sans-serif;">${authenticityText}</p>
                        </div>
                        
                        <!-- Linha decorativa -->
                        <div style="height: 1px; background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.3), transparent); margin: 2rem 0; position: relative; z-index: 1;"></div>
                        
                        <!-- Dados do Produto - Layout em duas colunas -->
                        <div style="margin-bottom: 1.5rem; position: relative; z-index: 1;">
                            <!-- Cliente (linha completa) -->
                            <div style="display: flex; align-items: baseline; margin-bottom: 0.75rem;">
                                <div style="width: 90px; flex-shrink: 0;">
                                    <p style="color: #B88A44; font-size: 0.6875rem; font-weight: 600; margin: 0; letter-spacing: 0.1em; text-transform: uppercase;">Cliente:</p>
                                </div>
                                <div style="flex: 1;">
                                    <p style="color: #2B2B2B; font-size: 1rem; font-weight: 600; line-height: 1.3; margin: 0;">${cert.customer_name}</p>
                                </div>
                            </div>
                            
                            <!-- Perfume e Marca (mesma linha) -->
                            <div style="display: flex; align-items: baseline; margin-bottom: 0.75rem; gap: 2rem;">
                                <div style="display: flex; align-items: baseline; flex: 1;">
                                    <div style="width: 90px; flex-shrink: 0;">
                                        <p style="color: #B88A44; font-size: 0.6875rem; font-weight: 600; margin: 0; letter-spacing: 0.1em; text-transform: uppercase;">Perfume:</p>
                                    </div>
                                    <div style="flex: 1;">
                                        <p style="color: #2B2B2B; font-size: 1rem; font-weight: 600; line-height: 1.3; margin: 0;">${cert.product_name}</p>
                                    </div>
                                </div>
                                ${cert.product_brand ? `
                                <div style="display: flex; align-items: baseline; flex: 1;">
                                    <div style="width: 60px; flex-shrink: 0;">
                                        <p style="color: #B88A44; font-size: 0.6875rem; font-weight: 600; margin: 0; letter-spacing: 0.1em; text-transform: uppercase;">Marca:</p>
                                    </div>
                                    <div style="flex: 1;">
                                        <p style="color: #D4AF37; font-size: 0.9375rem; font-weight: 500; margin: 0;">${cert.product_brand}</p>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- Tipo e Data (mesma linha) -->
                            <div style="display: flex; align-items: baseline; margin-bottom: 0; gap: 2rem;">
                                ${details.length > 0 ? `
                                <div style="display: flex; align-items: baseline; flex: 1;">
                                    <div style="width: 90px; flex-shrink: 0;">
                                        <p style="color: #B88A44; font-size: 0.6875rem; font-weight: 600; margin: 0; letter-spacing: 0.1em; text-transform: uppercase;">Tipo:</p>
                                    </div>
                                    <div style="flex: 1;">
                                        <p style="color: rgba(43, 43, 43, 0.75); font-size: 0.875rem; margin: 0; font-weight: 400;">${details.join(' • ')}</p>
                                    </div>
                                </div>
                                ` : '<div style="flex: 1;"></div>'}
                                <div style="display: flex; align-items: baseline; flex: 1;">
                                    <div style="width: 60px; flex-shrink: 0;">
                                        <p style="color: #B88A44; font-size: 0.6875rem; font-weight: 600; margin: 0; letter-spacing: 0.1em; text-transform: uppercase;">Data:</p>
                                    </div>
                                    <div style="flex: 1;">
                                        <p style="color: #2B2B2B; font-size: 1rem; font-weight: 600; margin: 0;">${new Date(cert.sale_date).toLocaleDateString('pt-BR')}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Linha decorativa (antes da assinatura) -->
                        <div style="height: 1px; background: linear-gradient(90deg, transparent, #D4AF37 20%, #D4AF37 80%, transparent); margin: 1.5rem 0 0 0; position: relative; z-index: 1;"></div>
                        
                        <!-- Assinatura (abaixo da linha, no espaço em branco) -->
                        <div style="text-align: center; margin-top: 1rem; position: relative; z-index: 2;">
                            <img src="https://zpqtcrfygjtjtacufgbv.supabase.co/storage/v1/object/public/logos/White%20Minimalist%20Handwritten%20Signature%20Typography%20Logo%20(1).png" alt="Assinatura CJ Empórium" style="max-width: 140px; height: auto; margin: 0 auto; display: block; filter: brightness(0);" />
                        </div>
                        
                        <!-- Haute Parfumarie (mais abaixo, depois da assinatura) -->
                        <div style="text-align: center; margin-top: 1rem; position: relative; z-index: 2;">
                            <p style="color: rgba(184, 138, 68, 0.9); font-size: 0.7rem; letter-spacing: 0.1em; margin: 0; font-weight: 400; text-transform: uppercase;">Haute Parfumarie</p>
                        </div>
                        
                        <!-- Ações -->
                        <div style="display: flex; gap: 1rem; margin-top: 2.5rem; position: relative; z-index: 1;">
                            <button class="btn btn-primary" onclick="downloadCertificateCompact(${cert.id}); this.closest('.modal').remove();" style="flex: 1; padding: 1rem; font-size: 0.9375rem; font-weight: 600; border-radius: 8px;">
                                <i class="fas fa-download"></i> Baixar PDF
                            </button>
                            <button class="btn btn-secondary" onclick="sendCertificateWhatsApp(${cert.id}); this.closest('.modal').remove();" style="flex: 1; padding: 1rem; font-size: 0.9375rem; font-weight: 600; border-radius: 8px;">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(cardModal);
            
            cardModal.addEventListener('click', (e) => {
                if (e.target === cardModal) cardModal.remove();
            });
        }

        function downloadCertificate(certificateId) {
            const cert = certificates.find(c => c.id === certificateId);
            if (!cert) {
                alert('Certificado não encontrado.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            // Fundo escuro (simulado com retângulo)
            doc.setFillColor(15, 15, 15);
            doc.rect(0, 0, 210, 297, 'F');
            
            // Título
            doc.setTextColor(212, 175, 55);
            doc.setFontSize(28);
            doc.setFont('helvetica', 'bold');
            doc.text('CERTIFICADO DE AUTENTICIDADE', 105, 40, { align: 'center' });
            
            // Linha decorativa
            doc.setDrawColor(212, 175, 55);
            doc.setLineWidth(0.5);
            doc.line(30, 50, 180, 50);
            
            // Texto do certificado
            doc.setTextColor(245, 243, 239);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            
            const text = `A CJ Empórium certifica que o perfume ${cert.product_name}, da marca ${cert.product_brand || 'N/A'}, adquirido por ${cert.customer_name}, é um produto original, importado e proveniente de fornecedores oficialmente selecionados.

Este certificado confirma a autenticidade e procedência do produto, refletindo o compromisso da CJ Empórium com a excelência, a exclusividade e a experiência premium na perfumaria árabe de luxo.`;
            
            const splitText = doc.splitTextToSize(text, 150);
            doc.text(splitText, 105, 70, { align: 'center', maxWidth: 150 });
            
            // Dados do produto
            let yPos = 120;
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(212, 175, 55);
            doc.text('DADOS DO PRODUTO', 30, yPos);
            
            yPos += 8;
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(245, 243, 239);
            doc.text(`Nome: ${cert.product_name}`, 30, yPos);
            yPos += 7;
            if (cert.product_brand) {
                doc.text(`Marca: ${cert.product_brand}`, 30, yPos);
                yPos += 7;
            }
            if (cert.product_concentration) {
                doc.text(`Concentração: ${cert.product_concentration}`, 30, yPos);
                yPos += 7;
            }
            if (cert.product_volume) {
                doc.text(`Volume: ${cert.product_volume}`, 30, yPos);
                yPos += 7;
            }
            if (cert.product_batch) {
                doc.text(`Lote: ${cert.product_batch}`, 30, yPos);
                yPos += 7;
            }
            if (cert.product_origin) {
                doc.text(`Origem: ${cert.product_origin}`, 30, yPos);
                yPos += 7;
            }
            
            // Dados do cliente
            yPos += 5;
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(212, 175, 55);
            doc.text('DADOS DO CLIENTE', 30, yPos);
            
            yPos += 8;
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(245, 243, 239);
            doc.text(`Nome: ${cert.customer_name}`, 30, yPos);
            yPos += 7;
            doc.text(`Código: ${cert.customer_code}`, 30, yPos);
            
            // Dados da venda
            yPos += 10;
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(212, 175, 55);
            doc.text('DADOS DA VENDA', 30, yPos);
            
            yPos += 8;
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(245, 243, 239);
            doc.text(`Número: ${cert.sale_number}`, 30, yPos);
            yPos += 7;
            doc.text(`Data: ${new Date(cert.sale_date).toLocaleDateString('pt-BR')}`, 30, yPos);
            
            // Assinatura
            yPos = 250;
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(212, 175, 55);
            doc.text('CJ Empórium – Haute Parfumarie', 105, yPos, { align: 'center' });
            
            // Código do certificado
            yPos += 15;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(184, 138, 68);
            doc.text(`Código do Certificado: ${cert.code}`, 105, yPos, { align: 'center' });
            
            // Data de emissão
            yPos += 7;
            doc.text(`Data de Emissão: ${new Date(cert.issue_date).toLocaleDateString('pt-BR')}`, 105, yPos, { align: 'center' });
            
            // Salvar PDF
            doc.save(`Certificado_${cert.code}.pdf`);
        }

        function sendCertificateWhatsApp(certificateId) {
            const cert = certificates.find(c => c.id === certificateId);
            if (!cert) {
                alert('Certificado não encontrado.');
                return;
            }
            
            const customer = customers.find(c => c.id === cert.customer_id);
            if (!customer || !customer.phone) {
                alert('Cliente não encontrado ou sem telefone cadastrado.');
                return;
            }
            
            const message = encodeURIComponent(
                `Olá ${customer.name}! Segue o Certificado de Autenticidade do seu perfume ${cert.product_name}.\n\n` +
                `Código: ${cert.code}\n` +
                `Venda: ${cert.sale_number}\n\n` +
                `Obrigado por confiar na CJ Empórium!`
            );
            
            const phone = customer.phone.replace(/\D/g, '');
            window.open(`https://wa.me/55${phone}?text=${message}`, '_blank');
        }

        // Configurações
        function loadSettings() {
            // Carregar valores salvos
            document.getElementById('setting-company-name').value = appSettings.companyName || 'CJ Emporium';
            document.getElementById('setting-company-email').value = appSettings.companyEmail || '';
            document.getElementById('setting-company-phone').value = appSettings.companyPhone || '';
            document.getElementById('setting-currency').value = appSettings.currency || 'BRL';
            document.getElementById('setting-timezone').value = appSettings.timezone || 'America/Sao_Paulo';
            document.getElementById('setting-auto-save').checked = appSettings.autoSave !== false;

            document.getElementById('setting-low-stock-threshold').value = appSettings.lowStockThreshold || 10;
            document.getElementById('setting-stock-alerts').checked = appSettings.stockAlerts !== false;
            document.getElementById('setting-block-sales-out-of-stock').checked = appSettings.blockSalesOutOfStock || false;
            document.getElementById('setting-cost-method').value = appSettings.costMethod || 'fifo';

            document.getElementById('setting-kanban-auto-move').checked = appSettings.kanbanAutoMove !== false;
            document.getElementById('setting-kanban-show-days').checked = appSettings.kanbanShowDays !== false;
            document.getElementById('setting-kanban-priority-sort').checked = appSettings.kanbanPrioritySort !== false;
            document.getElementById('setting-kanban-high-priority-days').value = appSettings.kanbanHighPriorityDays || 5;

            document.getElementById('setting-notify-followup').checked = appSettings.notifyFollowup !== false;
            document.getElementById('setting-notify-low-stock').checked = appSettings.notifyLowStock !== false;
            document.getElementById('setting-notify-new-sale').checked = appSettings.notifyNewSale || false;
            document.getElementById('setting-notify-reactivation').checked = appSettings.notifyReactivation !== false;
            document.getElementById('setting-notification-frequency').value = appSettings.notificationFrequency || 'realtime';

            document.getElementById('setting-theme').value = appSettings.theme || 'dark';
            document.getElementById('setting-density').value = appSettings.density || 'comfortable';
            document.getElementById('setting-show-animations').checked = appSettings.showAnimations !== false;

            document.getElementById('setting-require-password-change').checked = appSettings.requirePasswordChange || false;
            document.getElementById('setting-password-expiry-days').value = appSettings.passwordExpiryDays || 90;
            document.getElementById('setting-session-timeout').checked = appSettings.sessionTimeout || false;
            document.getElementById('setting-session-timeout-minutes').value = appSettings.sessionTimeoutMinutes || 30;
            document.getElementById('setting-log-all-actions').checked = appSettings.logAllActions || false;

            // Aplicar configurações de aparência
            applyAppearanceSettings();

            // Menu lateral
            document.querySelectorAll('.settings-menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.dataset.section;
                    document.querySelectorAll('.settings-menu-item').forEach(i => i.classList.remove('active'));
                    document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
                    item.classList.add('active');
                    document.getElementById(`settings-${section}`).classList.add('active');
                });
            });
        }

        function saveSettings(section) {
            if (section === 'general') {
                appSettings.companyName = document.getElementById('setting-company-name').value;
                appSettings.companyEmail = document.getElementById('setting-company-email').value;
                appSettings.companyPhone = document.getElementById('setting-company-phone').value;
                appSettings.currency = document.getElementById('setting-currency').value;
                appSettings.timezone = document.getElementById('setting-timezone').value;
                appSettings.autoSave = document.getElementById('setting-auto-save').checked;
            } else if (section === 'stock') {
                appSettings.lowStockThreshold = parseInt(document.getElementById('setting-low-stock-threshold').value) || 10;
                appSettings.stockAlerts = document.getElementById('setting-stock-alerts').checked;
                appSettings.blockSalesOutOfStock = document.getElementById('setting-block-sales-out-of-stock').checked;
                appSettings.costMethod = document.getElementById('setting-cost-method').value;
                // Atualizar função loadProducts para usar o novo limite
                if (currentPage === 'products') loadProducts();
            } else if (section === 'kanban') {
                appSettings.kanbanAutoMove = document.getElementById('setting-kanban-auto-move').checked;
                appSettings.kanbanShowDays = document.getElementById('setting-kanban-show-days').checked;
                appSettings.kanbanPrioritySort = document.getElementById('setting-kanban-priority-sort').checked;
                appSettings.kanbanHighPriorityDays = parseInt(document.getElementById('setting-kanban-high-priority-days').value) || 5;
            } else if (section === 'notifications') {
                appSettings.notifyFollowup = document.getElementById('setting-notify-followup').checked;
                appSettings.notifyLowStock = document.getElementById('setting-notify-low-stock').checked;
                appSettings.notifyNewSale = document.getElementById('setting-notify-new-sale').checked;
                appSettings.notifyReactivation = document.getElementById('setting-notify-reactivation').checked;
                appSettings.notificationFrequency = document.getElementById('setting-notification-frequency').value;
            } else if (section === 'appearance') {
                appSettings.theme = document.getElementById('setting-theme').value;
                appSettings.density = document.getElementById('setting-density').value;
                appSettings.showAnimations = document.getElementById('setting-show-animations').checked;
                // Aplicar imediatamente
                applyAppearanceSettings();
            } else if (section === 'security') {
                appSettings.requirePasswordChange = document.getElementById('setting-require-password-change').checked;
                appSettings.passwordExpiryDays = parseInt(document.getElementById('setting-password-expiry-days').value) || 90;
                appSettings.sessionTimeout = document.getElementById('setting-session-timeout').checked;
                appSettings.sessionTimeoutMinutes = parseInt(document.getElementById('setting-session-timeout-minutes').value) || 30;
                appSettings.logAllActions = document.getElementById('setting-log-all-actions').checked;
            }

            localStorage.setItem('appSettings', JSON.stringify(appSettings));
            
            // Mostrar mensagem de sucesso
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Salvo!';
            btn.style.background = '#10b981';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = '';
            }, 2000);
        }

        // Sistema de Permissões
        function hasPermission(permission) {
            if (!currentUser) return false;
            
            const role = currentUser.role || 'viewer';
            
            // Admin tem todas as permissões
            if (role === 'admin') return true;
            
            // Definir permissões por role
            const permissions = {
                'manager': [
                    'view_dashboard', 'view_customers', 'view_kanban', 'view_products', 
                    'view_sales', 'view_financial', 'view_settings', 'view_users',
                    'create_customers', 'edit_customers', 'create_products', 'edit_products',
                    'create_sales', 'edit_sales', 'edit_financial', 'edit_settings',
                    'create_users', 'edit_users', 'move_kanban'
                ],
                'seller': [
                    'view_dashboard', 'view_customers', 'view_kanban', 'view_products', 
                    'view_sales', 'create_customers', 'edit_customers', 'move_kanban',
                    'create_products', 'create_sales'
                ],
                'viewer': [
                    'view_dashboard', 'view_customers', 'view_kanban', 'view_products', 
                    'view_sales', 'view_financial'
                ]
            };
            
            return permissions[role]?.includes(permission) || false;
        }

        function applyPermissions() {
            if (!currentUser) {
                // Se não há usuário, esconder todos os itens exceto login
                document.querySelectorAll('.nav-item[data-permission]').forEach(item => {
                    item.style.display = 'none';
                });
                return;
            }
            
            // Esconder/mostrar itens do menu baseado em permissões
            document.querySelectorAll('.nav-item[data-permission]').forEach(item => {
                const permission = item.dataset.permission;
                if (hasPermission(permission)) {
                    // Garantir que o item seja visível (remover display: none)
                    item.style.display = '';
                    item.style.visibility = 'visible';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Esconder botões de ação baseado em permissões
            const page = currentPage;
            
            // Botões de criar - mostrar todos primeiro, depois esconder conforme permissão
            const addCustomerBtn = document.getElementById('add-customer-form-btn');
            if (addCustomerBtn) {
                addCustomerBtn.style.display = hasPermission('create_customers') ? '' : 'none';
            }
            
            const addProductBtn = document.getElementById('add-product-btn');
            if (addProductBtn) {
                addProductBtn.style.display = hasPermission('create_products') ? '' : 'none';
            }
            
            const addSaleBtn = document.getElementById('add-sale-btn');
            if (addSaleBtn) {
                addSaleBtn.style.display = hasPermission('create_sales') ? '' : 'none';
            }
            
            const addUserBtn = document.getElementById('add-user-btn');
            if (addUserBtn) {
                addUserBtn.style.display = hasPermission('create_users') ? '' : 'none';
            }
        }

        function checkPagePermission(page) {
            const pagePermissions = {
                'dashboard': 'view_dashboard',
                'customers': 'view_customers',
                'products': 'view_products',
                'sales': 'view_sales',
                'financial': 'view_financial',
                'coupons': 'view_sales',
                'loyalty': 'view_customers',
                'recurrence': 'view_customers',
                'profile': 'view_users',
                'settings': 'view_settings'
            };
            
            const requiredPermission = pagePermissions[page];
            if (requiredPermission && !hasPermission(requiredPermission)) {
                alert('Você não tem permissão para acessar esta página!');
                loadPage('dashboard');
                return false;
            }
            return true;
        }

        // Funções de Perfil e Usuários
        function loadProfile() {
            // Carregar dados do usuário atual
            document.getElementById('current-user-name').textContent = currentUser.name || 'Admin';
            document.getElementById('current-user-role').textContent = getRoleName(currentUser.role || 'admin');
            document.getElementById('profile-name').value = currentUser.name || '';
            document.getElementById('profile-email').value = currentUser.email || '';
            document.getElementById('profile-phone').value = currentUser.phone || '';
            
            // Carregar lista de usuários (apenas se tiver permissão)
            if (hasPermission('view_users')) {
                loadUsers();
            }
        }

        function loadUsers() {
            const tbody = document.getElementById('users-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Nenhum usuário cadastrado</td></tr>';
                return;
            }
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="status-badge">${getRoleName(user.role)}</span></td>
                    <td><span class="status-badge ${user.isActive ? 'cliente' : 'perdido'}">${user.isActive ? 'Ativo' : 'Inativo'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editUser(${user.id})" style="margin-right: 0.5rem;">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${user.id !== currentUser.id ? `
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : '<span style="color: rgba(245, 243, 239, 0.5); font-size: 0.875rem;">Você</span>'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getRoleName(role) {
            const roles = {
                'admin': 'Administrador',
                'manager': 'Gerente',
                'seller': 'Vendedor',
                'viewer': 'Visualizador'
            };
            return roles[role] || role;
        }

        function updateProfile() {
            const name = document.getElementById('profile-name').value;
            const email = document.getElementById('profile-email').value;
            const phone = document.getElementById('profile-phone').value;
            const currentPassword = document.getElementById('profile-current-password').value;
            const newPassword = document.getElementById('profile-new-password').value;
            
            if (!name || !email) {
                alert('Nome e email são obrigatórios!');
                return;
            }
            
            // Verificar senha atual se estiver alterando senha
            if (newPassword) {
                if (!currentPassword) {
                    alert('Digite a senha atual para alterar a senha!');
                    return;
                }
                if (newPassword.length < 6) {
                    alert('A nova senha deve ter no mínimo 6 caracteres!');
                    return;
                }
            }
            
            // Atualizar usuário atual
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex].name = name;
                users[userIndex].email = email;
                users[userIndex].phone = phone;
                if (newPassword) {
                    users[userIndex].password = newPassword; // Em produção, usar hash
                }
            }
            
            // Atualizar currentUser
            currentUser.name = name;
            currentUser.email = email;
            currentUser.phone = phone;
            
            // Atualizar exibição
            document.getElementById('user-name').textContent = name;
            
            saveData();
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            loadProfile();
            
            // Limpar campos de senha
            document.getElementById('profile-current-password').value = '';
            document.getElementById('profile-new-password').value = '';
            
            alert('Perfil atualizado com sucesso!');
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('user-modal-title').textContent = 'Editar Usuário';
            document.getElementById('user-edit-id').value = userId;
            document.getElementById('user-name-input').value = user.name;
            document.getElementById('user-email-input').value = user.email;
            document.getElementById('user-phone-input').value = user.phone || '';
            document.getElementById('user-role-input').value = user.role;
            document.getElementById('user-active-input').checked = user.isActive !== false;
            document.getElementById('user-password-input').required = false;
            document.getElementById('user-password-confirm-input').required = false;
            
            openModal('user-modal');
        }

        function deleteUser(userId) {
            if (userId === currentUser.id) {
                alert('Você não pode excluir seu próprio usuário!');
                return;
            }
            
            if (!confirm('Tem certeza que deseja excluir este usuário?')) {
                return;
            }
            
            users = users.filter(u => u.id !== userId);
            saveData();
            loadUsers();
        }

        window.updateProfile = updateProfile;
        window.editUser = editUser;
        window.deleteUser = deleteUser;

        window.saveSettings = saveSettings;

        window.viewCertificates = viewCertificates;
        window.downloadCertificateCompact = downloadCertificateCompact;
        window.viewCertificateCard = viewCertificateCard;
        window.sendCertificateWhatsApp = sendCertificateWhatsApp;

        // Funções de Cupons
        function loadCoupons() {
            reloadDataFromStorage();
            const tbody = document.getElementById('coupons-table-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            if (coupons.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Nenhum cupom cadastrado</td></tr>';
                return;
            }
            
            coupons.forEach(coupon => {
                const now = new Date();
                const endDate = new Date(coupon.endDate);
                const isExpired = endDate < now;
                const isActive = !isExpired && (!coupon.usageLimit || coupon.usedCount < coupon.usageLimit);
                
                const discountText = coupon.type === 'percentage' 
                    ? `${coupon.value}%` 
                    : `R$ ${coupon.value.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong style="color: #D4AF37;">${coupon.code}</strong></td>
                    <td>${coupon.type === 'percentage' ? 'Percentual' : 'Valor Fixo'}</td>
                    <td>${discountText}</td>
                    <td>${new Date(coupon.endDate).toLocaleDateString('pt-BR')}</td>
                    <td>${coupon.usedCount || 0} / ${coupon.usageLimit || '∞'}</td>
                    <td><span class="status-badge ${isActive ? 'cliente' : 'perdido'}">${isActive ? 'Ativo' : 'Inativo'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="deleteCoupon(${coupon.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function deleteCoupon(id) {
            if (confirm('Deseja realmente excluir este cupom?')) {
                coupons = coupons.filter(c => c.id !== id);
                saveData();
                loadCoupons();
            }
        }
        
        window.deleteCoupon = deleteCoupon;
        
        // Event listener do formulário de cupons
        document.getElementById('coupon-form')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const coupon = {
                id: Date.now(),
                code: document.getElementById('coupon-code').value.toUpperCase(),
                type: document.getElementById('coupon-type').value,
                value: parseFloat(document.getElementById('coupon-value').value),
                startDate: document.getElementById('coupon-start-date').value || new Date().toISOString().split('T')[0],
                endDate: document.getElementById('coupon-end-date').value,
                usageLimit: document.getElementById('coupon-usage-limit').value ? parseInt(document.getElementById('coupon-usage-limit').value) : null,
                minPurchase: document.getElementById('coupon-min-purchase').value ? parseFloat(document.getElementById('coupon-min-purchase').value) : null,
                description: document.getElementById('coupon-description').value || '',
                usedCount: 0
            };
            
            // Verificar se código já existe
            if (coupons.find(c => c.code === coupon.code)) {
                alert('Já existe um cupom com este código!');
                return;
            }
            
            coupons.push(coupon);
            saveData();
            closeModal('coupon-modal');
            loadCoupons();
        });
        
        // Funções de Programa de Fidelidade
        function loadLoyalty() {
            reloadDataFromStorage();
            
            // Inicializar programa se não existir
            if (!loyaltyProgram || Object.keys(loyaltyProgram).length === 0) {
                loyaltyProgram = {
                    pointsPerReal: 1,
                    levels: {
                        bronze: { min: 0, discount: 0 },
                        silver: { min: 100, discount: 5 },
                        gold: { min: 500, discount: 10 },
                        platinum: { min: 1000, discount: 15 }
                    }
                };
                saveData();
            }
            
            // Inicializar pontos dos clientes se não tiverem
            customers.forEach(customer => {
                if (!customer.loyaltyPoints) customer.loyaltyPoints = 0;
                if (!customer.loyaltyLevel) customer.loyaltyLevel = getLoyaltyLevel(customer.loyaltyPoints);
            });
            saveData();
            
            // Atualizar estatísticas
            const customersInProgram = customers.filter(c => c.loyaltyPoints > 0).length;
            const totalPoints = customers.reduce((sum, c) => sum + (c.loyaltyPoints || 0), 0);
            const vipCount = customers.filter(c => c.loyaltyLevel === 'platinum' || c.loyaltyLevel === 'gold').length;
            
            document.getElementById('loyalty-customers-count').textContent = customersInProgram;
            document.getElementById('loyalty-total-points').textContent = totalPoints.toLocaleString('pt-BR');
            document.getElementById('loyalty-vip-count').textContent = vipCount;
            
            // Carregar ranking
            const tbody = document.getElementById('loyalty-ranking-body');
            if (!tbody) return;
            
            const sortedCustomers = [...customers]
                .filter(c => c.loyaltyPoints > 0)
                .sort((a, b) => (b.loyaltyPoints || 0) - (a.loyaltyPoints || 0))
                .slice(0, 50);
            
            tbody.innerHTML = '';
            if (sortedCustomers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Nenhum cliente com pontos ainda</td></tr>';
                return;
            }
            
            sortedCustomers.forEach(customer => {
                const level = customer.loyaltyLevel || getLoyaltyLevel(customer.loyaltyPoints || 0);
                const levelEmoji = {
                    bronze: '🥉',
                    silver: '🥈',
                    gold: '🥇',
                    platinum: '💎'
                };
                const levelName = {
                    bronze: 'Bronze',
                    silver: 'Prata',
                    gold: 'Ouro',
                    platinum: 'Platina'
                };
                
                const lastSale = sales
                    .filter(s => s.customerId === customer.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.name}</td>
                    <td><strong style="color: #D4AF37;">${(customer.loyaltyPoints || 0).toLocaleString('pt-BR')}</strong></td>
                    <td>${levelEmoji[level]} ${levelName[level]}</td>
                    <td>${lastSale ? new Date(lastSale.date).toLocaleDateString('pt-BR') : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="viewCustomerLoyalty(${customer.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function getLoyaltyLevel(points) {
            if (!loyaltyProgram || !loyaltyProgram.levels) return 'bronze';
            const levels = loyaltyProgram.levels;
            if (points >= (levels.platinum?.min || 1000)) return 'platinum';
            if (points >= (levels.gold?.min || 500)) return 'gold';
            if (points >= (levels.silver?.min || 100)) return 'silver';
            return 'bronze';
        }
        
        function loadLoyaltyConfig() {
            if (!loyaltyProgram || Object.keys(loyaltyProgram).length === 0) {
                loyaltyProgram = {
                    pointsPerReal: 1,
                    levels: {
                        bronze: { min: 0, discount: 0 },
                        silver: { min: 100, discount: 5 },
                        gold: { min: 500, discount: 10 },
                        platinum: { min: 1000, discount: 15 }
                    }
                };
            }
            
            document.getElementById('loyalty-points-per-real').value = loyaltyProgram.pointsPerReal || 1;
            document.getElementById('loyalty-bronze-min').value = loyaltyProgram.levels?.bronze?.min || 0;
            document.getElementById('loyalty-silver-min').value = loyaltyProgram.levels?.silver?.min || 100;
            document.getElementById('loyalty-gold-min').value = loyaltyProgram.levels?.gold?.min || 500;
            document.getElementById('loyalty-platinum-min').value = loyaltyProgram.levels?.platinum?.min || 1000;
            document.getElementById('loyalty-bronze-discount').value = loyaltyProgram.levels?.bronze?.discount || 0;
            document.getElementById('loyalty-silver-discount').value = loyaltyProgram.levels?.silver?.discount || 5;
            document.getElementById('loyalty-gold-discount').value = loyaltyProgram.levels?.gold?.discount || 10;
            document.getElementById('loyalty-platinum-discount').value = loyaltyProgram.levels?.platinum?.discount || 15;
        }
        
        function viewCustomerLoyalty(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            const level = customer.loyaltyLevel || getLoyaltyLevel(customer.loyaltyPoints || 0);
            const levelName = {
                bronze: 'Bronze',
                silver: 'Prata',
                gold: 'Ouro',
                platinum: 'Platina'
            };
            
            alert(`Cliente: ${customer.name}\nPontos: ${customer.loyaltyPoints || 0}\nNível: ${levelName[level]}\nDesconto: ${loyaltyProgram.levels?.[level]?.discount || 0}%`);
        }
        
        window.viewCustomerLoyalty = viewCustomerLoyalty;
        window.generateInvoice = generateInvoice;
        window.viewSaleDetails = viewSaleDetails;
        
        // Event listener do formulário de fidelidade
        document.getElementById('loyalty-form')?.addEventListener('submit', (e) => {
            e.preventDefault();
            loyaltyProgram = {
                pointsPerReal: parseFloat(document.getElementById('loyalty-points-per-real').value) || 1,
                levels: {
                    bronze: {
                        min: parseInt(document.getElementById('loyalty-bronze-min').value) || 0,
                        discount: parseFloat(document.getElementById('loyalty-bronze-discount').value) || 0
                    },
                    silver: {
                        min: parseInt(document.getElementById('loyalty-silver-min').value) || 100,
                        discount: parseFloat(document.getElementById('loyalty-silver-discount').value) || 5
                    },
                    gold: {
                        min: parseInt(document.getElementById('loyalty-gold-min').value) || 500,
                        discount: parseFloat(document.getElementById('loyalty-gold-discount').value) || 10
                    },
                    platinum: {
                        min: parseInt(document.getElementById('loyalty-platinum-min').value) || 1000,
                        discount: parseFloat(document.getElementById('loyalty-platinum-discount').value) || 15
                    }
                }
            };
            
            // Atualizar níveis dos clientes
            customers.forEach(customer => {
                customer.loyaltyLevel = getLoyaltyLevel(customer.loyaltyPoints || 0);
            });
            
            saveData();
            closeModal('loyalty-modal');
            loadLoyalty();
            alert('Programa de fidelidade configurado com sucesso!');
        });
    </script>
</body>
</html>

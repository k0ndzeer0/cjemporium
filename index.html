<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CJ Emporium - CRM Kanban</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0F0F0F;
            color: #F5F3EF;
            font-weight: 400;
            letter-spacing: -0.01em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://zpqtcrfygjtjtacufgbv.supabase.co/storage/v1/object/public/logos/White%20Minimalist%20Handwritten%20Signature%20Typography%20Logo%20(1).png');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 35% auto;
            opacity: 0.04;
            z-index: 0;
            pointer-events: none;
            filter: invert(1) brightness(0.3);
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* Login */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0F0F0F 0%, #2B2B2B 100%);
        }

        .login-box {
            background: #2B2B2B;
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 0 1px rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.2);
            width: 100%;
            max-width: 440px;
            backdrop-filter: blur(10px);
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header img {
            max-width: 200px;
            height: auto;
            margin-bottom: 1.5rem;
            filter: drop-shadow(0 4px 20px rgba(212, 175, 55, 0.3));
        }

        .login-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.25rem;
            font-weight: 700;
            color: #D4AF37;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .form-group {
            margin-bottom: 1.75rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.625rem;
            font-weight: 500;
            font-size: 0.875rem;
            color: #B88A44;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid rgba(184, 138, 68, 0.3);
            border-radius: 8px;
            font-size: 0.9375rem;
            background: #0F0F0F;
            color: #F5F3EF;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        
        select.form-group {
            width: auto;
            display: inline-block;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #D4AF37;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.15), 0 4px 12px rgba(0,0,0,0.3);
            background: #1A1A1A;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(245, 243, 239, 0.4);
        }

        .btn {
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.625rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.01em;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #D4AF37 0%, #B88A44 100%);
            color: #0F0F0F;
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
            background: linear-gradient(135deg, #E5C04A 0%, #C99A55 100%);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: transparent;
            color: #F5F3EF;
            border: 1px solid rgba(184, 138, 68, 0.4);
        }

        .btn-secondary:hover {
            background: rgba(184, 138, 68, 0.1);
            border-color: #B88A44;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: none;
        }

        /* App */
        #app-screen {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: #1A1A1A;
            box-shadow: 4px 0 24px rgba(0,0,0,0.6);
            border-right: 1px solid rgba(212, 175, 55, 0.1);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 2rem 1.75rem;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
        }

        .sidebar-header img {
            max-width: 140px;
            height: auto;
            margin-bottom: 1rem;
            filter: drop-shadow(0 2px 10px rgba(212, 175, 55, 0.2));
        }

        .sidebar-header h2 {
            font-family: 'Playfair Display', serif;
            color: #D4AF37;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .sidebar-nav {
            flex: 1;
            padding: 1rem 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.875rem 1.75rem;
            color: rgba(245, 243, 239, 0.7);
            text-decoration: none;
            cursor: pointer;
            gap: 0.875rem;
            font-size: 0.9375rem;
            font-weight: 500;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 0.25rem 0.75rem;
            border-radius: 8px;
        }

        .nav-item:hover {
            background: rgba(212, 175, 55, 0.08);
            color: #D4AF37;
            transform: translateX(2px);
        }

        .nav-item.active {
            background: rgba(212, 175, 55, 0.12);
            color: #D4AF37;
            font-weight: 600;
            border-left: 3px solid #D4AF37;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 1.5rem;
            border-top: 1px solid #eee;
        }

        .user-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .user-role {
            font-size: 0.875rem;
            color: #B88A44;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-header {
            margin-bottom: 2.5rem;
        }

        .page-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: #D4AF37;
            letter-spacing: -0.03em;
            margin-bottom: 0.5rem;
        }

        .card {
            background: #1A1A1A;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            border: 1px solid rgba(184, 138, 68, 0.15);
            margin-bottom: 2rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            border-color: rgba(184, 138, 68, 0.3);
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        }

        .card h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #F5F3EF;
            margin-bottom: 1.5rem;
            letter-spacing: -0.01em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #1A1A1A 0%, #2B2B2B 100%);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            border: 1px solid rgba(184, 138, 68, 0.15);
            display: flex;
            align-items: center;
            gap: 1.25rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: rgba(212, 175, 55, 0.3);
            box-shadow: 0 8px 24px rgba(0,0,0,0.6);
        }

        .stat-icon {
            width: 64px;
            height: 64px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #0F0F0F;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .stat-icon-green { background: #D4AF37; }
        .stat-icon-blue { background: #B88A44; }
        .stat-icon-purple { background: #D4AF37; }
        .stat-icon-red { background: #B88A44; }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #F5F3EF;
            letter-spacing: -0.02em;
        }

        .stat-label {
            font-size: 0.8125rem;
            color: rgba(184, 138, 68, 0.8);
            margin-bottom: 0.375rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        /* Kanban */
        .kanban-board {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 1rem;
        }

        .kanban-column {
            min-width: 320px;
            background: #1A1A1A;
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid rgba(184, 138, 68, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .kanban-column:hover {
            border-color: rgba(184, 138, 68, 0.3);
        }

        .kanban-column-header {
            background: linear-gradient(135deg, #0F0F0F 0%, #1A1A1A 100%);
            padding: 1.125rem 1.25rem;
            border-radius: 10px;
            margin-bottom: 1.25rem;
            font-weight: 600;
            font-size: 0.9375rem;
            color: #D4AF37;
            text-align: center;
            border: 1px solid rgba(212, 175, 55, 0.2);
            letter-spacing: 0.02em;
            text-transform: uppercase;
        }

        .kanban-card {
            background: #2B2B2B;
            border-radius: 10px;
            padding: 1.25rem;
            margin-bottom: 0.875rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            border: 1px solid rgba(184, 138, 68, 0.2);
            cursor: move;
            color: #F5F3EF;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .kanban-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(212, 175, 55, 0.25);
            border-color: rgba(212, 175, 55, 0.4);
            background: #2F2F2F;
        }

        .kanban-card.dragging {
            opacity: 0.5;
        }

        .kanban-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .kanban-tag {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            color: white;
            font-weight: 500;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: #1A1A1A;
        }

        .data-table th {
            padding: 1.125rem 1.25rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.8125rem;
            border-bottom: 2px solid rgba(212, 175, 55, 0.3);
            color: #D4AF37;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .data-table td {
            padding: 1.125rem 1.25rem;
            border-bottom: 1px solid rgba(184, 138, 68, 0.1);
            color: rgba(245, 243, 239, 0.9);
            font-size: 0.9375rem;
        }

        .data-table tbody tr {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .data-table tbody tr:hover {
            background: rgba(212, 175, 55, 0.05);
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-badge.lead { background: rgba(212, 175, 55, 0.2); color: #D4AF37; border: 1px solid #D4AF37; }
        .status-badge.cliente { background: rgba(184, 138, 68, 0.2); color: #B88A44; border: 1px solid #B88A44; }
        .status-badge.recorrente { background: rgba(212, 175, 55, 0.3); color: #D4AF37; border: 1px solid #D4AF37; }

        /* Products Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .product-card {
            background: linear-gradient(135deg, #1A1A1A 0%, #2B2B2B 100%);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            border: 1px solid rgba(184, 138, 68, 0.15);
            color: #F5F3EF;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .product-card:hover {
            transform: translateY(-4px);
            border-color: rgba(212, 175, 55, 0.3);
            box-shadow: 0 8px 24px rgba(0,0,0,0.6);
        }

        .product-card h3 {
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }

        .product-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #F5F3EF;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1A1A1A;
            border-radius: 16px;
            width: 90%;
            max-width: 520px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(212, 175, 55, 0.2);
            color: #F5F3EF;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        }

        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #0F0F0F;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(184, 138, 68, 0.3);
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(184, 138, 68, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem;
            border-bottom: 1px solid rgba(184, 138, 68, 0.15);
        }

        .modal-header h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            font-weight: 700;
            color: #D4AF37;
            letter-spacing: -0.02em;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .modal-content form {
            padding: 2rem;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }

        .sale-item-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .sale-item-row select {
            flex: 2;
        }

        .sale-item-row input {
            flex: 1;
            max-width: 100px;
        }

        .sale-total {
            padding: 1.5rem;
            background: linear-gradient(135deg, #0F0F0F 0%, #1A1A1A 100%);
            border-radius: 10px;
            text-align: right;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 1.5rem 0;
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: #D4AF37;
            letter-spacing: -0.02em;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: rgba(184, 138, 68, 0.6);
            font-size: 0.9375rem;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 3rem;
            color: rgba(184, 138, 68, 0.6);
            font-size: 0.9375rem;
        }

        /* Smooth Transitions */
        * {
            transition: border-color 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Selection */
        ::selection {
            background: rgba(212, 175, 55, 0.3);
            color: #F5F3EF;
        }

        /* Focus States */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 2px solid #D4AF37;
            outline-offset: 2px;
        }

        /* Alerts */
        .alerts-container {
            margin-bottom: 2rem;
        }

        .alert-card {
            background: linear-gradient(135deg, #1A1A1A 0%, #2B2B2B 100%);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            border: 2px solid;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            animation: pulse 2s infinite;
        }

        .alert-urgent {
            border-color: #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, #1A1A1A 100%);
        }

        .alert-warning {
            border-color: #F59E0B;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, #1A1A1A 100%);
        }

        .alert-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .alert-urgent .alert-icon {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .alert-content {
            flex: 1;
        }

        .alert-content h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #F5F3EF;
        }

        .alert-content p {
            font-size: 0.875rem;
            color: rgba(245, 243, 239, 0.7);
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            }
            50% {
                box-shadow: 0 4px 24px rgba(239, 68, 68, 0.3);
            }
        }

        /* Priority Badges */
        .priority-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.625rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .priority-urgent {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.4);
        }

        .priority-high {
            background: rgba(245, 158, 11, 0.2);
            color: #F59E0B;
            border: 1px solid rgba(245, 158, 11, 0.4);
        }

        .priority-medium {
            background: rgba(212, 175, 55, 0.2);
            color: #D4AF37;
            border: 1px solid rgba(212, 175, 55, 0.4);
        }

        /* Kanban Card Enhancements */
        .kanban-card.priority {
            border-left: 4px solid;
        }

        .kanban-card.priority-urgent {
            border-left-color: #ef4444;
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, #2B2B2B 100%);
        }

        .kanban-card.priority-high {
            border-left-color: #F59E0B;
        }

        .kanban-card.overdue {
            animation: shake 0.5s;
        }

        .kanban-card .followup-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding: 0.5rem;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 6px;
            font-size: 0.8125rem;
        }

        .kanban-card .followup-indicator.overdue {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .kanban-card .days-in-column {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 0.75rem;
            color: rgba(184, 138, 68, 0.7);
            font-weight: 500;
        }

        .kanban-card {
            position: relative;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(184, 138, 68, 0.2);
        }

        .quick-action-btn {
            flex: 1;
            padding: 0.5rem;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 6px;
            color: #D4AF37;
            font-size: 0.8125rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .quick-action-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #D4AF37;
        }

        /* Hot Lead Indicator */
        .hot-lead {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 12px;
            height: 12px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
        }

        @keyframes pulse-dot {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 80px;
            }
            .nav-item span {
                display: none;
            }
            .main-content {
                padding: 1.5rem;
            }
            .page-header h1 {
                font-size: 2rem;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .kanban-column {
                min-width: 280px;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page.active {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card {
            animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="screen active">
        <div class="login-container">
            <div class="login-box">
                <div class="login-header">
                    <img src="https://zpqtcrfygjtjtacufgbv.supabase.co/storage/v1/object/public/logos/LOGO%20SEM%20FUNDO.png" alt="CJ Empórium Logo" />
                </div>
                <form id="login-form">
                    <div id="login-error" class="error-message"></div>
                    <div class="form-group">
                        <label><i class="fas fa-envelope"></i> E-mail</label>
                        <input type="email" id="email" value="admin@cjemporium.com" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> Senha</label>
                        <input type="password" id="password" value="admin123" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- App Screen -->
    <div id="app-screen" class="screen">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="https://zpqtcrfygjtjtacufgbv.supabase.co/storage/v1/object/public/logos/LOGO%20SEM%20FUNDO.png" alt="CJ Empórium Logo" />
            </div>
            <nav class="sidebar-nav">
                <a class="nav-item active" data-page="dashboard">
                    <i class="fas fa-chart-line"></i> <span>Dashboard</span>
                </a>
                <a class="nav-item" data-page="kanban">
                    <i class="fas fa-columns"></i> <span>Kanban</span>
                </a>
                <a class="nav-item" data-page="customers">
                    <i class="fas fa-users"></i> <span>Clientes</span>
                </a>
                <a class="nav-item" data-page="products">
                    <i class="fas fa-box"></i> <span>Produtos</span>
                </a>
                <a class="nav-item" data-page="sales">
                    <i class="fas fa-shopping-cart"></i> <span>Vendas</span>
                </a>
                <a class="nav-item" data-page="financial">
                    <i class="fas fa-chart-pie"></i> <span>Financeiro</span>
                </a>
                <a class="nav-item" data-page="recurrence">
                    <i class="fas fa-sync-alt"></i> <span>Recorrência</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <p class="user-name" id="user-name">Admin</p>
                    <p class="user-role" id="user-role">Administrador</p>
                </div>
                <button class="btn btn-secondary btn-block" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">
            <!-- Dashboard -->
            <div id="dashboard-page" class="page active">
                <div class="page-header">
                    <h1>Dashboard</h1>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-green">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div>
                            <p class="stat-label">Faturamento</p>
                            <p class="stat-value" id="stat-revenue">R$ 0,00</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-blue">
                            <i class="fas fa-users"></i>
                        </div>
                        <div>
                            <p class="stat-label">Total de Leads</p>
                            <p class="stat-value" id="stat-leads">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-purple">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div>
                            <p class="stat-label">Vendas</p>
                            <p class="stat-value" id="stat-sales">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-red">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div>
                            <p class="stat-label">Follow-ups</p>
                            <p class="stat-value" id="stat-followups">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kanban -->
            <div id="kanban-page" class="page">
                <div class="page-header">
                    <h1>CRM Kanban</h1>
                    <button class="btn btn-primary" id="add-customer-btn">
                        <i class="fas fa-plus"></i> Novo Cliente
                    </button>
                </div>
                <div class="kanban-board" id="kanban-board"></div>
            </div>

            <!-- Customers -->
            <div id="customers-page" class="page">
                <div class="page-header">
                    <h1>Clientes</h1>
                    <button class="btn btn-primary" id="add-customer-form-btn">
                        <i class="fas fa-plus"></i> Novo Cliente
                    </button>
                </div>
                <div class="card">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Telefone</th>
                                    <th>E-mail</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="customers-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Products -->
            <div id="products-page" class="page">
                <div class="page-header">
                    <h1>Produtos</h1>
                    <button class="btn btn-primary" id="add-product-btn">
                        <i class="fas fa-plus"></i> Novo Produto
                    </button>
                </div>
                <div class="products-grid" id="products-grid"></div>
            </div>

            <!-- Sales -->
            <div id="sales-page" class="page">
                <div class="page-header">
                    <h1>Vendas</h1>
                    <button class="btn btn-primary" id="add-sale-btn">
                        <i class="fas fa-plus"></i> Nova Venda
                    </button>
                </div>
                <div class="card">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Número</th>
                                    <th>Cliente</th>
                                    <th>Valor</th>
                                    <th>Status</th>
                                    <th>Data</th>
                                    <th>Certificados</th>
                                </tr>
                            </thead>
                            <tbody id="sales-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Financial -->
            <div id="financial-page" class="page">
                <div class="page-header">
                    <h1>Análise Financeira</h1>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <select id="financial-period" style="padding: 0.625rem 1rem; border: 1px solid rgba(184, 138, 68, 0.3); border-radius: 8px; background: #0F0F0F; color: #F5F3EF; font-size: 0.9375rem; cursor: pointer;">
                            <option value="month">Este Mês</option>
                            <option value="week">Esta Semana</option>
                            <option value="day">Hoje</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>
                </div>

                <!-- Financial Overview -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-green">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div>
                            <p class="stat-label">Receita Total</p>
                            <p class="stat-value" id="financial-revenue">R$ 0,00</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-blue">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div>
                            <p class="stat-label">Lucro Líquido</p>
                            <p class="stat-value" id="financial-profit">R$ 0,00</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-purple">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div>
                            <p class="stat-label">Margem</p>
                            <p class="stat-value" id="financial-margin">0%</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-red">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <div>
                            <p class="stat-label">Ticket Médio</p>
                            <p class="stat-value" id="financial-ticket">R$ 0,00</p>
                        </div>
                    </div>
                </div>

                <!-- Top Products -->
                <div class="card">
                    <h2>Produtos Mais Rentáveis</h2>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Produto</th>
                                    <th>Receita</th>
                                    <th>Lucro</th>
                                    <th>Margem</th>
                                    <th>Unidades</th>
                                </tr>
                            </thead>
                            <tbody id="top-products-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Top Customers -->
                <div class="card">
                    <h2>Clientes Mais Lucrativos</h2>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Cliente</th>
                                    <th>Receita Total</th>
                                    <th>Compras</th>
                                    <th>Ticket Médio</th>
                                    <th>Última Compra</th>
                                </tr>
                            </thead>
                            <tbody id="top-customers-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Recurrence -->
            <div id="recurrence-page" class="page">
                <div class="page-header">
                    <h1>Recorrência & Reativação</h1>
                </div>

                <!-- Reactivation Alerts -->
                <div id="reactivation-alerts" class="alerts-container" style="display: none;">
                    <div class="alert-card alert-warning">
                        <div class="alert-icon">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div class="alert-content">
                            <h3>Clientes para Reativar</h3>
                            <p id="reactivation-count">0 clientes precisam de atenção</p>
                        </div>
                    </div>
                </div>

                <!-- Ready for Repurchase -->
                <div class="card">
                    <h2>Clientes Aptos à Recompra</h2>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Compras</th>
                                    <th>Intervalo Médio</th>
                                    <th>Última Compra</th>
                                    <th>Dias Inativo</th>
                                    <th>Próxima Estimada</th>
                                    <th>Prioridade</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="ready-repurchase-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Reactivation List -->
                <div class="card">
                    <h2>Alertas de Reativação</h2>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Dias Inativo</th>
                                    <th>Intervalo Médio</th>
                                    <th>Valor Total</th>
                                    <th>Última Compra</th>
                                    <th>Prioridade</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="reactivation-list-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="customer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Novo Cliente</h2>
                <button class="modal-close" data-modal="customer-modal" style="color: rgba(245, 243, 239, 0.6);">&times;</button>
            </div>
            <form id="customer-form">
                <div class="form-group">
                    <label>Nome *</label>
                    <input type="text" id="customer-name" required>
                </div>
                <div class="form-group">
                    <label>Telefone</label>
                    <input type="text" id="customer-phone">
                </div>
                <div class="form-group">
                    <label>E-mail</label>
                    <input type="email" id="customer-email">
                </div>
                <div class="form-group">
                    <label>Origem</label>
                    <input type="text" id="customer-origin">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-modal="customer-modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Novo Produto</h2>
                <button class="modal-close" data-modal="product-modal" style="color: rgba(245, 243, 239, 0.6);">&times;</button>
            </div>
            <form id="product-form">
                <div class="form-group">
                    <label>Nome *</label>
                    <input type="text" id="product-name" required>
                </div>
                <div class="form-group">
                    <label>Marca</label>
                    <input type="text" id="product-brand">
                </div>
                <div class="form-group">
                    <label>Concentração</label>
                    <input type="text" id="product-concentration" placeholder="Ex: Eau de Parfum">
                </div>
                <div class="form-group">
                    <label>Volume</label>
                    <input type="text" id="product-volume" placeholder="Ex: 100ml">
                </div>
                <div class="form-group">
                    <label>Lote</label>
                    <input type="text" id="product-batch" placeholder="Número do lote">
                </div>
                <div class="form-group">
                    <label>Origem</label>
                    <input type="text" id="product-origin" placeholder="País de origem">
                </div>
                <div class="form-group">
                    <label>Preço *</label>
                    <input type="number" step="0.01" id="product-price" required>
                </div>
                <div class="form-group">
                    <label>Custo</label>
                    <input type="number" step="0.01" id="product-cost" placeholder="Para cálculo de margem">
                </div>
                <div class="form-group">
                    <label>Estoque</label>
                    <input type="number" id="product-stock" value="0">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-modal="product-modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="sale-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nova Venda</h2>
                <button class="modal-close" data-modal="sale-modal" style="color: rgba(245, 243, 239, 0.6);">&times;</button>
            </div>
            <form id="sale-form">
                <div class="form-group">
                    <label>Cliente</label>
                    <select id="sale-customer">
                        <option value="">Selecione</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Produtos</label>
                    <div id="sale-items"></div>
                    <button type="button" class="btn btn-secondary btn-sm" id="add-sale-item">
                        <i class="fas fa-plus"></i> Adicionar
                    </button>
                </div>
                <div class="sale-total">
                    Total: R$ <span id="sale-total">0,00</span>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-modal="sale-modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Finalizar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Certificate Modal -->
    <div id="certificate-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Certificados de Autenticidade</h2>
                <button class="modal-close" data-modal="certificate-modal" style="color: rgba(245, 243, 239, 0.6);">&times;</button>
            </div>
            <div id="certificates-list" style="padding: 1.5rem;">
                <!-- Certificados serão listados aqui -->
            </div>
        </div>
    </div>

    <script>
        // Dados salvos no localStorage
            let customers = JSON.parse(localStorage.getItem('customers') || '[]');
            let products = JSON.parse(localStorage.getItem('products') || '[]');
            let sales = JSON.parse(localStorage.getItem('sales') || '[]');
            let certificates = JSON.parse(localStorage.getItem('certificates') || '[]');
            let currentPage = 'dashboard'; // Página atual
            
            // Calcular dias na coluna e follow-ups vencidos
            function updateCustomerMetrics() {
                const now = new Date();
                customers.forEach(customer => {
                    // Calcular dias na coluna atual
                    if (customer.created_at) {
                        const created = new Date(customer.created_at);
                        customer.days_in_current_column = Math.floor(
                            (now - created) / (1000 * 60 * 60 * 24)
                        );
                    } else {
                        customer.days_in_current_column = 0;
                    }
                    
                    // Verificar follow-up vencido
                    if (customer.next_followup_date) {
                        const followupDate = new Date(customer.next_followup_date);
                        customer.followup_overdue = followupDate < now;
                    } else {
                        customer.followup_overdue = false;
                    }
                });
            }
            
            // Atualizar métricas periodicamente
            updateCustomerMetrics();
            setInterval(updateCustomerMetrics, 60000); // Atualizar a cada minuto
            let kanbanColumns = [
            { id: 1, name: 'Novo Lead', color: '#D4AF37', customers: [] },
            { id: 2, name: 'Contato Realizado', color: '#B88A44', customers: [] },
            { id: 3, name: 'Em Negociação', color: '#D4AF37', customers: [] },
            { id: 4, name: 'Aguardando Retorno', color: '#B88A44', customers: [] },
            { id: 5, name: 'Venda Concluída', color: '#D4AF37', customers: [] },
            { id: 6, name: 'Pós-venda', color: '#B88A44', customers: [] },
            { id: 7, name: 'Perdido', color: '#2B2B2B', customers: [] }
        ];

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            loadKanbanData();
            setupEventListeners();
            if (localStorage.getItem('loggedIn') === 'true') {
                showApp();
                loadPage('dashboard');
            }
        });

        function setupEventListeners() {
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                localStorage.setItem('loggedIn', 'true');
                showApp();
                loadPage('dashboard');
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.setItem('loggedIn', 'false');
                showLogin();
            });

            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    loadPage(item.dataset.page);
                });
            });

            document.getElementById('add-customer-btn')?.addEventListener('click', () => openModal('customer-modal'));
            document.getElementById('add-customer-form-btn')?.addEventListener('click', () => openModal('customer-modal'));
            document.getElementById('add-product-btn')?.addEventListener('click', () => openModal('product-modal'));
            document.getElementById('add-sale-btn')?.addEventListener('click', () => {
                openModal('sale-modal');
                loadSaleForm();
            });

            document.querySelectorAll('.modal-close, [data-modal]').forEach(btn => {
                if (btn.type === 'button' || btn.classList.contains('modal-close')) {
                    btn.addEventListener('click', () => {
                        const modalId = btn.dataset.modal || btn.closest('.modal')?.id;
                        if (modalId) closeModal(modalId);
                    });
                }
            });

            document.getElementById('customer-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const customer = {
                    id: Date.now(),
                    name: document.getElementById('customer-name').value,
                    phone: document.getElementById('customer-phone').value,
                    email: document.getElementById('customer-email').value,
                    origin: document.getElementById('customer-origin').value,
                    status: 'lead',
                    kanbanColumnId: 1,
                    tags: [],
                    created_at: new Date().toISOString(),
                    next_followup_date: null,
                    followup_overdue: false,
                    days_in_current_column: 0,
                    total_sales: 0,
                    is_recurring: false,
                    contacts: []
                };
                customers.push(customer);
                saveData();
                closeModal('customer-modal');
                loadCustomers();
                loadKanban();
                loadDashboard();
            });

            document.getElementById('product-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const price = parseFloat(document.getElementById('product-price').value);
                const cost = document.getElementById('product-cost').value ? 
                    parseFloat(document.getElementById('product-cost').value) : null;
                
                const product = {
                    id: Date.now(),
                    name: document.getElementById('product-name').value,
                    brand: document.getElementById('product-brand').value,
                    concentration: document.getElementById('product-concentration').value || '',
                    volume: document.getElementById('product-volume').value || '',
                    batch: document.getElementById('product-batch').value || '',
                    origin: document.getElementById('product-origin').value || '',
                    price: price,
                    cost: cost,
                    stock: parseInt(document.getElementById('product-stock').value) || 0
                };
                products.push(product);
                saveData();
                closeModal('product-modal');
                loadProducts();
            });

            document.getElementById('sale-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const items = [];
                document.querySelectorAll('.sale-item-row').forEach(row => {
                    const productId = parseInt(row.querySelector('.sale-item-product').value);
                    const quantity = parseInt(row.querySelector('.sale-item-quantity').value);
                    if (productId && quantity) {
                        items.push({ productId, quantity });
                    }
                });
                if (items.length === 0) {
                    alert('Adicione pelo menos um produto');
                    return;
                }
                let total = 0;
                const saleItems = [];
                
                items.forEach(item => {
                    const product = products.find(p => p.id === item.productId);
                    if (product) {
                        const itemTotal = product.price * item.quantity;
                        total += itemTotal;
                        product.stock = Math.max(0, product.stock - item.quantity);
                        
                        saleItems.push({
                            productId: item.productId,
                            quantity: item.quantity,
                            unitPrice: product.price,
                            totalPrice: itemTotal
                        });
                    }
                });
                
                const sale = {
                    id: Date.now(),
                    number: 'V' + Date.now().toString().slice(-6),
                    customerId: parseInt(document.getElementById('sale-customer').value) || null,
                    items: saleItems,
                    total,
                    date: new Date().toISOString(),
                    status: 'completed'
                };
                sales.push(sale);
                
                // Atualizar cliente se houver
                if (sale.customerId) {
                    const customer = customers.find(c => c.id === sale.customerId);
                    if (customer) {
                        customer.total_sales = (customer.total_sales || 0) + sale.total;
                        customer.last_sale_date = sale.date;
                        const customerSales = sales.filter(s => s.customerId === customer.id);
                        if (customerSales.length > 1 && !customer.is_recurring) {
                            customer.is_recurring = true;
                            customer.status = 'recorrente';
                        }
                    }
                }
                
                // Gerar certificados automaticamente para cada produto vendido
                saleItems.forEach(item => {
                    const product = products.find(p => p.id === item.productId);
                    if (product && sale.customerId) {
                        generateCertificate(sale, product, customers.find(c => c.id === sale.customerId));
                    }
                });
                
                saveData();
                closeModal('sale-modal');
                loadSales();
                loadProducts();
                loadCustomers();
                loadDashboard();
                if (currentPage === 'financial') loadFinancial();
                if (currentPage === 'recurrence') loadRecurrence();
            });

            document.getElementById('add-sale-item').addEventListener('click', addSaleItem);
        }

        function showLogin() {
            document.getElementById('login-screen').classList.add('active');
            document.getElementById('app-screen').classList.remove('active');
        }

        function showApp() {
            document.getElementById('login-screen').classList.remove('active');
            document.getElementById('app-screen').classList.add('active');
        }

        function loadPage(page) {
            currentPage = page; // Atualizar página atual
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === page) item.classList.add('active');
            });
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`${page}-page`).classList.add('active');
            
            switch(page) {
                case 'dashboard': loadDashboard(); break;
                case 'kanban': loadKanban(); break;
                case 'customers': loadCustomers(); break;
                case 'products': loadProducts(); break;
                case 'sales': loadSales(); break;
                case 'financial': loadFinancial(); break;
                case 'recurrence': loadRecurrence(); break;
            }
        }

        function loadDashboard() {
            updateCustomerMetrics();
            const totalRevenue = sales.reduce((sum, s) => sum + s.total, 0);
            const totalLeads = customers.length;
            const totalSales = sales.length;
            const overdueCount = customers.filter(c => c.followup_overdue).length;
            
            document.getElementById('stat-revenue').textContent = 
                'R$ ' + totalRevenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            document.getElementById('stat-leads').textContent = totalLeads;
            document.getElementById('stat-sales').textContent = totalSales;
            document.getElementById('stat-followups').textContent = overdueCount;
            
            // Mostrar alerta se houver follow-ups vencidos
            const alertsContainer = document.getElementById('followup-alerts');
            if (alertsContainer) {
                if (overdueCount > 0) {
                    alertsContainer.style.display = 'block';
                    const overdueCountEl = document.getElementById('overdue-count');
                    if (overdueCountEl) {
                        overdueCountEl.textContent = 
                            `${overdueCount} ${overdueCount === 1 ? 'cliente precisa' : 'clientes precisam'} de atenção imediata`;
                    }
                } else {
                    alertsContainer.style.display = 'none';
                }
            }
        }

        function loadKanbanData() {
            kanbanColumns.forEach(col => col.customers = []);
            customers.forEach(customer => {
                const col = kanbanColumns.find(c => c.id === customer.kanbanColumnId || c.id === 1);
                if (col) col.customers.push(customer);
            });
        }

        function loadKanban() {
            loadKanbanData();
            const board = document.getElementById('kanban-board');
            board.innerHTML = '';
            
            kanbanColumns.forEach(column => {
                const colDiv = document.createElement('div');
                colDiv.className = 'kanban-column';
                colDiv.dataset.columnId = column.id;
                
                const header = document.createElement('div');
                header.className = 'kanban-column-header';
                header.style.borderColor = column.color;
                header.style.color = column.color;
                header.textContent = `${column.name} (${column.customers.length})`;
                
                const cardsContainer = document.createElement('div');
                cardsContainer.className = 'kanban-cards';
                cardsContainer.dataset.columnId = column.id;
                
                // Ordenar clientes por prioridade
                const sortedCustomers = [...column.customers].sort((a, b) => {
                    // Priorizar follow-ups vencidos
                    if (a.followup_overdue && !b.followup_overdue) return -1;
                    if (!a.followup_overdue && b.followup_overdue) return 1;
                    // Depois por tempo na coluna
                    return (b.days_in_current_column || 0) - (a.days_in_current_column || 0);
                });
                
                sortedCustomers.forEach(customer => {
                    const card = createKanbanCard(customer);
                    cardsContainer.appendChild(card);
                });
                
                colDiv.appendChild(header);
                colDiv.appendChild(cardsContainer);
                board.appendChild(colDiv);
            });
            
            setupDragDrop();
        }

        function createKanbanCard(customer) {
            const card = document.createElement('div');
            card.className = 'kanban-card';
            card.draggable = true;
            card.dataset.customerId = customer.id;
            
            // Prioridade e classes
            const isOverdue = customer.followup_overdue || false;
            const daysInColumn = customer.days_in_current_column || 0;
            const isHotLead = customer.tags && customer.tags.some(t => 
                t.name && t.name.toLowerCase().includes('quente')
            );
            
            if (isOverdue) {
                card.classList.add('priority', 'priority-urgent', 'overdue');
            } else if (daysInColumn > 5) {
                card.classList.add('priority', 'priority-high');
            } else if (isHotLead) {
                card.classList.add('priority', 'priority-medium');
            }
            
            // Tags
            let tagsHtml = '';
            if (customer.tags && customer.tags.length > 0) {
                tagsHtml = '<div class="kanban-tags">';
                customer.tags.forEach(tag => {
                    tagsHtml += `<span class="kanban-tag" style="background-color: ${tag.color || '#D4AF37'}">${tag.icon || ''} ${tag.name}</span>`;
                });
                tagsHtml += '</div>';
            }
            
            // Follow-up indicator
            let followupHtml = '';
            if (customer.next_followup_date || isOverdue) {
                const followupDate = customer.next_followup_date ? 
                    new Date(customer.next_followup_date) : null;
                const isOverdueFollowup = followupDate && followupDate < new Date();
                
                followupHtml = `
                    <div class="followup-indicator ${isOverdueFollowup ? 'overdue' : ''}">
                        <i class="fas fa-calendar-alt"></i>
                        <span>
                            ${isOverdueFollowup ? 
                                `Vencido há ${Math.floor((new Date() - followupDate) / (1000*60*60*24))} dias` :
                                followupDate ? `Próximo: ${followupDate.toLocaleDateString('pt-BR')}` :
                                'Sem follow-up definido'
                            }
                        </span>
                    </div>
                `;
            } else if (daysInColumn > 3) {
                followupHtml = `
                    <div class="followup-indicator">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>Sem follow-up há ${daysInColumn} dias</span>
                    </div>
                `;
            }
            
            // Quick actions
            const quickActions = `
                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="quickContact(${customer.id}, 'whatsapp')">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                    <button class="quick-action-btn" onclick="quickContact(${customer.id}, 'call')">
                        <i class="fas fa-phone"></i> Ligar
                    </button>
                    <button class="quick-action-btn" onclick="scheduleFollowup(${customer.id})">
                        <i class="fas fa-calendar-plus"></i> Follow-up
                    </button>
                </div>
            `;
            
            card.innerHTML = `
                ${isHotLead ? '<div class="hot-lead"></div>' : ''}
                ${daysInColumn > 0 ? `<span class="days-in-column">${daysInColumn}d</span>` : ''}
                <h3>${customer.name}</h3>
                ${customer.phone ? `<p><i class="fas fa-phone"></i> ${customer.phone}</p>` : ''}
                ${customer.email ? `<p><i class="fas fa-envelope"></i> ${customer.email}</p>` : ''}
                ${tagsHtml}
                ${followupHtml}
                ${quickActions}
            `;
            
            return card;
        }

        function setupDragDrop() {
            document.querySelectorAll('.kanban-card').forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('customerId', card.dataset.customerId);
                    card.classList.add('dragging');
                });
                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                });
            });
            
            document.querySelectorAll('.kanban-cards').forEach(container => {
                container.addEventListener('dragover', (e) => e.preventDefault());
                container.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const customerId = parseInt(e.dataTransfer.getData('customerId'));
                    const toColumnId = parseInt(container.dataset.columnId);
                    const customer = customers.find(c => c.id === customerId);
                    if (customer) {
                        customer.kanbanColumnId = toColumnId;
                        saveData();
                        loadKanban();
                    }
                });
            });
        }

        function loadCustomers() {
            const tbody = document.getElementById('customers-table-body');
            tbody.innerHTML = '';
            if (customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Nenhum cliente cadastrado</td></tr>';
                return;
            }
            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.name}</td>
                    <td>${customer.phone || '-'}</td>
                    <td>${customer.email || '-'}</td>
                    <td><span class="status-badge ${customer.status}">${customer.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="deleteCustomer(${customer.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadProducts() {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = '';
            if (products.length === 0) {
                grid.innerHTML = '<div class="empty-state">Nenhum produto cadastrado</div>';
                return;
            }
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                
                let marginHtml = '';
                if (product.cost && product.price) {
                    const margin = ((product.price - product.cost) / product.cost * 100);
                    marginHtml = `
                        <div class="product-info">
                            <span>Margem:</span>
                            <strong style="color: #D4AF37;">${margin.toFixed(1)}%</strong>
                        </div>
                    `;
                }
                
                card.innerHTML = `
                    <h3>${product.name}</h3>
                    ${product.brand ? `<p style="color: rgba(245, 243, 239, 0.6); font-size: 0.875rem;">${product.brand}</p>` : ''}
                    <div class="product-info">
                        <span>Preço:</span>
                        <strong>R$ ${product.price.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</strong>
                    </div>
                    ${product.cost ? `
                    <div class="product-info">
                        <span>Custo:</span>
                        <strong>R$ ${product.cost.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</strong>
                    </div>
                    ` : ''}
                    ${marginHtml}
                    <div class="product-info">
                        <span>Estoque:</span>
                        <strong>${product.stock || 0} unidades</strong>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function loadSales() {
            const tbody = document.getElementById('sales-table-body');
            tbody.innerHTML = '';
            if (sales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Nenhuma venda registrada</td></tr>';
                return;
            }
            sales.forEach(sale => {
                const customer = customers.find(c => c.id === sale.customerId);
                const saleDate = sale.date ? (typeof sale.date === 'string' ? new Date(sale.date) : sale.date) : new Date();
                const saleCertificates = certificates.filter(c => c.sale_id === sale.id);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${sale.number}</td>
                    <td>${customer ? customer.name : '-'}</td>
                    <td>R$ ${sale.total.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    <td><span class="status-badge cliente">${sale.status}</span></td>
                    <td>${saleDate instanceof Date ? saleDate.toLocaleDateString('pt-BR') : sale.date}</td>
                    <td>
                        ${saleCertificates.length > 0 ? `
                            <button class="btn btn-sm btn-primary" onclick="viewCertificates(${sale.id})" title="Ver Certificados">
                                <i class="fas fa-certificate"></i> Certificados (${saleCertificates.length})
                            </button>
                        ` : '<span style="color: rgba(245, 243, 239, 0.5);">-</span>'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadSaleForm() {
            const select = document.getElementById('sale-customer');
            select.innerHTML = '<option value="">Selecione</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                select.appendChild(option);
            });
            
            const itemsContainer = document.getElementById('sale-items');
            itemsContainer.innerHTML = '';
            addSaleItem();
        }

        function addSaleItem() {
            const container = document.getElementById('sale-items');
            const row = document.createElement('div');
            row.className = 'sale-item-row';
            
            const select = document.createElement('select');
            select.className = 'sale-item-product';
            select.innerHTML = '<option value="">Selecione produto</option>';
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} - R$ ${product.price.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                option.dataset.price = product.price;
                select.appendChild(option);
            });
            select.addEventListener('change', calculateTotal);
            
            const quantity = document.createElement('input');
            quantity.type = 'number';
            quantity.className = 'sale-item-quantity';
            quantity.value = '1';
            quantity.min = '1';
            quantity.addEventListener('input', calculateTotal);
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-danger btn-sm';
            removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
            removeBtn.onclick = () => {
                row.remove();
                calculateTotal();
            };
            
            row.appendChild(select);
            row.appendChild(quantity);
            row.appendChild(removeBtn);
            container.appendChild(row);
        }

        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('.sale-item-row').forEach(row => {
                const select = row.querySelector('.sale-item-product');
                const quantity = parseInt(row.querySelector('.sale-item-quantity').value) || 0;
                const price = parseFloat(select.selectedOptions[0]?.dataset.price || 0);
                total += price * quantity;
            });
            document.getElementById('sale-total').textContent = 
                total.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        }

        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
            if (id === 'customer-modal') {
                document.getElementById('customer-form').reset();
            }
            if (id === 'product-modal') {
                document.getElementById('product-form').reset();
            }
            if (id === 'sale-modal') {
                document.getElementById('sale-form').reset();
            }
            if (id === 'certificate-modal') {
                document.getElementById('certificates-list').innerHTML = '';
            }
            if (id === 'certificate-modal') {
                document.getElementById('certificates-list').innerHTML = '';
            }
        }

        function saveData() {
            localStorage.setItem('customers', JSON.stringify(customers));
            localStorage.setItem('products', JSON.stringify(products));
            localStorage.setItem('sales', JSON.stringify(sales));
            localStorage.setItem('certificates', JSON.stringify(certificates));
        }

        function deleteCustomer(id) {
            if (confirm('Deseja realmente excluir este cliente?')) {
                customers = customers.filter(c => c.id !== id);
                saveData();
                loadCustomers();
                loadKanban();
                loadDashboard();
            }
        }

        window.deleteCustomer = deleteCustomer;

        // Quick Actions
        function quickContact(customerId, type) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            if (type === 'whatsapp' && customer.whatsapp) {
                window.open(`https://wa.me/55${customer.whatsapp.replace(/\D/g, '')}`, '_blank');
            } else if (type === 'whatsapp' && customer.phone) {
                window.open(`https://wa.me/55${customer.phone.replace(/\D/g, '')}`, '_blank');
            } else if (type === 'call' && customer.phone) {
                window.location.href = `tel:${customer.phone}`;
            }
            
            // Registrar contato
            if (!customer.contacts) customer.contacts = [];
            customer.contacts.push({
                type: type,
                date: new Date().toISOString(),
                direction: 'outbound'
            });
            saveData();
        }

        function scheduleFollowup(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            const dateStr = prompt('Data do follow-up (DD/MM/YYYY):');
            if (dateStr) {
                const [day, month, year] = dateStr.split('/');
                const followupDate = new Date(year, month - 1, day);
                customer.next_followup_date = followupDate.toISOString();
                customer.followup_overdue = false;
                saveData();
                updateCustomerMetrics();
                loadKanban();
                alert('Follow-up agendado com sucesso!');
            }
        }

        window.quickContact = quickContact;
        window.scheduleFollowup = scheduleFollowup;

        // Financial Analysis
        function loadFinancial() {
            updateCustomerMetrics();
            
            const periodSelect = document.getElementById('financial-period');
            const periodValue = periodSelect ? periodSelect.value : 'month';
            
            const now = new Date();
            let startDate, endDate;
            
            switch(periodValue) {
                case 'day':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                    break;
                case 'week':
                    const dayOfWeek = now.getDay();
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - dayOfWeek);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'month':
                default:
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                    break;
            }
            
            const periodSales = sales.filter(sale => {
                if (!sale.date) return false;
                const saleDate = typeof sale.date === 'string' ? new Date(sale.date) : sale.date;
                return saleDate >= startDate && saleDate <= endDate;
            });
            
            let totalRevenue = 0;
            let totalCosts = 0;
            
            periodSales.forEach(sale => {
                totalRevenue += sale.total || 0;
                if (sale.items && Array.isArray(sale.items)) {
                    sale.items.forEach(item => {
                        const product = products.find(p => p.id === item.productId);
                        if (product && product.cost) {
                            totalCosts += (product.cost || 0) * (item.quantity || 0);
                        }
                    });
                }
            });
            
            const profit = totalRevenue - totalCosts;
            const margin = totalRevenue > 0 ? (profit / totalRevenue * 100) : 0;
            const averageTicket = periodSales.length > 0 ? totalRevenue / periodSales.length : 0;
            
            document.getElementById('financial-revenue').textContent = 
                'R$ ' + totalRevenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            document.getElementById('financial-profit').textContent = 
                'R$ ' + profit.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            document.getElementById('financial-margin').textContent = 
                margin.toFixed(1) + '%';
            document.getElementById('financial-ticket').textContent = 
                'R$ ' + averageTicket.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            
            loadTopProducts(periodSales);
            loadTopCustomers(periodSales);
        }

        function loadTopProducts(periodSales) {
            const productMap = new Map();
            
            periodSales.forEach(sale => {
                if (sale.items && Array.isArray(sale.items)) {
                    sale.items.forEach(item => {
                        const product = products.find(p => p.id === item.productId);
                        if (!product) return;
                        
                        const existing = productMap.get(item.productId) || {
                            name: product.name,
                            revenue: 0,
                            costs: 0,
                            units: 0
                        };
                        
                        existing.revenue += (item.quantity || 0) * (product.price || 0);
                        existing.costs += (item.quantity || 0) * (product.cost || 0);
                        existing.units += (item.quantity || 0);
                        
                        productMap.set(item.productId, existing);
                    });
                }
            });
            
            const profitability = Array.from(productMap.entries())
                .map(([id, data]) => ({
                    id,
                    ...data,
                    profit: data.revenue - data.costs,
                    margin: data.revenue > 0 ? ((data.revenue - data.costs) / data.revenue * 100) : 0
                }))
                .sort((a, b) => b.profit - a.profit)
                .slice(0, 10);
            
            const tbody = document.getElementById('top-products-body');
            tbody.innerHTML = '';
            
            if (profitability.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Nenhum dado no período</td></tr>';
                return;
            }
            
            profitability.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="priority-badge priority-medium">#${index + 1}</span></td>
                    <td>${item.name}</td>
                    <td>R$ ${item.revenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    <td>R$ ${item.profit.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    <td>${item.margin.toFixed(1)}%</td>
                    <td>${item.units}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadTopCustomers(periodSales) {
            const customerMap = new Map();
            
            periodSales.forEach(sale => {
                if (!sale.customerId) return;
                const customer = customers.find(c => c.id === sale.customerId);
                if (!customer) return;
                
                const existing = customerMap.get(sale.customerId) || {
                    name: customer.name,
                    revenue: 0,
                    purchases: 0,
                    lastPurchase: null
                };
                
                existing.revenue += sale.total || 0;
                existing.purchases += 1;
                const saleDate = sale.date ? (typeof sale.date === 'string' ? new Date(sale.date) : sale.date) : new Date();
                if (!existing.lastPurchase || saleDate > existing.lastPurchase) {
                    existing.lastPurchase = saleDate;
                }
                
                customerMap.set(sale.customerId, existing);
            });
            
            const profitability = Array.from(customerMap.entries())
                .map(([id, data]) => ({
                    id,
                    ...data,
                    averageTicket: data.purchases > 0 ? data.revenue / data.purchases : 0
                }))
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 10);
            
            const tbody = document.getElementById('top-customers-body');
            tbody.innerHTML = '';
            
            if (profitability.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Nenhum dado no período</td></tr>';
                return;
            }
            
            profitability.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="priority-badge priority-medium">#${index + 1}</span></td>
                    <td>${item.name}</td>
                    <td>R$ ${item.revenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    <td>${item.purchases}</td>
                    <td>R$ ${item.averageTicket.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    <td>${item.lastPurchase ? item.lastPurchase.toLocaleDateString('pt-BR') : '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Recurrence Analysis
        function loadRecurrence() {
            updateCustomerMetrics();
            
            const readyCustomers = getCustomersReadyForRepurchase();
            const reactivationAlerts = generateReactivationAlerts();
            
            const alertsContainer = document.getElementById('reactivation-alerts');
            if (reactivationAlerts.length > 0) {
                alertsContainer.style.display = 'block';
                document.getElementById('reactivation-count').textContent = 
                    `${reactivationAlerts.length} ${reactivationAlerts.length === 1 ? 'cliente precisa' : 'clientes precisam'} de reativação`;
            } else {
                alertsContainer.style.display = 'none';
            }
            
            loadReadyForRepurchase(readyCustomers);
            loadReactivationAlerts(reactivationAlerts);
        }

        function getCustomersReadyForRepurchase() {
            const ready = [];
            
            customers.forEach(customer => {
                if (customer.status === 'perdido') return;
                
                const customerSales = sales.filter(s => s.customerId === customer.id);
                if (customerSales.length < 2) return;
                
                const sortedSales = customerSales.sort((a, b) => {
                    const dateA = a.date ? (typeof a.date === 'string' ? new Date(a.date) : a.date) : new Date(0);
                    const dateB = b.date ? (typeof b.date === 'string' ? new Date(b.date) : b.date) : new Date(0);
                    return dateA - dateB;
                });
                
                let totalDays = 0;
                for (let i = 1; i < sortedSales.length; i++) {
                    const prev = sortedSales[i - 1].date ? (typeof sortedSales[i - 1].date === 'string' ? new Date(sortedSales[i - 1].date) : sortedSales[i - 1].date) : new Date(0);
                    const curr = sortedSales[i].date ? (typeof sortedSales[i].date === 'string' ? new Date(sortedSales[i].date) : sortedSales[i].date) : new Date(0);
                    totalDays += Math.floor((curr - prev) / (1000 * 60 * 60 * 24));
                }
                
                const avgInterval = Math.round(totalDays / (sortedSales.length - 1));
                const lastSale = sortedSales[sortedSales.length - 1];
                const lastDate = lastSale.date ? (typeof lastSale.date === 'string' ? new Date(lastSale.date) : lastSale.date) : new Date();
                const daysSince = Math.floor((new Date() - lastDate) / (1000 * 60 * 60 * 24));
                
                if (daysSince >= avgInterval) {
                    const nextEstimate = new Date(lastDate);
                    nextEstimate.setDate(nextEstimate.getDate() + avgInterval);
                    
                    ready.push({
                        customer,
                        totalPurchases: sortedSales.length,
                        avgInterval,
                        lastPurchase: lastDate,
                        daysInactive: daysSince,
                        nextEstimate,
                        priority: daysSince > avgInterval * 1.3 ? 'high' : 
                                 daysSince > avgInterval * 0.9 ? 'medium' : 'low'
                    });
                }
            });
            
            return ready.sort((a, b) => (b.customer.total_sales || 0) - (a.customer.total_sales || 0));
        }

        function generateReactivationAlerts() {
            const alerts = [];
            
            customers.forEach(customer => {
                if (customer.status === 'perdido') return;
                
                const customerSales = sales.filter(s => s.customerId === customer.id);
                if (customerSales.length < 1) return;
                
                const sortedByDate = customerSales.sort((a, b) => {
                    const dateA = a.date ? (typeof a.date === 'string' ? new Date(a.date) : a.date) : new Date(0);
                    const dateB = b.date ? (typeof b.date === 'string' ? new Date(b.date) : b.date) : new Date(0);
                    return dateB - dateA;
                });
                const lastSale = sortedByDate[0];
                
                const lastDate = lastSale.date ? (typeof lastSale.date === 'string' ? new Date(lastSale.date) : lastSale.date) : new Date();
                const daysInactive = Math.floor((new Date() - lastDate) / (1000 * 60 * 60 * 24));
                
                let avgInterval = 30;
                if (customerSales.length >= 2) {
                    const intervals = [];
                    const sorted = customerSales.sort((a, b) => {
                        const dateA = a.date ? (typeof a.date === 'string' ? new Date(a.date) : a.date) : new Date(0);
                        const dateB = b.date ? (typeof b.date === 'string' ? new Date(b.date) : b.date) : new Date(0);
                        return dateA - dateB;
                    });
                    for (let i = 1; i < sorted.length; i++) {
                        const prev = sorted[i - 1].date ? (typeof sorted[i - 1].date === 'string' ? new Date(sorted[i - 1].date) : sorted[i - 1].date) : new Date(0);
                        const curr = sorted[i].date ? (typeof sorted[i].date === 'string' ? new Date(sorted[i].date) : sorted[i].date) : new Date(0);
                        intervals.push(Math.floor((curr - prev) / (1000 * 60 * 60 * 24)));
                    }
                    avgInterval = Math.round(intervals.reduce((a, b) => a + b, 0) / intervals.length);
                }
                
                if (daysInactive >= avgInterval * 0.8) {
                    const totalLTV = customerSales.reduce((sum, s) => sum + (s.total || 0), 0);
                    
                    alerts.push({
                        customer,
                        daysInactive,
                        avgInterval,
                        lastPurchaseValue: lastSale.total || 0,
                        totalLTV,
                        priority: daysInactive > avgInterval * 1.3 ? 'high' : 
                                 daysInactive > avgInterval * 0.9 ? 'medium' : 'low'
                    });
                }
            });
            
            return alerts.sort((a, b) => {
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                const diff = priorityOrder[a.priority] - priorityOrder[b.priority];
                return diff !== 0 ? diff : b.totalLTV - a.totalLTV;
            });
        }

        function loadReadyForRepurchase(readyCustomers) {
            const tbody = document.getElementById('ready-repurchase-body');
            tbody.innerHTML = '';
            
            if (readyCustomers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Nenhum cliente apto à recompra no momento</td></tr>';
                return;
            }
            
            readyCustomers.forEach(item => {
                const row = document.createElement('tr');
                const priorityClass = item.priority === 'high' ? 'priority-urgent' : 
                                     item.priority === 'medium' ? 'priority-high' : 'priority-medium';
                
                row.innerHTML = `
                    <td>${item.customer.name}</td>
                    <td>${item.totalPurchases}</td>
                    <td>${item.avgInterval} dias</td>
                    <td>${item.lastPurchase.toLocaleDateString('pt-BR')}</td>
                    <td>${item.daysInactive} dias</td>
                    <td>${item.nextEstimate.toLocaleDateString('pt-BR')}</td>
                    <td><span class="priority-badge ${priorityClass}">${item.priority}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="quickContact(${item.customer.id}, 'whatsapp')">
                            <i class="fab fa-whatsapp"></i> Contatar
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadReactivationAlerts(alerts) {
            const tbody = document.getElementById('reactivation-list-body');
            tbody.innerHTML = '';
            
            if (alerts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Nenhum alerta de reativação</td></tr>';
                return;
            }
            
            alerts.forEach(alert => {
                const row = document.createElement('tr');
                const priorityClass = alert.priority === 'high' ? 'priority-urgent' : 
                                     alert.priority === 'medium' ? 'priority-high' : 'priority-medium';
                
                row.innerHTML = `
                    <td>${alert.customer.name}</td>
                    <td>${alert.daysInactive} dias</td>
                    <td>${alert.avgInterval} dias</td>
                    <td>R$ ${alert.totalLTV.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    <td>R$ ${alert.lastPurchaseValue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    <td><span class="priority-badge ${priorityClass}">${alert.priority}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="quickContact(${alert.customer.id}, 'whatsapp')">
                            <i class="fab fa-whatsapp"></i> Reativar
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Atualizar quando período mudar
        const periodSelect = document.getElementById('financial-period');
        if (periodSelect) {
            periodSelect.addEventListener('change', () => {
                if (currentPage === 'financial') {
                    loadFinancial();
                }
            });
        }

        // Certificate Functions
        function generateCertificate(sale, product, customer) {
            if (!sale || !product || !customer) return;
            
            // Verificar se já existe certificado para esta venda e produto
            const existing = certificates.find(c => 
                c.sale_id === sale.id && 
                c.product_id === product.id && 
                c.customer_id === customer.id
            );
            
            if (existing) return; // Não duplicar
            
            // Gerar código único
            const certificateCode = 'CJ-' + Date.now().toString(36).toUpperCase() + '-' + 
                Math.random().toString(36).substring(2, 6).toUpperCase();
            
            const certificate = {
                id: Date.now(),
                code: certificateCode,
                sale_id: sale.id,
                sale_number: sale.number,
                product_id: product.id,
                product_name: product.name,
                product_brand: product.brand || '',
                product_concentration: product.concentration || '',
                product_volume: product.volume || '',
                product_batch: product.batch || '',
                product_origin: product.origin || '',
                customer_id: customer.id,
                customer_name: customer.name,
                customer_code: customer.id.toString(),
                issue_date: new Date().toISOString(),
                sale_date: sale.date
            };
            
            certificates.push(certificate);
            
            // Adicionar ao cliente
            if (!customer.certificates) customer.certificates = [];
            customer.certificates.push(certificate.id);
            
            return certificate;
        }

        function viewCertificates(saleId) {
            const saleCertificates = certificates.filter(c => c.sale_id === saleId);
            
            if (saleCertificates.length === 0) {
                alert('Nenhum certificado encontrado para esta venda.');
                return;
            }
            
            const listContainer = document.getElementById('certificates-list');
            listContainer.innerHTML = '';
            
            saleCertificates.forEach(cert => {
                const certCard = document.createElement('div');
                certCard.style.cssText = 'background: #2B2B2B; padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid rgba(212, 175, 55, 0.2);';
                
                certCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div>
                            <h3 style="color: #D4AF37; margin-bottom: 0.5rem; font-family: \'Playfair Display\', serif;">Certificado de Autenticidade</h3>
                            <p style="color: rgba(245, 243, 239, 0.7); font-size: 0.875rem;">Código: <strong>${cert.code}</strong></p>
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <p style="margin-bottom: 0.5rem;"><strong>Cliente:</strong> ${cert.customer_name}</p>
                        <p style="margin-bottom: 0.5rem;"><strong>Produto:</strong> ${cert.product_name}${cert.product_brand ? ' - ' + cert.product_brand : ''}</p>
                        <p style="margin-bottom: 0.5rem;"><strong>Venda:</strong> ${cert.sale_number}</p>
                        <p style="margin-bottom: 0.5rem;"><strong>Data de Emissão:</strong> ${new Date(cert.issue_date).toLocaleDateString('pt-BR')}</p>
                    </div>
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="downloadCertificateCompact(${cert.id})">
                            <i class="fas fa-download"></i> Baixar Certificado
                        </button>
                        <button class="btn btn-secondary" onclick="viewCertificateCard(${cert.id})">
                            <i class="fas fa-eye"></i> Ver Digital
                        </button>
                        <button class="btn btn-secondary" onclick="sendCertificateWhatsApp(${cert.id})">
                            <i class="fab fa-whatsapp"></i> Enviar WhatsApp
                        </button>
                    </div>
                `;
                
                listContainer.appendChild(certCard);
            });
            
            openModal('certificate-modal');
        }

        function downloadCertificateCompact(certificateId) {
            const cert = certificates.find(c => c.id === certificateId);
            if (!cert) {
                alert('Certificado não encontrado.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            // Formato compacto premium (A5 landscape - 148mm x 105mm)
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: [148, 105]
            });
            
            // Fundo branco premium
            doc.setFillColor(255, 255, 255);
            doc.rect(0, 0, 148, 105, 'F');
            
            // Marca d'água (fundo) - será adicionada após carregar
            const watermarkUrl = 'https://zpqtcrfygjtjtacufgbv.supabase.co/storage/v1/object/public/logos/LOGO%20MARCA%20D\'AGUA%20(1).png';
            try {
                doc.addImage(watermarkUrl, 'PNG', 20, 20, 108, 65, undefined, 'FAST', 0.03);
            } catch(e) {
                console.log('Marca d\'água não pôde ser carregada no PDF');
            }
            
            // Borda dourada elegante
            doc.setDrawColor(212, 175, 55);
            doc.setLineWidth(1.2);
            doc.rect(8, 8, 132, 89);
            doc.setLineWidth(0.6);
            doc.setDrawColor(184, 138, 68);
            doc.rect(9, 9, 130, 87);
            
            // Título Principal
            doc.setTextColor(43, 43, 43);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('CERTIFICADO DE AUTENTICIDADE', 74, 18, { align: 'center' });
            
            // Linha decorativa
            doc.setDrawColor(212, 175, 55);
            doc.setLineWidth(0.8);
            doc.line(18, 22, 130, 22);
            
            // Texto de Autenticidade
            const authenticityText = `A CJ Empórium certifica que o perfume ${cert.product_name}, da marca ${cert.product_brand || 'N/A'}, adquirido por ${cert.customer_name}, é um produto original, importado e proveniente de fornecedores oficialmente selecionados. Este certificado confirma a autenticidade e procedência do produto, refletindo o compromisso da CJ Empórium com a excelência, a exclusividade e a experiência premium na perfumaria árabe de luxo.`;
            
            doc.setTextColor(43, 43, 43);
            doc.setFontSize(7.5);
            doc.setFont('helvetica', 'italic');
            const splitText = doc.splitTextToSize(authenticityText, 120);
            doc.text(splitText, 74, 30, { align: 'center' });
            
            // Linha separadora
            doc.setDrawColor(212, 175, 55);
            doc.setLineWidth(0.5);
            doc.line(18, 50, 130, 50);
            
            // Dados do Produto - Layout em duas colunas
            let yPos = 56;
            const labelStart = 18; // Início dos labels
            const valueStart = 32; // Início dos valores (alinhado)
            const rightColumnStart = 80; // Início da coluna direita
            
            // CLIENTE (linha completa)
            doc.setFontSize(7);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(212, 175, 55);
            doc.text('CLIENTE:', labelStart, yPos);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(43, 43, 43);
            const customerName = cert.customer_name.length > 48 ? cert.customer_name.substring(0, 48) : cert.customer_name;
            doc.text(customerName, valueStart, yPos);
            
            yPos += 7;
            // PERFUME (esquerda) e MARCA (direita) - mesma linha
            doc.setFontSize(7);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(212, 175, 55);
            doc.text('PERFUME:', labelStart, yPos);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(43, 43, 43);
            const productName = cert.product_name.length > 30 ? cert.product_name.substring(0, 30) : cert.product_name;
            doc.text(productName, valueStart, yPos);
            
            if (cert.product_brand) {
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(212, 175, 55);
                doc.text('MARCA:', rightColumnStart, yPos);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                doc.setTextColor(184, 138, 68);
                const brandName = cert.product_brand.length > 25 ? cert.product_brand.substring(0, 25) : cert.product_brand;
                doc.text(brandName, rightColumnStart + 12, yPos);
            }
            
            const details = [];
            if (cert.product_concentration) details.push(cert.product_concentration);
            if (cert.product_volume) details.push(cert.product_volume);
            if (cert.product_batch) details.push(`Lote: ${cert.product_batch}`);
            
            yPos += 7;
            // TIPO (esquerda) e DATA (direita) - mesma linha
            if (details.length > 0) {
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(212, 175, 55);
                doc.text('TIPO:', labelStart, yPos);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(184, 138, 68);
                const detailsText = details.join(' • ');
                const detailsLines = doc.splitTextToSize(detailsText, 50);
                doc.text(detailsLines, valueStart, yPos);
            }
            
            doc.setFontSize(7);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(212, 175, 55);
            doc.text('DATA:', rightColumnStart, yPos);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(43, 43, 43);
            doc.text(new Date(cert.sale_date).toLocaleDateString('pt-BR'), rightColumnStart + 12, yPos);
            
            // Linha decorativa inferior
            yPos += 6;
            doc.setDrawColor(212, 175, 55);
            doc.setLineWidth(1);
            doc.line(18, yPos, 130, yPos);
            
            // Assinatura (abaixo da linha, no espaço em branco)
            yPos += 5;
            const signatureUrl = 'https://zpqtcrfygjtjtacufgbv.supabase.co/storage/v1/object/public/logos/White%20Minimalist%20Handwritten%20Signature%20Typography%20Logo%20(1).png';
            try {
                doc.addImage(signatureUrl, 'PNG', 40, yPos, 68, 7, undefined, 'FAST');
            } catch(e) {
                doc.setFontSize(9);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(43, 43, 43);
                doc.text('CJ Empórium', 74, yPos + 3, { align: 'center' });
            }
            
            // Haute Parfumarie (mais abaixo, depois da assinatura)
            yPos += 9;
            doc.setFontSize(7);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(184, 138, 68);
            doc.text('Haute Parfumarie', 74, yPos, { align: 'center' });
            
            // Salvar PDF compacto
            doc.save(`Certificado_${cert.code}_Compacto.pdf`);
        }

        function viewCertificateCard(certificateId) {
            const cert = certificates.find(c => c.id === certificateId);
            if (!cert) {
                alert('Certificado não encontrado.');
                return;
            }
            
            const cardModal = document.createElement('div');
            cardModal.id = 'certificate-card-modal';
            cardModal.className = 'modal active';
            cardModal.style.cssText = 'z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);';
            
            const details = [];
            if (cert.product_concentration) details.push(cert.product_concentration);
            if (cert.product_volume) details.push(cert.product_volume);
            if (cert.product_batch) details.push(`Lote: ${cert.product_batch}`);
            
            const authenticityText = `A CJ Empórium certifica que o perfume ${cert.product_name}, da marca ${cert.product_brand || 'N/A'}, adquirido por ${cert.customer_name}, é um produto original, importado e proveniente de fornecedores oficialmente selecionados. Este certificado confirma a autenticidade e procedência do produto, refletindo o compromisso da CJ Empórium com a excelência, a exclusividade e a experiência premium na perfumaria árabe de luxo.`;
            
            cardModal.innerHTML = `
                <div style="max-width: 700px; width: 95%; padding: 0; background: transparent;">
                    <div style="background: #FFFFFF; padding: 3.5rem 3rem; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.12); overflow: hidden; border: 4px solid #D4AF37; border-radius: 0; box-shadow: inset 0 0 0 1px rgba(184, 138, 68, 0.5);">
                        <!-- Borda interna -->
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; border: 1px solid rgba(184, 138, 68, 0.6); pointer-events: none; z-index: 0;"></div>
                        
                        <!-- Marca d'água (fundo quase transparente com tom dourado) -->
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-12deg); width: 70%; height: 70%; pointer-events: none; opacity: 0.03; z-index: 0;">
                            <img src="https://zpqtcrfygjtjtacufgbv.supabase.co/storage/v1/object/public/logos/LOGO%20MARCA%20D'AGUA%20(1).png" alt="Marca d'água" style="width: 100%; height: 100%; object-fit: contain; filter: sepia(100%) saturate(200%) brightness(0.8) hue-rotate(15deg);" />
                        </div>
                        
                        <button onclick="this.closest('.modal').remove()" style="position: absolute; top: 1.25rem; right: 1.25rem; background: rgba(255, 255, 255, 0.98); border: 2px solid rgba(212, 175, 55, 0.4); color: #D4AF37; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; transition: all 0.3s; font-weight: 300; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">×</button>
                        
                        <!-- Header -->
                        <div style="text-align: center; margin-bottom: 2.5rem; position: relative; z-index: 1;">
                            <h1 style="color: #2B2B2B; font-size: 1.5rem; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; margin: 0; font-family: 'Helvetica', 'Arial', sans-serif;">CERTIFICADO DE AUTENTICIDADE</h1>
                        </div>
                        
                        <!-- Texto de Autenticidade -->
                        <div style="margin-bottom: 2.5rem; position: relative; z-index: 1;">
                            <p style="color: #2B2B2B; font-size: 0.9375rem; line-height: 1.9; margin: 0; text-align: center; font-style: normal; font-weight: 400; font-family: 'Helvetica', 'Arial', sans-serif;">${authenticityText}</p>
                        </div>
                        
                        <!-- Linha decorativa -->
                        <div style="height: 1px; background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.3), transparent); margin: 2rem 0; position: relative; z-index: 1;"></div>
                        
                        <!-- Dados do Produto - Layout em duas colunas -->
                        <div style="margin-bottom: 1.5rem; position: relative; z-index: 1;">
                            <!-- Cliente (linha completa) -->
                            <div style="display: flex; align-items: baseline; margin-bottom: 0.75rem;">
                                <div style="width: 90px; flex-shrink: 0;">
                                    <p style="color: #B88A44; font-size: 0.6875rem; font-weight: 600; margin: 0; letter-spacing: 0.1em; text-transform: uppercase;">Cliente:</p>
                                </div>
                                <div style="flex: 1;">
                                    <p style="color: #2B2B2B; font-size: 1rem; font-weight: 600; line-height: 1.3; margin: 0;">${cert.customer_name}</p>
                                </div>
                            </div>
                            
                            <!-- Perfume e Marca (mesma linha) -->
                            <div style="display: flex; align-items: baseline; margin-bottom: 0.75rem; gap: 2rem;">
                                <div style="display: flex; align-items: baseline; flex: 1;">
                                    <div style="width: 90px; flex-shrink: 0;">
                                        <p style="color: #B88A44; font-size: 0.6875rem; font-weight: 600; margin: 0; letter-spacing: 0.1em; text-transform: uppercase;">Perfume:</p>
                                    </div>
                                    <div style="flex: 1;">
                                        <p style="color: #2B2B2B; font-size: 1rem; font-weight: 600; line-height: 1.3; margin: 0;">${cert.product_name}</p>
                                    </div>
                                </div>
                                ${cert.product_brand ? `
                                <div style="display: flex; align-items: baseline; flex: 1;">
                                    <div style="width: 60px; flex-shrink: 0;">
                                        <p style="color: #B88A44; font-size: 0.6875rem; font-weight: 600; margin: 0; letter-spacing: 0.1em; text-transform: uppercase;">Marca:</p>
                                    </div>
                                    <div style="flex: 1;">
                                        <p style="color: #D4AF37; font-size: 0.9375rem; font-weight: 500; margin: 0;">${cert.product_brand}</p>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- Tipo e Data (mesma linha) -->
                            <div style="display: flex; align-items: baseline; margin-bottom: 0; gap: 2rem;">
                                ${details.length > 0 ? `
                                <div style="display: flex; align-items: baseline; flex: 1;">
                                    <div style="width: 90px; flex-shrink: 0;">
                                        <p style="color: #B88A44; font-size: 0.6875rem; font-weight: 600; margin: 0; letter-spacing: 0.1em; text-transform: uppercase;">Tipo:</p>
                                    </div>
                                    <div style="flex: 1;">
                                        <p style="color: rgba(43, 43, 43, 0.75); font-size: 0.875rem; margin: 0; font-weight: 400;">${details.join(' • ')}</p>
                                    </div>
                                </div>
                                ` : '<div style="flex: 1;"></div>'}
                                <div style="display: flex; align-items: baseline; flex: 1;">
                                    <div style="width: 60px; flex-shrink: 0;">
                                        <p style="color: #B88A44; font-size: 0.6875rem; font-weight: 600; margin: 0; letter-spacing: 0.1em; text-transform: uppercase;">Data:</p>
                                    </div>
                                    <div style="flex: 1;">
                                        <p style="color: #2B2B2B; font-size: 1rem; font-weight: 600; margin: 0;">${new Date(cert.sale_date).toLocaleDateString('pt-BR')}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Linha decorativa (antes da assinatura) -->
                        <div style="height: 1px; background: linear-gradient(90deg, transparent, #D4AF37 20%, #D4AF37 80%, transparent); margin: 1.5rem 0 0 0; position: relative; z-index: 1;"></div>
                        
                        <!-- Assinatura (abaixo da linha, no espaço em branco) -->
                        <div style="text-align: center; margin-top: 1rem; position: relative; z-index: 2;">
                            <img src="https://zpqtcrfygjtjtacufgbv.supabase.co/storage/v1/object/public/logos/White%20Minimalist%20Handwritten%20Signature%20Typography%20Logo%20(1).png" alt="Assinatura CJ Empórium" style="max-width: 140px; height: auto; margin: 0 auto; display: block; filter: brightness(0);" />
                        </div>
                        
                        <!-- Haute Parfumarie (mais abaixo, depois da assinatura) -->
                        <div style="text-align: center; margin-top: 1rem; position: relative; z-index: 2;">
                            <p style="color: rgba(184, 138, 68, 0.9); font-size: 0.7rem; letter-spacing: 0.1em; margin: 0; font-weight: 400; text-transform: uppercase;">Haute Parfumarie</p>
                        </div>
                        
                        <!-- Ações -->
                        <div style="display: flex; gap: 1rem; margin-top: 2.5rem; position: relative; z-index: 1;">
                            <button class="btn btn-primary" onclick="downloadCertificateCompact(${cert.id}); this.closest('.modal').remove();" style="flex: 1; padding: 1rem; font-size: 0.9375rem; font-weight: 600; border-radius: 8px;">
                                <i class="fas fa-download"></i> Baixar PDF
                            </button>
                            <button class="btn btn-secondary" onclick="sendCertificateWhatsApp(${cert.id}); this.closest('.modal').remove();" style="flex: 1; padding: 1rem; font-size: 0.9375rem; font-weight: 600; border-radius: 8px;">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(cardModal);
            
            cardModal.addEventListener('click', (e) => {
                if (e.target === cardModal) cardModal.remove();
            });
        }

        function downloadCertificate(certificateId) {
            const cert = certificates.find(c => c.id === certificateId);
            if (!cert) {
                alert('Certificado não encontrado.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            // Fundo escuro (simulado com retângulo)
            doc.setFillColor(15, 15, 15);
            doc.rect(0, 0, 210, 297, 'F');
            
            // Título
            doc.setTextColor(212, 175, 55);
            doc.setFontSize(28);
            doc.setFont('helvetica', 'bold');
            doc.text('CERTIFICADO DE AUTENTICIDADE', 105, 40, { align: 'center' });
            
            // Linha decorativa
            doc.setDrawColor(212, 175, 55);
            doc.setLineWidth(0.5);
            doc.line(30, 50, 180, 50);
            
            // Texto do certificado
            doc.setTextColor(245, 243, 239);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            
            const text = `A CJ Empórium certifica que o perfume ${cert.product_name}, da marca ${cert.product_brand || 'N/A'}, adquirido por ${cert.customer_name}, é um produto original, importado e proveniente de fornecedores oficialmente selecionados.

Este certificado confirma a autenticidade e procedência do produto, refletindo o compromisso da CJ Empórium com a excelência, a exclusividade e a experiência premium na perfumaria árabe de luxo.`;
            
            const splitText = doc.splitTextToSize(text, 150);
            doc.text(splitText, 105, 70, { align: 'center', maxWidth: 150 });
            
            // Dados do produto
            let yPos = 120;
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(212, 175, 55);
            doc.text('DADOS DO PRODUTO', 30, yPos);
            
            yPos += 8;
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(245, 243, 239);
            doc.text(`Nome: ${cert.product_name}`, 30, yPos);
            yPos += 7;
            if (cert.product_brand) {
                doc.text(`Marca: ${cert.product_brand}`, 30, yPos);
                yPos += 7;
            }
            if (cert.product_concentration) {
                doc.text(`Concentração: ${cert.product_concentration}`, 30, yPos);
                yPos += 7;
            }
            if (cert.product_volume) {
                doc.text(`Volume: ${cert.product_volume}`, 30, yPos);
                yPos += 7;
            }
            if (cert.product_batch) {
                doc.text(`Lote: ${cert.product_batch}`, 30, yPos);
                yPos += 7;
            }
            if (cert.product_origin) {
                doc.text(`Origem: ${cert.product_origin}`, 30, yPos);
                yPos += 7;
            }
            
            // Dados do cliente
            yPos += 5;
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(212, 175, 55);
            doc.text('DADOS DO CLIENTE', 30, yPos);
            
            yPos += 8;
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(245, 243, 239);
            doc.text(`Nome: ${cert.customer_name}`, 30, yPos);
            yPos += 7;
            doc.text(`Código: ${cert.customer_code}`, 30, yPos);
            
            // Dados da venda
            yPos += 10;
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(212, 175, 55);
            doc.text('DADOS DA VENDA', 30, yPos);
            
            yPos += 8;
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(245, 243, 239);
            doc.text(`Número: ${cert.sale_number}`, 30, yPos);
            yPos += 7;
            doc.text(`Data: ${new Date(cert.sale_date).toLocaleDateString('pt-BR')}`, 30, yPos);
            
            // Assinatura
            yPos = 250;
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(212, 175, 55);
            doc.text('CJ Empórium – Haute Parfumarie', 105, yPos, { align: 'center' });
            
            // Código do certificado
            yPos += 15;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(184, 138, 68);
            doc.text(`Código do Certificado: ${cert.code}`, 105, yPos, { align: 'center' });
            
            // Data de emissão
            yPos += 7;
            doc.text(`Data de Emissão: ${new Date(cert.issue_date).toLocaleDateString('pt-BR')}`, 105, yPos, { align: 'center' });
            
            // Salvar PDF
            doc.save(`Certificado_${cert.code}.pdf`);
        }

        function sendCertificateWhatsApp(certificateId) {
            const cert = certificates.find(c => c.id === certificateId);
            if (!cert) {
                alert('Certificado não encontrado.');
                return;
            }
            
            const customer = customers.find(c => c.id === cert.customer_id);
            if (!customer || !customer.phone) {
                alert('Cliente não encontrado ou sem telefone cadastrado.');
                return;
            }
            
            const message = encodeURIComponent(
                `Olá ${customer.name}! Segue o Certificado de Autenticidade do seu perfume ${cert.product_name}.\n\n` +
                `Código: ${cert.code}\n` +
                `Venda: ${cert.sale_number}\n\n` +
                `Obrigado por confiar na CJ Empórium!`
            );
            
            const phone = customer.phone.replace(/\D/g, '');
            window.open(`https://wa.me/55${phone}?text=${message}`, '_blank');
        }

        window.viewCertificates = viewCertificates;
        window.downloadCertificateCompact = downloadCertificateCompact;
        window.viewCertificateCard = viewCertificateCard;
        window.sendCertificateWhatsApp = sendCertificateWhatsApp;
    </script>
</body>
</html>
